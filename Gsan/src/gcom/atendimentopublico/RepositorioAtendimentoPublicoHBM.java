/* * Copyright (C) 2007-2007 the GSAN - Sistema Integrado de Gestão de Serviços de * Saneamento This file is part of GSAN, an integrated service management system * for Sanitation GSAN is free software; you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by the Free * Software Foundation; either version 2 of the License. GSAN is distributed in * the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the * implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See * the GNU General Public License for more details. You should have received a * copy of the GNU General Public License along with this program; if not, write * to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, * MA 02111-1307, USA *//* * GSAN - Sistema Integrado de Gestão de Serviços de Saneamento Copyright (C) * <2007> Adriano Britto Siqueira Alexandre Santos Cabral Ana Carolina Alves * Breda Ana Maria Andrade Cavalcante Aryed Lins de Araújo Bruno Leonardo * Rodrigues Barros Carlos Elmano Rodrigues Ferreira Cláudio de Andrade Lira * Denys Guimarães Guenes Tavares Eduardo Breckenfeld da Rosa Borges Fabíola * Gomes de Araújo Flávio Leonardo Cavalcanti Cordeiro Francisco do Nascimento * Júnior Homero Sampaio Cavalcanti Ivan Sérgio da Silva Júnior José Edmar de * Siqueira José Thiago Tenório Lopes Kássia Regina Silvestre de Albuquerque * Leonardo Luiz Vieira da Silva Márcio Roberto Batista da Silva Maria de Fátima * Sampaio Leite Micaela Maria Coelho de Araújo Nelson Mendonça de Carvalho * Newton Morais e Silva Pedro Alexandre Santos da Silva Filho Rafael Corrêa * Lima e Silva Rafael Francisco Pinto Rafael Koury Monteiro Rafael Palermo de * Araújo Raphael Veras Rossiter Roberto Sobreira Barbalho Rodrigo Avellar * Silveira Rosana Carvalho Barbosa Sávio Luiz de Andrade Cavalcante Tai Mu Shih * Thiago Augusto Souza do Nascimento Tiago Moreno Rodrigues Vivianne Barbosa * Sousa Este programa é software livre; você pode redistribuí-lo e/ou * modificá-lo sob os termos de Licença Pública Geral GNU, conforme publicada * pela Free Software Foundation; versão 2 da Licença. Este programa é * distribuído na expectativa de ser útil, mas SEM QUALQUER GARANTIA; sem mesmo * a garantia implícita de COMERCIALIZAÇÃO ou de ADEQUAÇÃO A QUALQUER PROPÓSITO * EM PARTICULAR. Consulte a Licença Pública Geral GNU para obter mais detalhes. * Você deve ter recebido uma cópia da Licença Pública Geral GNU junto com este * programa; se não, escreva para Free Software Foundation, Inc., 59 Temple * Place, Suite 330, Boston, MA 02111-1307, USA. */package gcom.atendimentopublico;import gcom.atendimentopublico.bean.OcorrenciaOperacionalFiltroHelper;import gcom.atendimentopublico.ligacaoagua.LigacaoAgua;import gcom.atendimentopublico.ligacaoagua.LigacaoAguaSituacao;import gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoClienteFoneVisitaCampo;import gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoClienteVisitaCampo;import gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoVisitaCampo;import gcom.atendimentopublico.ordemservico.ClieFoneSeletivaVisitaCampo;import gcom.atendimentopublico.ordemservico.ClieOsSeletivaVisitaCampo;import gcom.atendimentopublico.ordemservico.FiscalizacaoSituacao;import gcom.atendimentopublico.ordemservico.FiscalizacaoSituacaoServicoACobrar;import gcom.atendimentopublico.ordemservico.OrdemServico;import gcom.atendimentopublico.ordemservico.OrdemServicoProgramacao;import gcom.atendimentopublico.ordemservico.OsReferidaRetornoTipo;import gcom.atendimentopublico.ordemservico.ServicoCobrancaValor;import gcom.atendimentopublico.ordemservico.ServicoTipo;import gcom.atendimentopublico.ordemservico.bean.ObterValorDebitoHelper;import gcom.atendimentopublico.registroatendimento.RegistroAtendimento;import gcom.cadastro.cliente.Cliente;import gcom.cadastro.cliente.ClienteImovel;import gcom.cadastro.cliente.ClienteRelacaoTipo;import gcom.cadastro.cliente.OrgaoExpedidorRg;import gcom.cadastro.geografico.UnidadeFederacao;import gcom.cadastro.imovel.Imovel;import gcom.cadastro.imovel.ImovelSuprimido;import gcom.cadastro.localidade.GerenciaRegional;import gcom.cadastro.localidade.UnidadeNegocio;import gcom.cobranca.CobrancaAcaoAtividadeComandoFiscalizacaoSituacao;import gcom.faturamento.autoinfracao.AutosInfracao;import gcom.faturamento.debito.DebitoTipo;import gcom.gui.atendimentopublico.registroatendimento.FiltrarAcompanhamentoRegistroAtendimentoHelper;import gcom.gui.relatorio.atendimentopublico.FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper;import gcom.gui.relatorio.atendimentopublico.FiltrarRelatorioDebitosCobrancaImovelHelper;import gcom.gui.relatorio.atendimentopublico.FiltrarRelatorioOSSituacaoHelper;import gcom.gui.relatorio.atendimentopublico.FiltrarRelatorioTiposServicoHelper;import gcom.micromedicao.SituacaoTransmissaoLeitura;import gcom.micromedicao.hidrometro.HidrometroCapacidade;import gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico;import gcom.micromedicao.hidrometro.HidrometroSituacao;import gcom.relatorio.atendimentopublico.ordemservico.FiltrarRelatorioReligacaoClientesInadiplentesHelper;import gcom.util.CollectionUtil;import gcom.util.ConstantesSistema;import gcom.util.ControladorException;import gcom.util.ErroRepositorioException;import gcom.util.HibernateUtil;import gcom.util.Util;import java.math.BigDecimal;import java.sql.Connection;import java.sql.PreparedStatement;import java.sql.SQLException;import java.sql.Statement;import java.util.ArrayList;import java.util.Collection;import java.util.Date;import java.util.HashMap;import java.util.HashSet;import java.util.Iterator;import java.util.List;import java.util.Map;import java.util.Set;import org.hibernate.Criteria;import org.hibernate.FetchMode;import org.hibernate.Hibernate;import org.hibernate.HibernateException;import org.hibernate.Query;import org.hibernate.SQLQuery;import org.hibernate.Session;import org.hibernate.criterion.Restrictions;/** * < <Descrição da Classe>> *  * @author Administrador */public class RepositorioAtendimentoPublicoHBM implements        IRepositorioAtendimentoPublico {    private static IRepositorioAtendimentoPublico instancia;    /**     * Construtor da classe RepositorioMicromedicaoHBM     */    private RepositorioAtendimentoPublicoHBM() {    }    /**     * Retorna o valor de instancia     *      * @return O valor de instancia     */    public static IRepositorioAtendimentoPublico getInstancia() {        if (instancia == null) {            instancia = new RepositorioAtendimentoPublicoHBM();        }        return instancia;    }    /**     * [UC-0355] - Efetuar Corte de Ligaçã de Àgua [SB001] Atualizar Ligação -     * (corte de ligação de água) Água- os campos LAGU_DTCORTE e     * LAGU_NNSELOCORTE e LAGU_ TMULTIMAALTERACAO     *      * @param imovel     *            Descrição do parâmetro     * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Leandro Cavalcanti     * @date 10/07/2006     * @param imovel     * @param idLigacaoAguaSituacao     * @throws ErroRepositorioException     */    public void atualizarLigacaoAgua(Integer idImovel,            Integer idLigacaoAguaSituacao, Integer numeroSeloCorte)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update;        try {            // Atualizar os campos LAST_ID, LAGU_DTCORTE, LAGU_NNSELOCORTE e            // LAGU_ TMULTIMAALTERACAO            update = "update gcom.atendimentopublico.ligacaoagua.LigacaoAgua set "                    + "lagu_id = :idligacaoAgua ,"                    + "lagu_dtcorte = :dataExecOrdServico, "                    + "lagu_nnselocorte = :numeroSeloCorte, "                    + "lagu_tmultimaalteracao = :datahoracorrente "                    + "where lagu_id = :imovelId";            session.createQuery(update).setInteger("idligacaoAgua",                    idLigacaoAguaSituacao.intValue()).setDate(                    "dataExecOrdServico", new Date()).setInteger(                    "numeroSeloCorte", numeroSeloCorte.intValue()).setInteger(                    "imovelId", idImovel.intValue()).setDate(                    "datahoracorrente", new Date()).executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);            // session.close();        }    }    /**     * [UC-0355] - Efetuar Corte de Ligaçã de Àgua [SB001] Atualizar Hidrometro -     * (corte de ligação de água) Atualizar os campos hidi_nnleituracorte e     * hidi_tmultimaalteracao de HidrometroInstalacaoHistorico     *      * @param imovel     *            Descrição do parâmetro     * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Leandro Cavalcanti     * @date 10/07/2006     * @param imovel     * @param idLigacaoAguaSituacao     * @throws ErroRepositorioException     */    public void atualizarHidrometroLIgacaoAgua(Integer imovelId,            Integer numeroLeituraCorte) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update;        try {            update = "update gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico set "                    + "hidi_nnleituracorte = :numCorte, hidi_tmultimaalteracao = :datahoracorrente "                    + "where imov_id = :imovelId";            session.createQuery(update).setInteger("numCorte",                    numeroLeituraCorte.intValue()).setInteger("imovelId",                    imovelId.intValue())                    .setDate("datahoracorrente", new Date()).executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);            // session.close();        }    }    /**     * [UC-0362] - Efetuar Instalação de Hidrômetro [SB002] Atualizar Ligação de     * Água Atualizar os campos hidi_id e lagu_tmultimaalteracao de LigacaoAgua     *      * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Ana Maria     * @date 13/07/2006     * @param idLigacaoAgua     * @param idHidrometroInstalacaoHistorico     * @throws ErroRepositorioException     */    public void atualizarHidrometroInstalacaoHistoricoLigacaoAgua(            Integer idLigacaoAgua, Integer idHidrometroInstalacaoHistorico)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update = null;        try {            if (idHidrometroInstalacaoHistorico != null                    && !idHidrometroInstalacaoHistorico.equals("")) {                update = "update gcom.atendimentopublico.ligacaoagua.LigacaoAgua set "                        + "hidi_id = :idHidrometroInstalacaoHistorico, lagu_tmultimaalteracao = :datahoracorrente "                        + "where lagu_id = :idLigacaoAgua";                session.createQuery(update).setInteger(                        "idHidrometroInstalacaoHistorico",                        idHidrometroInstalacaoHistorico.intValue())                        .setTimestamp("datahoracorrente", new Date())                        .setInteger("idLigacaoAgua", idLigacaoAgua.intValue())                        .executeUpdate();            } else {                update = "update gcom.atendimentopublico.ligacaoagua.LigacaoAgua set "                        + "hidi_id = null, lagu_tmultimaalteracao = :datahoracorrente "                        + "where lagu_id = :idLigacaoAgua";                session.createQuery(update).setTimestamp("datahoracorrente",                        new Date()).setInteger("idLigacaoAgua",                        idLigacaoAgua.intValue()).executeUpdate();            }        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC-0362] - Efetuar Instalação de Hidrômetro [SB002] Atualizar Imóvel     * Atualizar os campos hidi_id e imov_tmultimaalteracao de Imovel     *      * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Ana Maria     * @date 13/07/2006     * @param idImovel     * @param idHidrometroInstalacaoHistorico     * @throws ErroRepositorioException     */    public void atualizarHidrometroIntalacaoHistoricoImovel(Integer idImovel,            Integer idHidrometroInstalacaoHistorico, Integer idPocoTipo)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update = null;        try {            if (idHidrometroInstalacaoHistorico != null                    && !idHidrometroInstalacaoHistorico.equals("")) {            	            	            	if ( idPocoTipo != null ) {             		            		                update = "update gcom.cadastro.imovel.Imovel set "	                        + "hidi_id = :idHidrometroInstalacaoHistorico, imov_tmultimaalteracao = :datahoracorrente, poco_id = :idPocoTipo "	                        + "where imov_id = :idImovel";	                session.createQuery(update).setInteger(	                        "idHidrometroInstalacaoHistorico",	                        idHidrometroInstalacaoHistorico.intValue())	                        .setTimestamp("datahoracorrente", new Date())	                        .setInteger("idImovel", idImovel.intValue())	                        .setInteger("idPocoTipo", idPocoTipo)	                        .executeUpdate();            	} else {                    update = "update gcom.cadastro.imovel.Imovel set "                            + "hidi_id = :idHidrometroInstalacaoHistorico, imov_tmultimaalteracao = :datahoracorrente, poco_id = null "                            + "where imov_id = :idImovel";                    session.createQuery(update).setInteger(                            "idHidrometroInstalacaoHistorico",                            idHidrometroInstalacaoHistorico.intValue())                            .setTimestamp("datahoracorrente", new Date())                            .setInteger("idImovel", idImovel.intValue())                            .executeUpdate();            	}            } else {                update = "update gcom.cadastro.imovel.Imovel set "                        + "hidi_id = null, imov_tmultimaalteracao = :datahoracorrente, poco_id = null "                        + "where imov_id = :idImovel";                session.createQuery(update).setTimestamp("datahoracorrente",                        new Date()).setInteger("idImovel", idImovel.intValue())                        .executeUpdate();            }        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC-0362] - Efetuar Instalação de Hidrômetro [SB003] Atualizar Hidrômetro     * Atualizar o campo hisi_id     *      * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Ana Maria     * @date 17/07/2006     * @throws ErroRepositorioException     */    public void atualizarSituacaoHidrometro(Integer idHidrometro,            Integer situacaoHidrometro) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update = null;        try {            update = "update gcom.micromedicao.hidrometro.Hidrometro set "                    + "hist_id = :idSituacaoHidrometro, hidr_tmultimaalteracao = :datahoracorrente "                    + "where hidr_id = :numeroHidrometro";            session.createQuery(update).setInteger("idSituacaoHidrometro",                    situacaoHidrometro).setTimestamp("datahoracorrente",                    new Date()).setInteger("numeroHidrometro",                    idHidrometro.intValue()).executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC-0362] - Efetuar Instalação de Hidrômetro [SB003] Atualizar Hidrômetro     * Atualizar o campo hisi_id     *      * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Ana Maria     * @date 17/07/2006     * @throws ErroRepositorioException     */    public void atualizarLocalArmazanagemHidrometro(Integer idHidrometro,            Integer localArmazanagemHidrometro) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update = null;        try {            update = "update gcom.micromedicao.hidrometro.Hidrometro set "                    + "hila_id = :localArmazanagemHidrometro "                    + "where hidr_id = :numeroHidrometro";            session.createQuery(update).setInteger(                    "localArmazanagemHidrometro", localArmazanagemHidrometro)                    .setInteger("numeroHidrometro", idHidrometro.intValue())                    .executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * Substituicao de hidrometro     */    public void atualizarSubstituicaoHidrometroInstalacoHistorico(            HidrometroInstalacaoHistorico hidrometroSubstituicaoHistorico)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        try {            if (hidrometroSubstituicaoHistorico.getNumeroLeituraRetirada() != null) {                String sql = "update gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico "                        + "set hidi_dtretiradahidrometro = :dataRetirada "                        + ", hidi_nnleituraretiradahidrometro = :numeroLeituraRetirada "                        + ", hidi_tmultimaalteracao = :data "                        + ", hidi_icinstalacaosubstituicao =:indicadorSubstituicao"                        + " where hidi_id = :id ";                session.createQuery(sql).setDate("dataRetirada",                        hidrometroSubstituicaoHistorico.getDataRetirada())                        .setInteger(                                "numeroLeituraRetirada",                                hidrometroSubstituicaoHistorico                                        .getNumeroLeituraRetirada())                        .setTimestamp("data", new Date()).setInteger("id",                                hidrometroSubstituicaoHistorico.getId())                        .setShort("indicadorSubstituicao", new Short("2"))                        .executeUpdate();            } else {                String sql = "update gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico "                        + "set hidi_dtretiradahidrometro = :dataRetirada "                        + ", hidi_tmultimaalteracao = :data "                        + ", hidi_icinstalacaosubstituicao =:indicadorSubstituicao"                        + " where hidi_id = :id ";                session.createQuery(sql).setDate("dataRetirada",                        hidrometroSubstituicaoHistorico.getDataRetirada())                        .setTimestamp("data", new Date()).setInteger("id",                                hidrometroSubstituicaoHistorico.getId())                        .setShort("indicadorSubstituicao", new Short("2"))                        .executeUpdate();            }        } catch (HibernateException e) {            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC-0362] - Efetuar Instalação de Hidrômetro [SB003] Atualizar Hidrômetro     * Atualizar o campo hisi_id     *      * @exception ErroRepositorioExceptions     *                Descrição da exceção     * @author Ana Maria     * @date 17/07/2006     * @throws ErroRepositorioException     */    public void atualizarHidrometroInstalacoHistorico(            HidrometroInstalacaoHistorico hidrometroSubstituicaoHistorico)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        try {            if (hidrometroSubstituicaoHistorico.getNumeroLeituraRetirada() != null) {                String sql = "update gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico "                        + "set hidi_dtretiradahidrometro = :dataRetirada "                        + ", hidi_nnleitretiradahidmt = :numeroLeituraRetirada "                        + ", hidi_tmultimaalteracao = :data "                        + ", usur_idretirada = :idUsuarioRetirada "                        + "where hidi_id = :id ";                session.createQuery(sql).setDate("dataRetirada",                        hidrometroSubstituicaoHistorico.getDataRetirada())                        .setInteger(                                "numeroLeituraRetirada",                                hidrometroSubstituicaoHistorico                                        .getNumeroLeituraRetirada())                        .setTimestamp("data", new Date()).setInteger("id",                                hidrometroSubstituicaoHistorico.getId())                        .setInteger("idUsuarioRetirada", hidrometroSubstituicaoHistorico.                        		getUsuarioRetirada().getId())                        .executeUpdate();            } else {                String sql = "update gcom.micromedicao.hidrometro.HidrometroInstalacaoHistorico "                        + "set hidi_dtretiradahidrometro = :dataRetirada "                        + ", hidi_tmultimaalteracao = :data "                        + "where hidi_id = :id ";                session.createQuery(sql).setDate("dataRetirada",                        hidrometroSubstituicaoHistorico.getDataRetirada())                        .setTimestamp("data", new Date()).setInteger("id",                                hidrometroSubstituicaoHistorico.getId())                        .executeUpdate();            }        } catch (HibernateException e) {            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC0396] - Inserir Tipo de retorno da OS Referida [FS0005] Validar     * indicador de deferimento     *      * @author lms     * @date 31/07/2006     * @throws ErroRepositorioException     */    public int consultarTotalIndicadorDeferimentoAtivoPorServicoTipoReferencia(            OsReferidaRetornoTipo osReferidaRetornoTipo)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String select = null;        try {            select = "select count(*) from gcom.atendimentopublico.ordemservico.OsReferidaRetornoTipo o where "                    + "o.indicadorDeferimento = "                    + ConstantesSistema.INDICADOR_USO_ATIVO                    + " and "                    + "o.indicadorUso = "                    + ConstantesSistema.INDICADOR_USO_ATIVO                    + " and "                    + "o.servicoTipoReferencia.id = :idServicoTipoReferencia";            return ((Integer) session.createQuery(select).setInteger(                    "idServicoTipoReferencia",                    osReferidaRetornoTipo.getServicoTipoReferencia().getId())                    .uniqueResult()).intValue();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC0463] Atualizar Consumo Mínimo da Ligação de Água     *      * @author Leonardo Regis     * @date 30/08/2006     * @param ligacaoAgua     * @exception ErroRepositorioExceptions     */    public void atualizarConsumoMinimoLigacaoAgua(LigacaoAgua ligacaoAgua)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update;        try {            update = "update LigacaoAgua set "                    + "numeroConsumoMinimoAgua = :consumoMinimo, "                    + "ultimaAlteracao = :dataCorrente "                    + "where id = :ligacaoAguaId";            session.createQuery(update).setInteger("consumoMinimo",                    ligacaoAgua.getNumeroConsumoMinimoAgua()).setTimestamp(                    "dataCorrente", ligacaoAgua.getUltimaAlteracao())                    .setInteger("ligacaoAguaId", ligacaoAgua.getId())                    .executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }    }    /**     * [UC0475] Obter Valor do Débito Verificar existência de hidrômetro na     * ligação de água.     *      * @author Leonardo Regis     * @date 09/09/2006     * @param imovelId     * @return existencia de hidrometro ou não     * @throws ErroRepositorioException     */    public boolean verificarExistenciaHidrometroEmLigacaoAgua(Integer imovelId)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        boolean retorno = false;        Collection<HidrometroInstalacaoHistorico> retornoConsulta = new ArrayList();        try {            consulta = "SELECT la.hidrometroInstalacaoHistorico "                    + "FROM LigacaoAgua la " + "where la.id = :imovelId";            retornoConsulta = (Collection<HidrometroInstalacaoHistorico>) session                    .createQuery(consulta).setInteger("imovelId", imovelId)                    .list();            if (retornoConsulta != null && !retornoConsulta.isEmpty()) {                retorno = true;            }        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * [UC0475] Obter Valor do Débito Verificar existência de hidrômetro no     * imóvel.     *      * @author Leonardo Regis     * @date 09/09/2006     * @param imovelId     * @return existencia de hidrometro ou não     * @throws ErroRepositorioException     */    public boolean verificarExistenciaHidrometroEmImovel(Integer imovelId)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        boolean retorno = false;        Collection<HidrometroInstalacaoHistorico> retornoConsulta = new ArrayList();        try {            consulta = "SELECT i.hidrometroInstalacaoHistorico "                    + "FROM Imovel i " + "where i.id = :imovelId";            retornoConsulta = (Collection<HidrometroInstalacaoHistorico>) session                    .createQuery(consulta).setInteger("imovelId", imovelId)                    .list();            if (retornoConsulta != null && !retornoConsulta.isEmpty()) {                retorno = true;            }        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * [UC0475] Obter Valor do Débito Obter Capacidade de Hidrômetro pela     * Ligação de Água.     *      * @author Leonardo Regis     * @date 09/09/2006     * @param imovelId     * @return existencia de hidrometro ou não     * @throws ErroRepositorioException     */    public HidrometroCapacidade obterHidrometroCapacidadeEmLigacaoAgua(            Integer imovelId) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        HidrometroCapacidade retornoConsulta = null;        try {            consulta = "SELECT h.hidrometroCapacidade "                    + "FROM LigacaoAgua la "                    + "INNER JOIN la.hidrometroInstalacaoHistorico hih "                    + "INNER JOIN hih.hidrometro h "                    + "INNER JOIN h.hidrometroCapacidade hc "                    + "where la.id = :imovelId";            retornoConsulta = (HidrometroCapacidade) session.createQuery(                    consulta).setInteger("imovelId", imovelId).setMaxResults(1)                    .uniqueResult();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }    /**     * [UC0475] Obter Valor do Débito Obter Capacidade de Hidrômetro pelo     * Imóvel.     *      * @author Leonardo Regis     * @date 09/09/2006     * @param imovelId     * @return existencia de hidrometro ou não     * @throws ErroRepositorioException     */    public HidrometroCapacidade obterHidrometroCapacidadeEmImovel(            Integer imovelId) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        HidrometroCapacidade retornoConsulta = null;        try {            consulta = "SELECT h.hidrometroCapacidade " + "FROM Imovel i "                    + "INNER JOIN i.hidrometroInstalacaoHistorico hih "                    + "INNER JOIN hih.hidrometro h "                    + "INNER JOIN h.hidrometroCapacidade hc "                    + "where i.id = :imovelId";            retornoConsulta = (HidrometroCapacidade) session.createQuery(                    consulta).setInteger("imovelId", imovelId).setMaxResults(1)                    .uniqueResult();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }    /**     * [UC0475] Obter Valor do Débito Obter Valor do Debito pelos parâmtros     * passados.     *     * @author Leonardo Regis     * @date 09/09/2006     * @param obterValorDebitoHelper     * @return o valor do débito     * @throws ErroRepositorioException     */     public BigDecimal obterValorDebito(ObterValorDebitoHelper params)     	throws ErroRepositorioException { 	    Session session = HibernateUtil.getSession(); 	    String consulta; 	    BigDecimal retornoConsulta = null; 	 	    try { 	    	consulta = "SELECT scv.valor" 			    +" FROM ServicoCobrancaValor scv" 			    +" where scv.servicoTipo.id = :servicoTipoId" 			    +" and scv.dataVigenciaInicial <= :dataAtual" 			    +" and scv.dataVigenciaFinal >= :dataAtual" 			    +" and scv.indicadorMedido = :indicadorMedido AND (" 			    +" (scv.imovelPerfil.id = :imovelPerfilid OR scv.imovelPerfil.id is null) AND" 			    +" (scv.hidrometroCapacidade = :hidrometroCapacidade" 			    +" OR scv.hidrometroCapacidade is null) AND" 			    +" (scv.categoria = :categoria OR scv.categoria is null) AND" 			    +" (scv.subCategoria = :subCategoria OR scv.subCategoria is null) AND" 			    +" (scv.quantidadeEconomiasInicial <= :quantidadeEconomias" 			    +" OR scv.quantidadeEconomiasInicial is null) AND" 			    +" (scv.quantidadeEconomiasFinal >= :quantidadeEconomias OR scv.quantidadeEconomiasFinal is null))" 			    +" ORDER BY scv.imovelPerfil,scv.hidrometroCapacidade,scv.categoria,scv.subCategoria"; 	 		    retornoConsulta = (BigDecimal) session.createQuery(consulta) 		    	.setInteger("servicoTipoId",params.getServicoTipo().getId()) 		    	.setDate("dataAtual",new Date()) 		    	.setShort("indicadorMedido", params.getSituacaoMedicao()) 		    	.setInteger("imovelPerfilid", params.getImovelPerfil()!=null? 		    			params.getImovelPerfil().getId():0) 		    	.setInteger("hidrometroCapacidade", params.getHidrometroCapacidade()!=null? 		    			params.getHidrometroCapacidade().getId():0) 		        .setInteger("categoria", params.getCategoria()!=null? 		        		params.getCategoria().getId():0) 		        .setInteger("subCategoria", params.getSubcategoria()!=null? 		        		params.getSubcategoria().getId():0) 		        .setInteger("quantidadeEconomias", params.getQuantidadeEconomia()!=null? 		        		params.getQuantidadeEconomia():0) 		        .setMaxResults(1).uniqueResult(); 	     		    if(retornoConsulta == null) { 		    	 		    	consulta = "SELECT scv.valor " + "FROM ServicoCobrancaValor scv " 		    			+ "where scv.servicoTipo.id = :servicoTipoId order by scv.ultimaAlteracao desc"; 		 		    	retornoConsulta = (BigDecimal) session 		    		.createQuery(consulta) 		    		.setInteger("servicoTipoId",params.getServicoTipo().getId()) 		    		.setMaxResults(1).uniqueResult(); 		    } 		     		    if(retornoConsulta == null) { 	 		    	consulta = "SELECT st.valor " + "FROM ServicoTipo st " 	    			+ "where st.id = :servicoTipoId "; 	 		    	retornoConsulta = (BigDecimal) session 	    			.createQuery(consulta) 	    			.setInteger("servicoTipoId",params.getServicoTipo().getId()) 	    			.setMaxResults(1).uniqueResult(); 		    }	     } catch (HibernateException e) {	     	e.printStackTrace();	     		throw new ErroRepositorioException("Erro no Hibernate");	     } finally {	     	HibernateUtil.closeSession(session);	     }	     	return retornoConsulta;	 }    /**     * Método que retorna o número do hidrômetro da ligação de água     *      * @author Ana Maria     * @date 12/09/2006     * @param idImovel     * @return     * @throws ControladorException     */    public String pesquisarNumeroHidrometroLigacaoAgua(Integer idLigacaoAgua)            throws ErroRepositorioException {        String retorno = "";        Session session = HibernateUtil.getSession();        String consulta;        try {            consulta = " select hidr.numero" + " from LigacaoAgua lagu"                    + " inner join lagu.hidrometroInstalacaoHistorico hidi"                    + " inner join hidi.hidrometro hidr"                    + " where lagu.id = :idLigacaoAgua";            retorno = (String) session.createQuery(consulta).setInteger(                    "idLigacaoAgua", idLigacaoAgua).setMaxResults(1)                    .uniqueResult();        } catch (HibernateException e) {            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * Método que retorna o tipo da ligação de água, a data do corte da ligação     * de água e a data da Religação     *      * @author Ana Maria, Raphael Rossiter     * @date 18/08/2006, 03/01/2008     * @param idLigacaoAgua     * @throws ErroRepositorioException     */    public Object[] pesquisarDadosLigacaoAgua(Integer idLigacaoAgua)            throws ErroRepositorioException {        Object[] retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "select lagu.corteTipo.id, lagu.dataCorteAdministrativo, lagu.dataReligacao,"                    + " lagu.dataCorte, lagu.dataSupressao"                    + " from LigacaoAgua lagu"                    + " where lagu.id = :idLigacaoAgua";            retorno = (Object[]) session.createQuery(consulta).setInteger(                    "idLigacaoAgua", idLigacaoAgua).setMaxResults(1)                    .uniqueResult();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * Consulta os dados das ordens de serviço para a geração do relatório     *      * @author Rafael Corrêa, Vivianne Sousa     * @created 07/10/2006, 09/03/2007     * @return     * @throws ErroRepositorioException     */    public Collection pesquisarOrdemServicoProgramacaoRelatorio(            Integer idEquipe, Date dataRoteiro) throws ErroRepositorioException {        Collection retorno = null;        Session session = HibernateUtil.getSession();        String consulta = null;        try {            if (dataRoteiro != null) {                consulta = "SELECT ospg.nnSequencialProgramacao, ra.id, "                        + "orse.id, svtp.id, orse.observacao "                        + "FROM OrdemServicoProgramacao ospg "                        + "INNER JOIN ospg.ordemServico orse "                        + "INNER JOIN ospg.equipe equipe "                        + "INNER JOIN ospg.programacaoRoteiro progRot "                        + "INNER JOIN orse.servicoTipo svtp "                        + "LEFT JOIN orse.registroAtendimento ra "                        + "WHERE equipe.id = :idEquipe "                        + "AND progRot.dataRoteiro = :dataRoteiro "                        + "AND orse.indicadorProgramada = :programada "                        + "AND (ospg.indicadorAtivo = :indicadorAtivo "                        + "OR (ospg.indicadorAtivo = :indicadorAtivoNao AND ospg.situacaoFechamento = :situacaoFechamento )) "                        + "ORDER BY ospg.nnSequencialProgramacao ";                retorno = session.createQuery(consulta).setInteger("idEquipe",                        idEquipe).setTimestamp("dataRoteiro", dataRoteiro)                        .setShort("indicadorAtivo",                                OrdemServicoProgramacao.INDICADOR_ATIVO)                        .setShort("indicadorAtivoNao",                                OrdemServicoProgramacao.INDICADOR_ATIVO_NAO)                        .setShort("situacaoFechamento",                                OrdemServicoProgramacao.SITUACAO_FECHAMENTO)                        .setShort("programada",                                ConstantesSistema.INDICADOR_USO_ATIVO).list();            } else {                consulta = "select ospg.nnSequencialProgramacao, ra.id, "                        + "orse.id, svtp.id, orse.observacao "                        + "from OrdemServicoProgramacao ospg "                        + "inner join ospg.ordemServico orse "                        + "inner join ospg.equipe equipe "                        + "left join orse.registroAtendimento ra "                        + "inner join orse.servicoTipo svtp "                        + "where equipe.id = :idEquipe"                        + "AND orse.indicadorProgramada = :programada "                        + "AND (ospg.indicadorAtivo = :indicadorAtivo "                        + "OR (ospg.indicadorAtivo = :indicadorAtivoNao AND ospg.situacaoFechamento = :situacaoFechamento )) "                        + "ORDER BY ospg.nnSequencialProgramacao ";                retorno = session.createQuery(consulta).setInteger("idEquipe",                        idEquipe).setShort("indicadorAtivo",                        OrdemServicoProgramacao.INDICADOR_ATIVO).setShort(                        "indicadorAtivoNao",                        OrdemServicoProgramacao.INDICADOR_ATIVO_NAO).setShort(                        "situacaoFechamento",                        OrdemServicoProgramacao.SITUACAO_FECHAMENTO).setShort(                        "programada", ConstantesSistema.INDICADOR_USO_ATIVO)                        .list();            }        } catch (HibernateException e) {            // levanta a exceção para a próxima camada            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            // fecha a sessão            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * [UC0404] Manter Especificação da Situação do Imovel Este caso de uso     * remove a especificação e os critério [SB0002] Remover Especificação da     * situacao     *      * @author Rafael Pinto     * @created 08/11/2006     * @throws ControladorException     *             Controlador Exception     */    public void removerEspecificacaoSituacaoImovelCriterio(            String[] idsEspecificacaoSituacaoImovel)            throws ErroRepositorioException {        String remocao = null;        Session session = HibernateUtil.getSession();        try {            remocao = "delete EspecificacaoImovSitCriterio "                    + "where esim_id IN(:ids)";            session.createQuery(remocao).setParameterList("ids",                    idsEspecificacaoSituacaoImovel).executeUpdate();        } catch (HibernateException e) {            // levanta a exceção para a próxima camada            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            // fecha a sessão            HibernateUtil.closeSession(session);        }    }    /**     * Pesquisa todos os ids das situações de ligação de água. [UC0564 - Gerar     * Resumo das Instalações de Hidrômetros]     *      * @author Pedro Alexandre     * @date 25/04/2007     * @return     * @throws ErroRepositorioException     */    public Collection<Integer> pesquisarTodosIdsSituacaoLigacaoAgua()            throws ErroRepositorioException {        Collection<Integer> retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "select last.id from LigacaoAguaSituacao last";            retorno = session.createQuery(consulta).list();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * Pesquisa todos os ids das situações de ligação de esgoto. [UC0564 - Gerar     * Resumo das Instalações de Hidrômetros]     *      * @author Pedro Alexandre     * @date 25/04/2007     * @return     * @throws ErroRepositorioException     */    public Collection<Integer> pesquisarTodosIdsSituacaoLigacaoEsgoto()            throws ErroRepositorioException {        Collection<Integer> retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "select lest.id from LigacaoEsgotoSituacao lest";            retorno = session.createQuery(consulta).list();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * Este cso de uso permite efetuar a ligação de água e eventualmente a     * instalação de hidrômetro, sem informação de RA sendo chamado direto pelo     * menu. [UC0579] - Efetuar Ligação de Água com Intalação de Hidrômetro     *      * @author Flávio Leonardo     * @date 25/04/2007     * @param idImovel     * @return     * @throws ErroRepositorioException     */    public Collection pesquisarEfetuarLigacaoAguaHidrometroSemRA(            Integer idImovel) throws ErroRepositorioException {        Collection retorno = null;        Session session = HibernateUtil.getSession();        try {            String hql = "select imovel.id," // 0                    + " cliente.nome,"// 1                    + " cliente.cpf,"// 2                    + " cliente.cnpj,"// 3                    + " ligacaoAguaSituacao.descricao,"// 4                    + " ligacaoEsgotoSituacao.descricao,"// 5                    + " imovel.indicadorExclusao,"// 6                    + " quadra.indicadorRedeAgua,"// 7                    + " ligacaoAguaSituacao.id,"// 8                    + " ligacaoEsgotoSituacao.id"// 9                    + " from ClienteImovel clienteImovel"                    + " inner join clienteImovel.imovel imovel"                    + " inner join clienteImovel.cliente cliente"                    + " inner join imovel.ligacaoAguaSituacao ligacaoAguaSituacao"                    + " inner join imovel.ligacaoEsgotoSituacao ligacaoEsgotoSituacao"                    + " inner join imovel.quadra quadra"                    + " where imovel.id = :idImovel"                    + " and clienteImovel.clienteRelacaoTipo.id = :relacaoTipo"                    + " and clienteImovel.dataFimRelacao is null";            retorno = session.createQuery(hql).setInteger("idImovel", idImovel)                    .setInteger("relacaoTipo",                            new Integer(ClienteRelacaoTipo.USUARIO))                    .setMaxResults(1).list();        } catch (HibernateException e) {            // levanta a exceção para a próxima camada            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            // fecha a sessão            HibernateUtil.closeSession(session);        }        return retorno;    }    /**     * [UC0XXX] Gerar Contrato de Prestação de Serviço     *      * @author Rafael Corrêa     * @date 03/05/2007     * @throws ErroRepositorioException     */    public Collection obterDadosContratoPrestacaoServico(Integer idImovel)			throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		String consulta;		Collection retorno = null;		try {			/*			 * consulta = "SELECT clie.clie_nmcliente as nomeCliente,			 * unidNeg.uneg_nmabreviado as nomeUnidadeNegocio, " // 0, 1 +			 * "clieResponsavel.clie_nmcliente as nomeResponsavel,			 * clieResponsavel.clie_nncpf as cpfResponsavel, " // 2, 3 +			 * "clieResponsavel.clie_nnrg as rgResponsavel, clie.clie_nncpf as			 * cpfCliente, clie.clie_nnrg as rgCliente, " // 4, // 5, 6 +			 * "clie.clie_id as idCliente, clieResponsavel.clie_id as			 * idResponsavel, imov.cstf_id as consumoTarifa, " // 7, // 8, 9 +			 * "municipio.muni_nmmunicipio as nomeMunicipio " // 10 + "FROM			 * cadastro.imovel imov " + "INNER JOIN cadastro.localidade loc " +			 * "on loc.loca_id = imov.loca_id " + "LEFT OUTER JOIN			 * cadastro.bairro bairro " + "on loc.bair_id = bairro.bair_id " +			 * "LEFT OUTER JOIN cadastro.municipio municipio " + "on			 * bairro.muni_id = municipio.muni_id " // + "INNER JOIN			 * cadastro.gerencia_regional greg " // + "on greg.greg_id =			 * loc.greg_id " + "INNER JOIN cadastro.unidade_negocio unidNeg " +			 * "on unidNeg.uneg_id = loc.uneg_id " + "INNER JOIN			 * cadastro.cliente_imovel clieImov " + "on clieImov.imov_id =			 * imov.imov_id and clieImov.crtp_id = " +			 * ClienteRelacaoTipo.USUARIO.toString() + "and			 * clieImov.clim_dtrelacaofim is null " + "INNER JOIN			 * cadastro.cliente clie " + "on clie.clie_id = clieImov.clie_id " +			 * "LEFT OUTER JOIN cadastro.cliente clieResponsavel " + "on			 * clieResponsavel.clie_id = unidNeg.clie_id " + "where imov.imov_id =			 * :idImovel";			 */			consulta = "SELECT loc.loca_nmlocalidade as nomeLocalidade, "// 0					+ "clieResponsavel.clie_nmcliente as nomeResponsavel, " // 1					+ "clieResponsavel.clie_nncpf as cpfResponsavel, " // 2					+ "clieResponsavel.clie_nnrg as rgResponsavel, " //3					+ "clieResponsavel.clie_id as idResponsavel, " //4					+ "imov.cstf_id as consumoTarifa, " // 5					+ "municipio.muni_nmmunicipio as nomeMunicipio " //6					//+ "clie.clie_nncpf as cpfCliente, " //5					//+ "clie.clie_nnrg as rgCliente, " // 6					//+ "clie.clie_id as idCliente, " // 7					//+ "clieResponsavel.clie_id as idResponsavel, " //8					//+ "imov.cstf_id as consumoTarifa, " // 9					//+ "municipio.muni_nmmunicipio as nomeMunicipio " // 10					+ "FROM cadastro.imovel imov "					+ "INNER JOIN cadastro.localidade loc "					+ "on loc.loca_id = imov.loca_id "					+ "LEFT OUTER JOIN cadastro.bairro bairro "					+ "on loc.bair_id = bairro.bair_id "					+ "LEFT OUTER JOIN cadastro.municipio municipio "					+ "on bairro.muni_id = municipio.muni_id "					// + "INNER JOIN cadastro.gerencia_regional greg "					// + "on greg.greg_id = loc.greg_id "					/*+ "INNER JOIN cadastro.unidade_negocio unidNeg "					+ "on unidNeg.uneg_id = loc.uneg_id "*/					/*+ "INNER JOIN cadastro.cliente_imovel clieImov "					+ "on clieImov.imov_id = imov.imov_id and clieImov.crtp_id = "					+ ClienteRelacaoTipo.USUARIO.toString()					+ "and clieImov.clim_dtrelacaofim is null "*/					/*+ "INNER JOIN cadastro.cliente clie "					+ "on clie.clie_id = clieImov.clie_id "*/					+ "LEFT OUTER JOIN cadastro.cliente clieResponsavel "					+ "on clieResponsavel.clie_id = loc.clie_id "					+ "where imov.imov_id = :idImovel";			retorno = (Collection) session.createSQLQuery(consulta)/*.addScalar(					"nomeCliente", Hibernate.STRING)*/.addScalar(					"nomeLocalidade", Hibernate.STRING).addScalar(					"nomeResponsavel", Hibernate.STRING).addScalar(					"cpfResponsavel", Hibernate.STRING).addScalar(					"rgResponsavel", Hibernate.STRING)/*.addScalar("cpfCliente",					Hibernate.STRING).addScalar("rgCliente", Hibernate.STRING)*/					/*.addScalar("idCliente", Hibernate.INTEGER)*/.addScalar(							"idResponsavel", Hibernate.INTEGER).addScalar(							"consumoTarifa", Hibernate.INTEGER).addScalar(							"nomeMunicipio", Hibernate.STRING).setInteger(							"idImovel", idImovel).list();		} catch (HibernateException e) {			e.printStackTrace();			throw new ErroRepositorioException("Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}    /**	 * [UC0582] - Emitir Boletim de Cadastro Obtém os dados necessário da	 * ligação de água, de esgoto e do hidrômetro instalado na ligação de água	 * 	 * @author Rafael Corrêa	 * @date 17/05/2007	 * @throws ErroRepositorioException	 */    public Object[] obterDadosLigacaoAguaEsgoto(Integer idImovel)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        Object[] retorno = null;        try {            consulta = "SELECT lagu.lagd_id as diametroLigAgua, lagu.lagm_id as materialLigAgua, "                    + " lesg.legd_id as diametroLigEsgoto, lesg.legm_id as materialLigEsgoto, "                    + " hidrInstHist.hidi_nnleitinstalacaohidmt as leituraInicial, hidr.hicp_id as capacidade, "                    + " hidr.himc_id as marca, hidrInstHist.hili_id as localInstalacao, hidrInstHist.hipr_id as protecao, "                    + " hidrInstHist.hidi_iccavalete as cavalete, hidr.hidr_nnhidrometro as numeroHidrometro "                    + " FROM cadastro.imovel imov "                    + " LEFT OUTER JOIN atendimentopublico.ligacao_agua lagu on lagu.lagu_id = imov.imov_id "                    + " LEFT OUTER JOIN micromedicao.hidrometro_inst_hist hidrInstHist on hidrInstHist.hidi_id = lagu.hidi_id "                    + " LEFT OUTER JOIN micromedicao.hidrometro hidr on hidr.hidr_id = hidrInstHist.hidr_id "                    + " LEFT OUTER JOIN atendimentopublico.ligacao_esgoto lesg on lesg.lesg_id = imov.imov_id "                    + " WHERE imov.imov_id = :idImovel";                        retorno = (Object[]) session.createSQLQuery(consulta).            	addScalar("diametroLigAgua", Hibernate.INTEGER).            	addScalar("materialLigAgua", Hibernate.INTEGER).            	addScalar("diametroLigEsgoto", Hibernate.INTEGER).            	addScalar("materialLigEsgoto", Hibernate.INTEGER).            	addScalar("leituraInicial", Hibernate.INTEGER).            	addScalar("capacidade", Hibernate.INTEGER).            	addScalar("marca",Hibernate.INTEGER).            	addScalar("localInstalacao",Hibernate.INTEGER).            	addScalar("protecao", Hibernate.INTEGER).            	addScalar("cavalete", Hibernate.SHORT).            	addScalar("numeroHidrometro", Hibernate.STRING).            	setInteger("idImovel", idImovel).            	setMaxResults(1).            	uniqueResult();                    } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    public void atualizarImovelLigacaoAguaInstalacaoHidrometroSemRA(            Integer idImovel, Integer idHidrometro)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        try {            if (idImovel != null) {                String hql = "update gcom.cadastro.imovel.Imovel set "                        + "last_id = :situacao, imov_tmultimaalteracao = :ultimaAlteracao "                         +"where imov_id = :idImovel";                session.createQuery(hql).setInteger("situacao", LigacaoAguaSituacao.LIGADO)                						 .setTimestamp("ultimaAlteracao", new Date())                						.setInteger("idImovel",idImovel).executeUpdate();            }            if (idHidrometro != null) {                String hql2 = "update gcom.micromedicao.hidrometro.Hidrometro set "                        + "hist_id = :situacao, hidr_tmultimaalteracao = :ultimaAlteracao "                         + "where hidr_id = :idHidrometro";                session.createQuery(hql2).setInteger("situacao",HidrometroSituacao.INSTALADO)                						 .setTimestamp("ultimaAlteracao", new Date())                						 .setInteger("idHidrometro", idHidrometro).executeUpdate();            }        } catch (HibernateException e) {            // levanta a exceção para a próxima camada            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            // fecha a sessão            HibernateUtil.closeSession(session);        }    }    //*********************************************************    //****************CONTRATO PESSOA JURIDICA*****************    public Cliente pesquisaClienteContrato(Integer idCliente)            throws ErroRepositorioException {        Cliente retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "from Cliente cliente"                    + " left join fetch cliente.profissao profissao"                    + " inner join fetch cliente.clienteTipo clienteTipo"                    + " where cliente.id = :idCliente";            retorno = (Cliente) session.createQuery(consulta).setInteger(                    "idCliente", idCliente).uniqueResult();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    public ClienteImovel pesquisarDadosContratoJuridica(Integer idImovel)            throws ErroRepositorioException {        ClienteImovel retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "from ClienteImovel clienteImovel"                    + " inner join fetch clienteImovel.cliente cliente"                    + " inner join fetch clienteImovel.imovel imovel"                    + " inner join fetch cliente.clienteTipo clienteTipo"                    + " inner join fetch clienteTipo.esferaPoder esferaPoder"                    + " where imovel.id = " + idImovel                    + " and clienteImovel.clienteRelacaoTipo.id = "                    + ClienteRelacaoTipo.USUARIO                    + " and clienteImovel.dataFimRelacao is null ";            retorno = (ClienteImovel) session.createQuery(consulta)                    .setMaxResults(1).uniqueResult();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    public String pesquisarMunicipio(Integer idImovel)            throws ErroRepositorioException {        String retorno = null;        Session session = HibernateUtil.getSession();        String consulta = "";        try {            consulta = "select municipio.nome from  Imovel imovel"                    + " inner join fetch imovel.localidade localidade"                    + " inner join fetch localidade.logradouroBairro logradouro"                    + " inner join fetch logradouro.bairro bairro"                    + " inner join fetch bairro.municipio municipio"                    + " where imovel.id = :idImovel";            retorno = (String) session.createQuery(consulta).setInteger(                    "idImovel", idImovel).uniqueResult();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }    //**********************************************************************************    /**     * [UC0482]Emitir 2ª Via de Conta     *obter numero do hidrômetro na ligação de água.     *      * @author Vivianne Sousa     * @date 11/09/2007     *      * @param imovelId     * @return existencia de hidrometro ou não     * @throws ErroRepositorioException     */    public String obterNumeroHidrometroEmLigacaoAgua(Integer imovelId)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        String retornoConsulta = null;        try {            consulta = "SELECT hidr.numero " + "FROM LigacaoAgua la "                    + "inner join la.hidrometroInstalacaoHistorico hidi "                    + "inner join hidi.hidrometro hidr "                    + "where la.id = :imovelId ";            retornoConsulta = (String) session.createQuery(consulta)                    .setInteger("imovelId", imovelId).uniqueResult();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }    /**     *      * [UC0738] Retorna as informações para o relatório de certidão negativa     *      * @param imo     *      * @return     *      * @throws ErroRepositorioException     *      */    public Collection<Object[]> pesquisarRelatorioCertidaoNegativa(Imovel imo)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        Collection retornoConsulta = null;        try {            consulta = " select \n"                    +                    // 0                    "   cli.nome, \n"                    +                    // 1                    "   imo.id, \n"                    +                    // 2                    "   loc.id, \n"                    +                    // 3                    "   sc.codigo, \n"                    +                    // 4                    "   qua.numeroQuadra, \n"                    +                    // 5                    "   imo.lote, \n"                    +                    // 6                    "   imo.subLote, \n"                    +                    // 7                    "   imo.quantidadeEconomias, \n"                    +                    // 8                    "   ip.descricao, \n"                    +                    // 9                    "   las.descricao, \n"                    +                    // 10                    "   les.descricao, \n"                    +                    // 11                    "   pt.descricao, \n"                    +                    // 12                    "   sp.nomeAbreviadoEmpresa, \n"                    +                    // 13                    "   sp.nomeEmpresa, \n"                    +                    // 14                    "   sp.cnpjEmpresa, \n"                    +                    // 15                    "   loc.descricao, \n"                    +                    // 16                    "   coalesce( ltp.descricao, '' ) || ' ' || coalesce( ltt.descricao, '' ) || ' ' || coalesce( log.nome, '' ) as logradouro, \n"                    +                    // 17                    "   sp.numeroImovel, \n" +                    // 18                    "   sp.complementoEndereco, \n" +                    // 19                    "   er.descricaoAbreviada, \n" +                    // 20                    "   bai.nome, \n" +                    // 21                    "   cep.codigo, \n" +                    // 22                    "   sp.nomeSiteEmpresa, \n" +                    // 23                    "   sp.numero0800Empresa, \n" +                    // 24                    "   sp.inscricaoEstadual, \n" +                    // 25                    "   imo.areaConstruida, \n" +                    // 26                    "   areaConstruidaFaixa, \n" +                      // 27                    "   hidr.numero, \n " +                    // 28                    " unidNeg.nome, \n" +                    // 29                    " cli.cpf, \n" +                    //30                    " cli.cnpj, \n" +                    //31                    " cliTipo.indicadorPessoaFisicaJuridica \n"                                + " from \n"                    + "   ClienteImovel ci \n"                    + "   inner join ci.clienteRelacaoTipo crt \n"                    + "   inner join ci.cliente cli \n"                    + "   inner join cli.clienteTipo cliTipo \n"                    + "   inner join ci.imovel imo \n"                    + "   inner join imo.localidade loc \n"                    + "   inner join loc.unidadeNegocio unidNeg \n"                    + "   inner join imo.setorComercial sc \n"                    + "   inner join imo.quadra qua \n"                    + "   inner join imo.imovelPerfil ip \n"                    + "   inner join imo.ligacaoAguaSituacao las \n"                    + "   inner join imo.ligacaoEsgotoSituacao les  \n"                    + "   left join imo.pocoTipo pt,  \n"                    + "   SistemaParametro sp \n"//                    + "   left join sp.logradouro log \n"                    + "   left join sp.logradouroCep logradouroCep "					+ "   left join logradouroCep.logradouro log "                    + "   left join log.logradouroTipo ltp \n"                    + "   left join log.logradouroTitulo ltt \n"                    + "   left join sp.enderecoReferencia er \n"//                    + "   left join sp.bairro bai \n"                    + "left join sp.logradouroBairro logradouroBairro "					+ "left join logradouroBairro.bairro bai \n "//                    + "   left join sp.cep cep \n"        			+ "   left join logradouroCep.cep cep "                    + "   left join imo.areaConstruidaFaixa areaConstruidaFaixa \n"                     + "   left join imo.ligacaoAgua lagu \n"                    + "   left join lagu.hidrometroInstalacaoHistorico hidInsHist "                    + "   left join hidInsHist.hidrometro hidr "                    + " where  \n"                    + "   crt.id = 2 and \n"                    + "   ci.dataFimRelacao is null and \n "                    + "   imo.id = :idImovel \n";            retornoConsulta = session.createQuery(consulta).setInteger(                    "idImovel", imo.getId()).list();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }        /**     * Pesquisa os dados necessários para a geração do relatório     *      * [UC0864] Gerar Certidão Negativa por Cliente     *      * @return     *      * @throws ErroRepositorioException     */    public Collection<Object[]> pesquisarRelatorioCertidaoNegativaCliente(Collection<Integer> idsClientes)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        Collection<Object[]> retorno = null;        try {            consulta = " SELECT DISTINCT clie.clie_id as idClienteResponsavel, " // 0            		+ " clieImov.imov_id as idImovel, " //1                    + " ligAguaSit.last_dsabreviado as situacaoLigacaoAgua, " //2                    + " clie.clie_nncpf as cpf, " //3                    + " clie.clie_nncnpj as cnpj,  " //4                    + " clieTipo.cltp_icpessoafisicajuridica as incicadorCpfCnpj " //5                    + " FROM cadastro.cliente clie "                    + " INNER JOIN cadastro.cliente_tipo clieTipo "                    + " on clieTipo.cltp_id = clie.cltp_id "                    + " INNER JOIN cadastro.cliente_imovel clieImov "                    + " on clieImov.clie_id = clie.clie_id and clieImov.clim_dtrelacaofim is null "                     + " INNER JOIN cadastro.imovel imov "                    + " on imov.imov_id = clieImov.imov_id "                    + " INNER JOIN atendimentopublico.ligacao_agua_situacao ligAguaSit "                     + " on ligAguaSit.last_id = imov.last_id "                    + " WHERE clie.clie_id in (:idsClientes) and imov.imov_icexclusao =2"                     + " order by clieImov.imov_id";            retorno = session.createSQLQuery(consulta)            			.addScalar( "idClienteResponsavel", Hibernate.INTEGER)            			.addScalar( "idImovel", Hibernate.INTEGER)            			.addScalar( "situacaoLigacaoAgua", Hibernate.STRING)            			.addScalar( "cpf", Hibernate.STRING)            			.addScalar( "cnpj", Hibernate.STRING)            			.addScalar( "incicadorCpfCnpj", Hibernate.SHORT)            			.setParameterList( "idsClientes", idsClientes).list();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }        /**	 * [UC0541] Emitir 2a Via Conta Internet	 *	 * [FS0004] - Cliente não associado ao documento	 *	 * @author Raphael Rossiter	 * @date 21/10/2008	 *	 * @param idImovel	 * @param cpf	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarClienteAssociadoImovelComCPF(Integer idImovel, String cpf)		throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = null;				try {			consulta = "SELECT cliente " 					 + "FROM ClienteImovel clienteImovel "					 + "INNER JOIN clienteImovel.cliente cliente "					 + "INNER JOIN clienteImovel.imovel imovel "					 + "WHERE imovel.id = :idImovel " 					 + "AND clienteImovel.dataFimRelacao IS NULL "					 + "AND cliente.cpf = :cpf ";					retorno = session.createQuery(consulta).setInteger("idImovel",					idImovel.intValue()).setString("cpf", cpf.trim()).list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC0541] Emitir 2a Via Conta Internet	 *	 * [FS0004] - Cliente não associado ao documento	 *	 * @author Raphael Rossiter	 * @date 21/10/2008	 *	 * @param idImovel	 * @param cnpj	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarClienteAssociadoImovelComCNPJ(Integer idImovel, String cnpj)		throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = null;				try {			consulta = "SELECT cliente " 					 + "FROM ClienteImovel clienteImovel "					 + "INNER JOIN clienteImovel.cliente cliente "					 + "INNER JOIN clienteImovel.imovel imovel "					 + "WHERE imovel.id = :idImovel " 					 + "AND clienteImovel.dataFimRelacao IS NULL "					 + "AND cliente.cnpj = :cnpj ";					retorno = session.createQuery(consulta).setInteger("idImovel",					idImovel.intValue()).setString("cnpj", cnpj.trim()).list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}			/**	 * [UC0482] Emitir 2a Via Conta	 *	 * [FS0002] - Cliente sem documento	 *	 * @author Raphael Rossiter	 * @date 24/10/2008	 *	 * @param idImovel	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarClienteAssociadoImovelComDocumentoInformado(Integer idImovel)		throws ErroRepositorioException {			Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = null;				try {			consulta = "SELECT cliente " 					 + "FROM ClienteImovel clienteImovel "					 + "INNER JOIN clienteImovel.cliente cliente "					 + "INNER JOIN clienteImovel.imovel imovel "					 + "WHERE imovel.id = :idImovel " 					 + "AND clienteImovel.dataFimRelacao IS NULL "					 + "AND (cliente.cpf IS NOT NULL OR cliente.cnpj IS NOT NULL)";					retorno = session.createQuery(consulta).setInteger("idImovel",					idImovel.intValue()).list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;		}			 /**     * [UC0150] Retificar Conta     * @author Vivianne Sousa     * @date 26/11/2008     */    public BigDecimal obterPercentualAguaConsumidaColetadaImovel(Integer idImovel)            throws ErroRepositorioException {    	        Session session = HibernateUtil.getSession();        String consulta;        BigDecimal retornoConsulta = null;                try {            consulta = "SELECT le.percentualAguaConsumidaColetada "             		+ "FROM LigacaoEsgoto le "                    + "where le.id = :idImovel ";                        retornoConsulta = (BigDecimal) session.createQuery(consulta)	            .setInteger("idImovel", idImovel)	            .setMaxResults(1).uniqueResult();                    } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }    /**     * [UC0XXX] Gerar Contrato de Prestação de Serviço     *      * @author Rafael Corrêa     * @date 03/05/2007     * @throws ErroRepositorioException     */    public Collection obterDadosUnidadeNegocioeInformacoesResponsavel(Integer idImovel)			throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		String consulta;		Collection retorno = null;		try {						consulta = "SELECT unidNeg.uneg_nmabreviado as nomeUnidadeNegocio, " // 0					+ "clieResponsavel.clie_nmcliente as nomeResponsavel, " // 1 					+ "clieResponsavel.clie_nncpf as cpfResponsavel, " // 2					+ "clieResponsavel.clie_nnrg as rgResponsavel, " // 3					/*+ "clie.clie_nncpf as cpfCliente, " // 5					+ "clie.clie_nnrg as rgCliente, " // 6 					+ "clie.clie_id as idCliente, "  //7*/					+ "clieResponsavel.clie_id as idResponsavel, " // 4 					+ "imov.cstf_id as consumoTarifa, " // 5					+ "municipio.muni_nmmunicipio as nomeMunicipio " // 6					+ "FROM cadastro.imovel imov "					+ "INNER JOIN cadastro.localidade loc "					+ "on loc.loca_id = imov.loca_id "					+ "LEFT OUTER JOIN cadastro.bairro bairro "					+ "on loc.bair_id = bairro.bair_id "					+ "LEFT OUTER JOIN cadastro.municipio municipio "					+ "on bairro.muni_id = municipio.muni_id "					// + "INNER JOIN cadastro.gerencia_regional greg "					// + "on greg.greg_id = loc.greg_id "					+ "INNER JOIN cadastro.unidade_negocio unidNeg "					+ "on unidNeg.uneg_id = loc.uneg_id "					/*+ "INNER JOIN cadastro.cliente_imovel clieImov "					+ "on clieImov.imov_id = imov.imov_id and clieImov.crtp_id = "					+ ClienteRelacaoTipo.USUARIO.toString()					+ "and clieImov.clim_dtrelacaofim is null "					+ "INNER JOIN cadastro.cliente clie "					+ "on clie.clie_id = clieImov.clie_id "*/					+ "LEFT OUTER JOIN cadastro.cliente clieResponsavel "					+ "on clieResponsavel.clie_id = unidNeg.clie_id "					+ "where imov.imov_id = :idImovel";			retorno = (Collection) session.createSQLQuery(consulta).addScalar(					"nomeCliente", Hibernate.STRING).addScalar(					"nomeUnidadeNegocio", Hibernate.STRING).addScalar(					"nomeResponsavel", Hibernate.STRING).addScalar(					"cpfResponsavel", Hibernate.STRING).addScalar(					"rgResponsavel", Hibernate.STRING).addScalar("cpfCliente",					Hibernate.STRING).addScalar("rgCliente", Hibernate.STRING)					.addScalar("idCliente", Hibernate.INTEGER).addScalar(							"idResponsavel", Hibernate.INTEGER).addScalar(							"consumoTarifa", Hibernate.INTEGER).addScalar(							"nomeMunicipio", Hibernate.STRING).setInteger(							"idImovel", idImovel).list();		} catch (HibernateException e) {			e.printStackTrace();			throw new ErroRepositorioException("Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}            /**	 * [UC0898] Atualizar Autos de Infração com prazo de Recurso Vencido	 * 	 * @author Sávio Luiz	 * @date 08/05/2009	 */    public Collection<AutosInfracao> pesquisarAutoInfracaoRecursoVencido(Integer idSituacaoAutoInfracao,Date prazoEntregaRecursoVencido)            throws ErroRepositorioException {    	        Session session = HibernateUtil.getSession();        String consulta;        Collection retornoConsulta = null;                try {            consulta = "SELECT ai "             		+ "FROM AutosInfracao ai "            		+ "INNER JOIN ai.fiscalizacaoSituacao fs "            		+ "INNER JOIN ai.autoInfracaoSituacao ais "            		+ "where ais.id = :idAutoInfracaoSituacao and  ai.dataEmissao < :prazoEntregaRecursoVencido";                        retornoConsulta = session.createQuery(consulta)                .setInteger("idAutoInfracaoSituacao",idSituacaoAutoInfracao) 	            .setDate("prazoEntregaRecursoVencido", prazoEntregaRecursoVencido)	            .list();                    } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retornoConsulta;    }        /**	 * [UC0898] Atualizar Autos de Infração com prazo de Recurso Vencido	 * 	 * [SB0001] Atualizar Autos Infração	 * 	 * @author Sávio Luiz	 * @date 08/05/2009	 */    public void atualizarAutosInfracao(Collection idsAutosInfracao,    		Integer idSituacaoAutoInfracao) throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update;        try {            update = "update AutosInfracao set "                    + "aist_id = :idSituacaoAutoInfracao,"                    + "auif_tmultimaalteracao = :datahoracorrente "                    + "where auif_id in (:idsAutosInfracao)";            session.createQuery(update).setInteger("idSituacaoAutoInfracao",            		idSituacaoAutoInfracao).setParameterList("idsAutosInfracao",            				idsAutosInfracao)                    .setDate("datahoracorrente", new Date()).executeUpdate();        } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {        	HibernateUtil.closeSession(session);        }    }        /**	 * [UC0898] Atualizar Autos de Infração com prazo de Recurso Vencido	 * 	 * @author Sávio Luiz	 * @date 08/05/2009	 */    public Collection<FiscalizacaoSituacaoServicoACobrar> pesquisarFiscalizacaoSituacaoServicoACobrar(Integer idFiscalizacaoSituacao)            throws ErroRepositorioException {    	        Session session = HibernateUtil.getSession();        String consulta;        Collection<Object[]> retornoConsulta = null;                Collection<FiscalizacaoSituacaoServicoACobrar> collFiscalizacaoSituacaoSAC = null;                try {            consulta = "SELECT fssc.consumoCalculo, "//0            	    + "fs.indicadorAtualizacaoAutosInfracao, "//1            	    + "dt.valorSugerido, "//2            	    + "fssc.numeroVezesServicoCalculadoValor, "//3            	    + "dt.id, "//4            	    + "fs.id, "//5            	    + "fssc.indicadorMultaInfracao "//6            		+ "FROM FiscalizacaoSituacaoServicoACobrar fssc "            		+ "INNER JOIN fssc.fiscalizacaoSituacao fs "            		+ "INNER JOIN fssc.debitoTipo dt "            		+ "where fs.id = :idFiscalizacaoSituacao";                        retornoConsulta = session.createQuery(consulta)                .setInteger("idFiscalizacaoSituacao",idFiscalizacaoSituacao)	            .list();                        collFiscalizacaoSituacaoSAC = new ArrayList();            if(retornoConsulta != null && !retornoConsulta.isEmpty()){            	for(Object[] parmsFiscalizacao : retornoConsulta){            		FiscalizacaoSituacaoServicoACobrar fiscalizacaoSituacaoServicoACobrar = new FiscalizacaoSituacaoServicoACobrar();            		if(parmsFiscalizacao != null){            			//consumo do calculo            			if (parmsFiscalizacao[0] != null) {            				fiscalizacaoSituacaoServicoACobrar.setConsumoCalculo((Short)parmsFiscalizacao[0]);						}            			// indicador de multa de infração            			if (parmsFiscalizacao[6] != null) {            				fiscalizacaoSituacaoServicoACobrar.setIndicadorMultaInfracao((Short)parmsFiscalizacao[6]);						}            			//id da situação do auto						if (parmsFiscalizacao[5] != null) {						  FiscalizacaoSituacao fiscalizacaoSituacao = new FiscalizacaoSituacao();						  fiscalizacaoSituacao.setId((Integer)parmsFiscalizacao[5]);						  // Inidicador atualização autos infração						  if (parmsFiscalizacao[1] != null) {						    fiscalizacaoSituacao.setIndicadorAtualizacaoAutosInfracao((Short)parmsFiscalizacao[1]);						    fiscalizacaoSituacaoServicoACobrar.setFiscalizacaoSituacao(fiscalizacaoSituacao);						  }						}						//valor sugerido do débito tipo						if (parmsFiscalizacao[4] != null) {							DebitoTipo debitoTipo = new DebitoTipo();							debitoTipo.setId((Integer)parmsFiscalizacao[4]);							if(parmsFiscalizacao[2] != null){							  debitoTipo.setValorSugerido((BigDecimal)parmsFiscalizacao[2]);							}							fiscalizacaoSituacaoServicoACobrar.setDebitoTipo(debitoTipo);						}						//número de vezes de cálculo de valor						if (parmsFiscalizacao[3] != null) {							fiscalizacaoSituacaoServicoACobrar.setNumeroVezesServicoCalculadoValor((Short)parmsFiscalizacao[3]);						}																		collFiscalizacaoSituacaoSAC.add(fiscalizacaoSituacaoServicoACobrar);            		}            	}            }                    } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return collFiscalizacaoSituacaoSAC;    }      	    /**	 * [UC0996] Emitir Ordem de Fiscalização para imóveis suprimidos	 * 	 * @author Hugo Amorim	 * @date 08/03/2010	 * @param idFuncionalidadeIniciada	 * @param usuarioLogado	 * @param setorComercial	 */    public Collection<Object[]> pesquisarImoveisBatchEmitirOrdemFiscalizacao(    		Integer idSetorComercial,Date data,Integer quantidadeInicio, Integer quantidadeMaxima)    			throws ErroRepositorioException {			Session session = HibernateUtil.getSession();						String consulta;						Collection<Object[]> retorno = null;						try {						    consulta = 			    	"SELECT i.imov_id as imovel,"			    	+" iper_dsimovelperfil as perfil,"			    	+" i.loca_id as idLocalida,"			    	+" sc.stcm_id as idSetor,"			    	+" sc.stcm_cdsetorcomercial as codSetor,"			    	+" q.qdra_id as idQuadra,"			    	+" q.qdra_nnquadra as numeroQuadra,"			    	+" imov_nnlote as lote,"			    	+" imov_nnsublote as subLote,"				    	+" imov_tmultimaalteracao as ultimaAlteracao,"			    	+" last.last_id as ligacaoAguaSituacao,"			    	+" last.last_dsligacaoaguasituacao as desLigacaoAguaSituacao,"			    	+" lest.lest_id as ligacaoEsgotoSituacao,"			    	+" lest.lest_dsligacaoesgotosituacao as descLigacaoEsgotoSituacao,"			    	+" lagu.lagu_dtcorte as dataCorte,"			    	+" clie_nmcliente as nomeCliente,"			    	+" clie_nncpf as cpf,"			    	+" clie_nncnpj as cnpj,"			    	+" clie_nnrg as rg,"			    	+" cfon_nnfone as fone,"			    	+" cfon_nnfoneramal as ramal,"			    	+" fnet_dsfonetipo as foneTipo,"			    	+" lagu_dtsupressaoagua as dataSupressao,"			    	+" r.ftgr_id as faturamentoGrupo,"			    	+" lesg.lesg_nnconsumominimoesgoto as consumoMinimo"			    	+" FROM cadastro.imovel i"			    	+" INNER JOIN cadastro.setor_comercial sc on sc.stcm_id = i.stcm_id"			    	+" INNER JOIN cadastro.quadra q on q.qdra_id = i.qdra_id"			    	+" INNER JOIN micromedicao.rota r on r.rota_id = q.rota_id"			    	+" INNER JOIN atendimentopublico.ligacao_agua lagu on lagu.lagu_id = i.imov_id"			    	+" LEFT JOIN atendimentopublico.ligacao_esgoto lesg on lesg.lesg_id = i.imov_id"			    	+" INNER JOIN atendimentopublico.ligacao_esgoto_situacao lest on lest.lest_id = i.lest_id"			    	+" INNER JOIN cadastro.imovel_perfil ip on ip.iper_id = i.iper_id"			     	+" INNER JOIN atendimentopublico.ligacao_agua_situacao last on last.last_id = i.last_id"			    	+" INNER JOIN cadastro.cliente_imovel cliImov on cliImov.imov_id = i.imov_id"			    	+" INNER JOIN cadastro.cliente cli on cli.clie_id = cliImov.clie_id"			    	+" LEFT JOIN cadastro.cliente_fone cf on cf.clie_id = cli.clie_id AND cfon_icfonepadrao  = :icFonePadrao"			    	+" LEFT JOIN cadastro.fone_tipo ft on ft.fnet_id = cf.fnet_id"			    	+" LEFT JOIN atendimentopublico.ordem_servico os on os.imov_id = i.imov_id and orse_cdsituacao = :osSituacao " 			    		+" AND os.svtp_id = (SELECT svtp_id FROM atendimentopublico.servico_tipo WHERE svtp_nncodigoconstante = :servicoTipoFisc ) "			    	+" WHERE i.last_id in (:ligacoesAguaSituacao)"			    	+" AND i.imov_icexclusao = :indicador"			    	+" AND lagu_dtsupressaoagua < :data"			    	+" AND cliImov.crtp_id = :clienteRelacaoTipo and clim_dtrelacaofim is null" 			    	+" AND i.imov_id not in " +			    			"(SELECT imov_id FROM atendimentopublico.ordem_servico WHERE svtp_id = " +			    			"(SELECT svtp_id FROM atendimentopublico.servico_tipo WHERE svtp_nncodigoconstante = :servicoTipoFisc ) " +			    			"and orse_cdsituacao != :osSituacao  ) "			    	+" AND i.stcm_id = :idSetor"			    	+" ORDER BY i.loca_id,sc.stcm_cdsetorcomercial,q.qdra_nnquadra,imov_nnlote,imov_nnsublote";			    	  			    	Collection ligacoesAguaSituacao =new ArrayList<Integer>();			    				    	ligacoesAguaSituacao.add(LigacaoAguaSituacao.SUPRIMIDO);			    	ligacoesAguaSituacao.add(LigacaoAguaSituacao.SUPR_PARC);			    	ligacoesAguaSituacao.add(LigacaoAguaSituacao.SUPR_PARC_PEDIDO);						    				    	retorno = session.createSQLQuery(consulta)			    			.addScalar("imovel", Hibernate.INTEGER)			    			.addScalar("perfil", Hibernate.STRING)			    			.addScalar("idLocalida", Hibernate.INTEGER)				    			.addScalar("idSetor", Hibernate.INTEGER)			    			.addScalar("codSetor", Hibernate.INTEGER)			    			.addScalar("idQuadra", Hibernate.INTEGER)			    			.addScalar("numeroQuadra", Hibernate.INTEGER)			    			.addScalar("lote", Hibernate.SHORT)			    			.addScalar("subLote", Hibernate.SHORT)			    			.addScalar("ultimaAlteracao", Hibernate.TIMESTAMP)			    			.addScalar("ligacaoAguaSituacao", Hibernate.INTEGER)			    			.addScalar("desLigacaoAguaSituacao", Hibernate.STRING)			    			.addScalar("ligacaoEsgotoSituacao", Hibernate.INTEGER)			    			.addScalar("descLigacaoEsgotoSituacao", Hibernate.STRING)			    			.addScalar("dataCorte", Hibernate.DATE)			    			.addScalar("nomeCliente", Hibernate.STRING)			    			.addScalar("cpf", Hibernate.STRING)			    			.addScalar("cnpj", Hibernate.STRING)			    			.addScalar("rg", Hibernate.STRING)			    			.addScalar("fone", Hibernate.STRING)			    			.addScalar("ramal", Hibernate.STRING)			    			.addScalar("foneTipo", Hibernate.STRING)			    			.addScalar("dataSupressao", Hibernate.DATE)			    			.addScalar("faturamentoGrupo", Hibernate.INTEGER)			    			.addScalar("consumoMinimo", Hibernate.INTEGER)    			    			.setParameterList("ligacoesAguaSituacao", ligacoesAguaSituacao)			    			.setShort("osSituacao", OrdemServico.SITUACAO_ENCERRADO)			    			.setInteger("servicoTipoFisc",ServicoTipo.TIPO_ORDEM_SERVICO_FISCALIZACAO)			    			.setShort("indicador", ConstantesSistema.INDICADOR_USO_DESATIVO)			    			.setShort("icFonePadrao", ConstantesSistema.SIM)			    			.setDate("data", data)			    			.setShort("clienteRelacaoTipo", ClienteRelacaoTipo.USUARIO)			    			.setInteger("idSetor", idSetorComercial)			    			.setFirstResult(quantidadeInicio).setMaxResults(quantidadeMaxima)			    			.list();						} catch (HibernateException e) {			    throw new ErroRepositorioException(e, "Erro no Hibernate");			} finally {			    HibernateUtil.closeSession(session);			}						return retorno;	}        /**	 * [UC0996] Emitir Ordem de Fiscalização para imóveis suprimidos	 * 	 * 	Inseri objeto na base do tipo ImovelSuprimido	 * 	 * @author Hugo Amorim	 * @date 08/03/2010	 * @param idFuncionalidadeIniciada	 * @param usuarioLogado	 * @param setorComercial	 */	public void inserirImovelSuprimido(ImovelSuprimido imovelSuprimido)throws ErroRepositorioException{		Session session = HibernateUtil.getSession();		Connection con = null;		Statement stmt = null;		con = session.connection();		try {			stmt = con.createStatement();						String insert = 				" INSERT INTO cadastro.imoveis_suprimidos("            +" imsu_id, orse_id, imsu_dstxtgerado, imsu_tmexecucao,"            +" imsu_tmultimaalteracao, loca_id, stcm_cdsetorcomercial, stcm_id,"            +" qdra_id, imsu_nnlote, imsu_nnsublote, qdra_nnquadra)"            +" VALUES (nextval('cadastro.sequence_imoveis_suprimidos')"            +" ,"+imovelSuprimido.getOrdemServico().getId()             +" ,'"+imovelSuprimido.getLinhaTxt()+"'"            +" ,'"+imovelSuprimido.getDataExecucao()+"'"            +" , now()"            +" ,"+imovelSuprimido.getIdLocalidade()            +" ,"+imovelSuprimido.getCodigoSetorComercial()            +" ,"+imovelSuprimido.getIdSetorComercial()            +" ,"+imovelSuprimido.getIdQuadra()            +" ,"+imovelSuprimido.getNumeroLote()            +" ,"+imovelSuprimido.getNumeroSubLote()            +" ,"+imovelSuprimido.getNumeroQuadra()+")";        			stmt.executeUpdate(insert);		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} catch (SQLException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}	}	 /**	 * [UC0996] Emitir Ordem de Fiscalização para imóveis suprimidos	 * 	 * 	Pesquisas linhas do txt	 * 	 * @author Hugo Amorim	 * @date 08/03/2010	 * @param idFuncionalidadeIniciada	 * @param usuarioLogado	 * @param setorComercial	 */	public Collection<ImovelSuprimido> pesquisarDadosEmitirArquivoTextoDeOrdemFiscalizacao(			Integer quantidadeInicio, Integer quantidadeMaxima)			throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		Collection retorno  = null;		String consulta;				try {			consulta = //"SELECT linhaTxt "					"FROM ImovelSuprimido  "					+ " ORDER BY idLocalidade,codigoSetorComercial,numeroQuadra,numeroLote,numeroSubLote ";			retorno = session.createQuery(consulta).setFirstResult(quantidadeInicio).setMaxResults(quantidadeMaxima).list();		} catch (HibernateException e) {			e.printStackTrace();			throw new ErroRepositorioException("Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}   	    /**	 * [SB0002]  Replicar os serviços existentes para uma nova vigência e valor.	 * Pesquisa a última vigência de cada tipo serviço, e retorna uma coleção. 	 * 	 * @author Josenildo Neves	 * @date 03/02/2010	 */	public Collection<ServicoCobrancaValor> pesquisarServicoCobrancaValorUltimaVigencia(Integer numeroPagina) throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		try {			consulta = 	"select "						+"* "						+"from atendimentopublico.servico_cobranca_valor scv, "						+"(select "						+"svtp_id as id, "						+"max(scbv_dtvigenciafinal) as data "						+"from atendimentopublico.servico_cobranca_valor "						+"group by "						+"svtp_id) sc "						+"where "						+"scv.svtp_id = id and "						+"scv.scbv_dtvigenciafinal = sc.data";						retorno = session.createSQLQuery(consulta)							.addScalar("scbv_id",Hibernate.INTEGER)							.addScalar("svtp_id",Hibernate.INTEGER)							.addScalar("iper_id",Hibernate.INTEGER)							.addScalar("hicp_id",Hibernate.INTEGER)							.addScalar("scbv_vlservico",Hibernate.BIG_DECIMAL)							.addScalar("scbv_icmedido",Hibernate.SHORT)							.addScalar("scbv_tmultimaalteracao",Hibernate.DATE)							.addScalar("scat_id",Hibernate.INTEGER)							.addScalar("scbv_dtvigenciainicial",Hibernate.DATE)							.addScalar("scbv_dtvigenciafinal",Hibernate.DATE)							.addScalar("scbv_qteconomiasinicial",Hibernate.INTEGER)							.addScalar("scbv_qteconomiasfinal",Hibernate.INTEGER)							.addScalar("scbv_icconsideraeconomias",Hibernate.SHORT)							.addScalar("catg_id", Hibernate.INTEGER)							.setFirstResult(10 * numeroPagina).setMaxResults(10).list();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 [SB0002]  Replicar os serviços existentes para uma nova vigência e valor.	 * Pesquisa a última vigência de cada tipo serviço, e retorna o total.   	 * 	 * @author Josenildo Neves	 * @date 03/02/2010	 */	public Integer pesquisarServicoCobrancaValorUltimaVigenciaTotal() throws ErroRepositorioException {		Integer retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		try {			consulta = 	"select "						+"* "						+"from atendimentopublico.servico_cobranca_valor scv, "						+"(select "						+"svtp_id as id, "						+"max(scbv_dtvigenciafinal) as data "						+"from atendimentopublico.servico_cobranca_valor "						+"group by "						+"svtp_id) sc "						+"where "						+"scv.svtp_id = id and "						+"scv.scbv_dtvigenciafinal = sc.data";						retorno = session.createSQLQuery(consulta)						.addScalar("scbv_id",Hibernate.INTEGER)						.addScalar("svtp_id",Hibernate.INTEGER)						.addScalar("iper_id",Hibernate.INTEGER)						.addScalar("hicp_id",Hibernate.INTEGER)						.addScalar("scbv_vlservico",Hibernate.DOUBLE)						.addScalar("scbv_icmedido",Hibernate.SHORT)						.addScalar("scbv_tmultimaalteracao",Hibernate.DATE)						.addScalar("scbv_dtvigenciainicial",Hibernate.DATE)						.addScalar("scbv_dtvigenciafinal",Hibernate.DATE)						.addScalar("scat_id",Hibernate.INTEGER)						.addScalar("scbv_qteconomiasinicial",Hibernate.INTEGER)						.addScalar("scbv_qteconomiasfinal",Hibernate.INTEGER)						.addScalar("scbv_icconsideraeconomias",Hibernate.SHORT)						.list().size();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 * [SB0002]  Replicar os Valores de Cobrança de Serviço existentes para uma nova vigência e valor.	 * Pesquisa a última vigência de cada tipo Cobrança, e retorna uma coleção.   	 * 	 * @author Hugo Leonardo		 * @date 14/04/2010	 */	public Collection<ServicoCobrancaValor> replicarServicoCobrancaValorUltimaVigencia(String[] selecionados) throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		try {			consulta = 	" select * "					  + " from atendimentopublico.servico_cobranca_valor scv, "					  + " (select svtp_id as id, "					  + " max(scbv_dtvigenciafinal) as data "					  + " from atendimentopublico.servico_cobranca_valor "					  + " group by svtp_id) sc "					  + " where scv.svtp_id = id "					  + " and scv.scbv_dtvigenciafinal = sc.data "					  + " and scv.scbv_id in (:selecionados)";							retorno = session.createSQLQuery(consulta)						.addScalar("scbv_id",Hibernate.INTEGER)						.addScalar("svtp_id",Hibernate.INTEGER)						.addScalar("iper_id",Hibernate.INTEGER)						.addScalar("hicp_id",Hibernate.INTEGER)						.addScalar("scbv_vlservico",Hibernate.BIG_DECIMAL)						.addScalar("scbv_icmedido",Hibernate.SHORT)						.addScalar("scbv_tmultimaalteracao",Hibernate.DATE)						.addScalar("scat_id",Hibernate.INTEGER)						.addScalar("scbv_dtvigenciainicial",Hibernate.DATE)						.addScalar("scbv_dtvigenciafinal",Hibernate.DATE)						.addScalar("scbv_qteconomiasinicial",Hibernate.INTEGER)						.addScalar("scbv_qteconomiasfinal",Hibernate.INTEGER)						.addScalar("scbv_icconsideraeconomias",Hibernate.SHORT)						.addScalar("catg_id",Hibernate.INTEGER)						.addScalar("scbv_icgerardebito", Hibernate.SHORT)						.setParameterList("selecionados",selecionados).list();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 * [UC0391] Inserir valor cobrança Serviço.	 * 	 * Verificar se existe vigência já cadastrada para o Serviço Tipo.	 * 	 * @author Hugo Leonardo	 * @param dataVigenciaInicial	 * @param dataVigenciaFinal	 * @param idServicoTipo	 * @param opcao	 * @throws ErroRepositorioException	 * @data 03/05/2010	 * 	 * return String	 * 	 * @see Caso a opcao = 1 - verifica as situações de inserir e atualizar Serviço Tipo.	 * @see Caso a opcao = 2 - verifica a situação de retificar Serviço Tipo.	 */	public String verificarExistenciaVigenciaServicoTipo(String dataVigenciaInicial, String dataVigenciaFinal, Integer idServicoTipo)		throws ErroRepositorioException {		String retorno = "";				Session session = HibernateUtil.getSession();				String consulta = "";				consulta +=" select svtp_id as cont " 				 + " from atendimentopublico.servico_cobranca_valor " 				 + " where ((scbv_dtvigenciainicial <= :dataInicial " 				 + " or scbv_dtvigenciainicial <= :dataFinal) "				 + " and scbv_dtvigenciafinal >= :dataFinal ) "				 + " and svtp_id = :idServicoTipo";		try {			retorno = (String) session.createSQLQuery(consulta)				.addScalar("cont", Hibernate.STRING)				.setInteger("idServicoTipo", idServicoTipo)				.setDate("dataInicial", Util.converteStringParaDate(dataVigenciaInicial))			    .setDate("dataFinal", Util.converteStringParaDate(dataVigenciaFinal))				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}				return retorno;	}			/**	 * [UC0366] Inserir Registro de Atendimento	 *  [SB0034]  Verificar RA de urgência	 * 	 * Verifica se o Registro de Atendimento tem o nivel selecionado como Urgência	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento 	 * @throws ErroRepositorioException	 * @data   03/06/2010	 * 	 * 	 */	public Integer verificarRegistroAtendimentoUrgencia(Integer idRegistroAtendimento)		throws ErroRepositorioException {		Integer retorno = 0;		Session session = HibernateUtil.getSession();		String consulta = "";		consulta +="SELECT COUNT(*) AS contador " +				     "FROM gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra " +				    "INNER JOIN ra.solicitacaoTipoEspecificacao step " +				    "WHERE ra.id = :registroAtendimento " +				      "AND step.indicadorUrgencia = 1";		try {			retorno = (Integer) session.createQuery(consulta)				.setInteger("registroAtendimento", idRegistroAtendimento)								.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}	/**	 * [UC0366] Inserir Registro de Atendimento	 *  [SB0034]  Verificar RA de urgência	 *  	 * Pesquisar os Usuários da Unidade relacionada a RA, na tabela "VisualizacaoRaUrgencia" 	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento 	 * @throws ErroRepositorioException	 * @data   03/06/2010 	 * 	 */	public Collection pesquisarUsuarioVisualizacaoRaUrgencia(Integer idRegistroAtendimento)		throws ErroRepositorioException {				Session session = HibernateUtil.getSession();				Collection retorno = null;				int quantidadeRA = verificarRegistroAtendimentoUrgencia(idRegistroAtendimento);				if(quantidadeRA > 0){												String consulta = "";						consulta +="SELECT ra.id, usuario.id, 2, 2 " +					  "FROM gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra " +					  "INNER JOIN ra.unidadeAtual unidade, " +					   "gcom.seguranca.acesso.usuario.Usuario usuario " +					  "WHERE usuario.unidadeOrganizacional.id = unidade.id " +					    "AND ra.id = :registroAtendimento ";			try {								retorno = (Collection) session.createQuery(consulta).setInteger("registroAtendimento",	                    idRegistroAtendimento).list();							} catch (HibernateException e) {				// levanta a exceção para a próxima camada				throw new ErroRepositorioException(e, "Erro no Hibernate");			} finally {				// fecha a sessão				HibernateUtil.closeSession(session);			}					}				return retorno;					}			/**	 * [UC0503] Tramitar Conjunto Registro Atendimento	 * 	 *  [SB0004]  Verificar RA de urgência	 *  	 * Retorna um ou todos usuários da unidade relacionada a RA, 	 *  da tabela "VisualizacaoRaUrgencia" 	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento, ID da Unidade, ID do Usuário 	 * @throws ErroRepositorioException	 * @data   04/06/2010	 * 	 */	public Collection pesquisarVisualizacaoRaUrgencia(Integer idRegistroAtendimento, Integer idUnidade, Integer idUsuario)		throws ErroRepositorioException {				Session session = HibernateUtil.getSession();				Collection retorno = null;				//valor padrão, usado para entrar no if quando nao houver RA informada 		int quantidadeRA = 1;						if(idRegistroAtendimento != null){			quantidadeRA = verificarRegistroAtendimentoUrgencia(idRegistroAtendimento);					}						if(quantidadeRA > 0){			String consulta = "";						consulta +="SELECT vrau.registroAtendimento.id, vrau.usuario.id, 2, 2, vrau.id " +					     "FROM gcom.atendimentopublico.registroatendimento.VisualizacaoRegistroAtendimentoUrgencia vrau " +					     "INNER JOIN vrau.usuario usuario ";						if(idRegistroAtendimento != null){				consulta += "WHERE vrau.registroAtendimento.id = "+idRegistroAtendimento+" ";			}else{				consulta += "WHERE ";			}			if(idUnidade != null){								consulta +="usuario.unidadeOrganizacional.id = "+ idUnidade +" AND ";							}else if(idUsuario != null){								consulta += "usuario.id = "+ idUsuario +" AND ";							}			//remove o último AND			consulta = Util.removerUltimosCaracteres(consulta, 4);			try {								retorno = (Collection) session.createQuery(consulta).list();							} catch (HibernateException e) {				// levanta a exceção para a próxima camada				throw new ErroRepositorioException(e, "Erro no Hibernate");			} finally {				// fecha a sessão				HibernateUtil.closeSession(session);			}					}				return retorno;					}		/**	 * [UC0503] Tramitar Conjunto Registro Atendimento	 * 	 *  [SB0004]  Verificar RA de urgência	 * 	 * Verifica se o Registro de Atendimento já está relacionado a uma Unidade informada.	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento 	 * @throws ErroRepositorioException	 * @data   05/06/2010	 * 	 */	public Integer verificarUsuariosRegistroAtendimentoUrgencia(Integer idRegistroAtendimento, Integer idUnidade)		throws ErroRepositorioException {		Integer retorno = 0;		Session session = HibernateUtil.getSession();		String consulta = "";		consulta +="SELECT COUNT(*) as contador " +				     "FROM gcom.atendimentopublico.registroatendimento.VisualizacaoRegistroAtendimentoUrgencia vrau " +				     "INNER JOIN vrau.usuario usuario " +					"WHERE vrau.registroAtendimento.id = :registroAtendimento " +					  "AND usuario.unidadeOrganizacional.id = "+ idUnidade +" ";				try {			retorno = (Integer) session.createQuery(consulta)				.setInteger("registroAtendimento", idRegistroAtendimento)								.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 	 * [UC1028] Exibir Registro Atendimento Urgência	 *  	 * Verifica se o Usuario possui algum Registro de Atendimento urgente.	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento 	 * @throws ErroRepositorioException	 * @data   07/06/2010	 * 	  	 */	public Collection verificarUsuarioRegistroAtendimentoUrgencia(Integer idUsuario)		throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";		consulta +="SELECT DISTINCT(vrau.indicadorReiteracao) as indicador " +	     "FROM gcom.atendimentopublico.registroatendimento.VisualizacaoRegistroAtendimentoUrgencia vrau " +		     "INNER JOIN vrau.registroAtendimento rgat " +		 "WHERE vrau.usuario.id = :idUsuario " +		 "AND vrau.indicadorTramite = 2 " +		 "AND vrau.indicadorVisualizacao = 2 " ;//		 "AND rgat.parecerEncerramento is null " +//		 "AND rgat.dataEncerramento is null ";				//		consulta +="SELECT COUNT(*) as contador " +//				     "FROM gcom.atendimentopublico.registroatendimento.VisualizacaoRegistroAtendimentoUrgencia vrau " +				     //					 "WHERE vrau.usuario.id = :idUsuario " +//					 "AND vrau.indicadorTramite = 2 " +//					 "AND vrau.indicadorVisualizacao = 2 ";				try {			retorno = (Collection) session.createQuery(consulta)				.setInteger("idUsuario", idUsuario)								.list();					} catch (HibernateException e) {			// levanta a exceção para a próxima camada			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;	}	/**  	 * Atualiza um ou vários campos da tabela "VisualizacaoRaUrgencia" 	 * 	 * @author Daniel Alves	 * @param  ID do Registro de Atendimento, ID da Unidade, ID do Usuário, indicador Tramite e indicador Visualizacao 	 * @throws ErroRepositorioException	 * @data   10/06/2010	 * 	 */	public void atualizarUsuarioRegistroAtendimentoUrgencia(Integer idRegistroAtendimento, String idUsuarios, Integer idUsuario, Integer indicadorTramite, Integer indicadorVisualizacao)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String update;        try {                                update = "UPDATE gcom.atendimentopublico.registroatendimento.VisualizacaoRegistroAtendimentoUrgencia vrau set ";                                        if(indicadorTramite != null){            	update += "vrau.indicadorTramite = "+indicadorTramite+", ";            }				                        if(indicadorVisualizacao != null){            	update += "vrau.indicadorVisualizacao = "+indicadorVisualizacao+", ";             }                        update += "vrau.ultimaAlteracao = :ultimaAlteracao " +            		  "WHERE ";                                    if(idRegistroAtendimento != null){            	update += "vrau.registroAtendimento.id = "+idRegistroAtendimento+" AND ";            }                        if(idUsuario != null){            	update += "vrau.usuario.id = "+idUsuario+" AND ";            }                        if(idUsuarios != null){            	            	update += "vrau.usuario.id IN( "+idUsuarios+" ) AND " ;            }                        update = Util.removerUltimosCaracteres(update, 4);            	            	            session.createQuery(update)                   .setDate("ultimaAlteracao", new Date())                   .executeUpdate();                    } catch (HibernateException e) {            e.printStackTrace();            throw new ErroRepositorioException("Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);            // session.close();        }    }        /**	 * [UC0251] Gerar Atividade de Ação de Cobrança	 * 	 * @author Hugo Amorim	 * @date 15/07/2010	 */	public Collection<CobrancaAcaoAtividadeComandoFiscalizacaoSituacao> 		pesquisarCobrancaAcaoAtividadeComandoFiscalizacaoSituacao(			Integer idComando, Collection idsSituacos)throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		Collection retorno  = null;		String consulta;				try {			consulta = "FROM CobrancaAcaoAtividadeComandoFiscalizacaoSituacao"					+ " INNER JOIN FETCH cobAcaoFisc.fiscalizacaoSituacao fiscSit"					+ " WHERE cobrancaAcaoAtividadeComando.id = :idComando"					+ " AND fiscSit.id in ( :idsSituacos )";			retorno = session.createQuery(consulta)				.setInteger("idComando", idComando)				.setParameterList("idsSituacos", idsSituacos)				.list();		} catch (HibernateException e) {			e.printStackTrace();			throw new ErroRepositorioException("Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * 	 * @author Hugo Leonardo, Diogo Peixoto	 * @date 28/09/2010, 26/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioAcompanhamentoRAAnalitico( FiltrarAcompanhamentoRegistroAtendimentoHelper helper) 		throws ErroRepositorioException{				Collection retorno = null;		String consulta = "";		Query query = null;		Session session = HibernateUtil.getSession();		String groupByMunicipio = "";		String orderBy = " rau.unidadeOrganizacional ";				if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){			groupByMunicipio = " GROUP BY munRA.nome, munRA.id,  rau.unidadeOrganizacional.id, step.descricao, ra.registroAtendimento, " +						" ra.dataEncerramento, ra.dataEncerramento, ame.descricao, rau.unidadeOrganizacional.descricao, ame.id, ra.id ";			orderBy = " munRA.nome ";		}				try {			consulta += this.montarSelectRelatorioAcompanhamentoAnalitico(helper)					 +  this.montarFromRelatorioAcompanhamentoAnalitico(helper)					 +  " where ra.unidadeAtual = uni.id and ";						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){				consulta += " rau.unidadeOrganizacional = :unidade  and "					     +  " rau.atendimentoRelacaoTipo = 1 and ";			}						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				consulta += " (munRA.id IN (:municipios) or munImo.id IN (:municipios)) and ";			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								consulta += " ame.id in (:motivo) and ";			}			if(helper.getPeriodoAtendimentoInicial() != null && helper.getPeriodoAtendimentoFinal() != null ){								consulta += " (ra.registroAtendimento between :dtAtendimentoIncial and :dtAtendimentoFinal) and ";			}						if(helper.getPeriodoEncerramentoInicial() != null && helper.getPeriodoEncerramentoFinal() != null ){				consulta += " (ra.dataEncerramento between :dtEncerramentoIncial and :dtEncerramentoFinal) and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) ){				consulta += " ra.codigoSituacao = :situacao and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& helper.getSituacaoRAAbertos().equals("1")){								consulta += " (ra.dataPrevistaAtual >= :dtCorrente "						 +  " or ra.dataPrevistaOriginal >= :dtCorrente) and ";							}else if (Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos())					&& helper.getSituacaoRAAbertos().equals("0")){								consulta += " (ra.dataPrevistaAtual < :dtCorrente "					 	 +  " or ra.dataPrevistaOriginal < :dtCorrente) and ";			}						// remove o último AND			consulta = Util.removerUltimosCaracteres(consulta, 4);			consulta += groupByMunicipio;			consulta +=  " ORDER BY " + orderBy;							query = (Query) session.createQuery(consulta);						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								query.setString("unidade", helper.getIdUnidadeAtendimento().toString());			}						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				query.setParameterList("municipios", helper.getMunicipiosAssociados());			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								query.setParameterList("motivo", helper.getIdsMotivoEncerramentoSelecionados());			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								query.setDate("dtAtendimentoIncial", Util.formatarDataInicial(helper.getPeriodoAtendimentoInicial()));				query.setDate("dtAtendimentoFinal", Util.formatarDataFinal(helper.getPeriodoAtendimentoFinal()));			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								query.setDate("dtEncerramentoIncial", Util.formatarDataInicial(helper.getPeriodoEncerramentoInicial()));				query.setDate("dtEncerramentoFinal", Util.formatarDataFinal(helper.getPeriodoEncerramentoFinal()));			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& (helper.getSituacaoRAAbertos().equals("0") || helper.getSituacaoRAAbertos().equals("1"))){								query.setDate("dtCorrente", new Date());			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_PENDENTE);			}else if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("1")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_ENCERRADO);			}					retorno = query.list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * Método auxiliar para gerar o select HQL do relatório em questão 	 * @author Diogo Peixoto	 * @date 28/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return String	 * @throws ErroRepositorioException	 */	private String montarSelectRelatorioAcompanhamentoAnalitico(FiltrarAcompanhamentoRegistroAtendimentoHelper helper){		StringBuilder sb = new StringBuilder();		sb.append(" SELECT DISTINCT (ra.id), ");		sb.append(" rau.unidadeOrganizacional.id, ");		sb.append(" step.descricao, ");		sb.append(" ra.registroAtendimento, ");		sb.append(" ra.dataEncerramento, ");		sb.append(" ame.descricao, ");		sb.append(" rau.unidadeOrganizacional.descricao, ");		sb.append(" ame.id ");		if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){			sb.append(", munRA.nome ");			sb.append(", munRA.id ");		}		return sb.toString();	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * Método auxiliar para gerar o select HQL do relatório em questão 	 * @author Diogo Peixoto	 * @date 28/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return String	 * @throws ErroRepositorioException	 */	private String montarFromRelatorioAcompanhamentoAnalitico(FiltrarAcompanhamentoRegistroAtendimentoHelper helper){		StringBuilder sb = new StringBuilder();		sb.append(" from gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra ");		sb.append(" inner join ra.solicitacaoTipoEspecificacao step ");		sb.append(" left join ra.atendimentoMotivoEncerramento ame ");		sb.append(" inner join ra.registroAtendimentoUnidades rau ");		sb.append(" inner join rau.unidadeOrganizacional uni ");		sb.append(" left join ra.imovel imov ");		sb.append(" left join imov.localidade locImo ");		sb.append(" left join locImo.municipio munImo ");		if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){			sb.append(" inner join ra.localidade locRA ");			sb.append(" inner join locRA.municipio munRA ");		}else{			sb.append(" left join ra.localidade locRA ");			sb.append(" left join locRA.municipio munRA ");		}		return sb.toString();	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * 	 * @author Hugo Leonardo, Diogo Peixoto	 * @date 30/09/2010, 26/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return Integer	 * @throws ErroRepositorioException	 */	public Integer countPesquisarRelatorioAcompanhamentoRAAnalitico( FiltrarAcompanhamentoRegistroAtendimentoHelper helper) 		throws ErroRepositorioException{				Integer retorno = 0;		String consulta = "";		Query query = null;		Session session = HibernateUtil.getSession();				try {				consulta += " select count(distinct ra.id) " //0 					 +  " from gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra "					 +  " inner join ra.solicitacaoTipoEspecificacao step "					 +  " left join ra.atendimentoMotivoEncerramento ame ";						consulta += " inner join ra.registroAtendimentoUnidades rau "					 +  " inner join rau.unidadeOrganizacional uni "					 + 	" left join ra.localidade locRA "					 +  " left join locRA.municipio munRA "					 + 	" left join ra.imovel imov "					 + 	" left join imov.localidade locImo "					 +  " left join locImo.municipio munImo "					 					 +  " where ra.unidadeAtual = uni.id and ";						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								consulta += " rau.unidadeOrganizacional = :unidade  and "					     +  " rau.atendimentoRelacaoTipo = 1 and ";			}							if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				consulta += " (munRA.id IN (:municipios) or munImo.id IN (:municipios)) and ";			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								consulta += " ame.id in (:motivo) and ";			}			if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								consulta += " (ra.registroAtendimento between :dtAtendimentoIncial and :dtAtendimentoFinal) and ";			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								consulta += " (ra.dataEncerramento between :dtEncerramentoIncial and :dtEncerramentoFinal) and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) ){								consulta += " ra.codigoSituacao = :situacao and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& helper.getSituacaoRAAbertos().equals("1")){								consulta += " (ra.dataPrevistaAtual >= :dtCorrente "						 +  " or ra.dataPrevistaOriginal >= :dtCorrente) and ";			}else if (Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos())					&& helper.getSituacaoRAAbertos().equals("0")){								consulta += " (ra.dataPrevistaAtual < :dtCorrente "					 	 +  " or ra.dataPrevistaOriginal < :dtCorrente) and ";			}						// remove o último AND			consulta = Util.removerUltimosCaracteres(consulta, 4);							query = (Query) session.createQuery(consulta);						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								query.setString("unidade", helper.getIdUnidadeAtendimento().toString());			}						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				query.setParameterList("municipios", helper.getMunicipiosAssociados());			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								query.setParameterList("motivo", helper.getIdsMotivoEncerramentoSelecionados());			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								query.setDate("dtAtendimentoIncial", Util.formatarDataInicial(helper.getPeriodoAtendimentoInicial()));				query.setDate("dtAtendimentoFinal", Util.formatarDataFinal(helper.getPeriodoAtendimentoFinal()));			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								query.setDate("dtEncerramentoIncial", Util.formatarDataInicial(helper.getPeriodoEncerramentoInicial()));				query.setDate("dtEncerramentoFinal", Util.formatarDataFinal(helper.getPeriodoEncerramentoFinal()));			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& (helper.getSituacaoRAAbertos().equals("0") || helper.getSituacaoRAAbertos().equals("1"))){								query.setDate("dtCorrente", new Date());			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_PENDENTE);							}else if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("1")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_ENCERRADO);			}					retorno = (Integer) query.setMaxResults(1).uniqueResult();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * 	 * @author Hugo Leonardo, Diogo Peixoto	 * @date 01/10/2010, 28/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioAcompanhamentoRASinteticoAberto( FiltrarAcompanhamentoRegistroAtendimentoHelper helper) 		throws ErroRepositorioException{				Collection retorno = null;		String consulta = "";		Query query = null;		Session session = HibernateUtil.getSession();		String joinMunicipio = "";				if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) && 				(helper.getIdUnidadeAtendimento() == null || helper.getIdUnidadeAtendimento().equals(""))){			consulta += " select rau.unidadeOrganizacional.descricao, "				 +  " muni.nome, " 				 +  " count(distinct ra.id) "				 +  " from gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra "				 +  " inner join ra.solicitacaoTipoEspecificacao step "				 +  " left join ra.atendimentoMotivoEncerramento ame ";					consulta += " inner join ra.localidade loc "	 			 +  " inner join loc.municipio muni ";		}else{						consulta += " select rau.unidadeOrganizacional.descricao, ";			if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				consulta += " muni.nome, ";				joinMunicipio = " inner join ra.localidade loc "		 			 		 +  " inner join loc.municipio muni ";			}			consulta += " count(distinct ra.id) "				+  " from gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra "				+  " inner join ra.solicitacaoTipoEspecificacao step "				+  " left join ra.atendimentoMotivoEncerramento ame ";		}		consulta += joinMunicipio		+  " inner join ra.registroAtendimentoUnidades rau "		+  " inner join rau.unidadeOrganizacional uni "		+  " where ra.unidadeAtual = uni.id and ";				try {				if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								consulta += " rau.unidadeOrganizacional = :unidade  and "					     +  " rau.atendimentoRelacaoTipo = 1 and ";			}							if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								consulta += " ame.id in (:motivo) and ";			}			if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) ){								consulta += " muni.id in (:municipios) and ";			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								consulta += " (ra.registroAtendimento between :dtAtendimentoIncial and :dtAtendimentoFinal) and ";			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								consulta += " (ra.dataEncerramento between :dtEncerramentoIncial and :dtEncerramentoFinal) and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) ){								consulta += " ra.codigoSituacao = :situacao and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& helper.getSituacaoRAAbertos().equals("1")){								consulta += " (ra.dataPrevistaAtual >= :dtCorrente "						 +  " or ra.dataPrevistaOriginal >= :dtCorrente) and ";			}else if (Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos())					&& helper.getSituacaoRAAbertos().equals("0")){								consulta += " (ra.dataPrevistaAtual < :dtCorrente "					 	 +  " or ra.dataPrevistaOriginal < :dtCorrente) and ";			}						// remove o último AND			consulta = Util.removerUltimosCaracteres(consulta, 4);						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) 					&& (helper.getIdUnidadeAtendimento() == null || helper.getIdUnidadeAtendimento().equals(""))){								consulta += " GROUP BY muni.nome, rau.unidadeOrganizacional.descricao "				 		 +  " ORDER BY muni.nome, rau.unidadeOrganizacional.descricao  ";			}else{				String groupBy = " GROUP BY ";				String orderBy = " ORDER BY ";				if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){					groupBy += " muni.nome, ";					orderBy += " muni.nome, ";				}				groupBy += " rau.unidadeOrganizacional.descricao ";				orderBy += " rau.unidadeOrganizacional.descricao ";				consulta += groupBy + orderBy;			}							query = (Query) session.createQuery(consulta);						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								query.setString("unidade", helper.getIdUnidadeAtendimento().toString());			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){								query.setParameterList("motivo", helper.getIdsMotivoEncerramentoSelecionados());			}						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) ){								query.setParameterList("municipios", helper.getMunicipiosAssociados());			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								query.setDate("dtAtendimentoIncial", Util.formatarDataInicial(helper.getPeriodoAtendimentoInicial()));				query.setDate("dtAtendimentoFinal", Util.formatarDataFinal(helper.getPeriodoAtendimentoFinal()));			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								query.setDate("dtEncerramentoIncial", Util.formatarDataInicial(helper.getPeriodoEncerramentoInicial()));				query.setDate("dtEncerramentoFinal", Util.formatarDataFinal(helper.getPeriodoEncerramentoFinal()));			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& (helper.getSituacaoRAAbertos().equals("0") || helper.getSituacaoRAAbertos().equals("1"))){								query.setDate("dtCorrente", new Date());			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_PENDENTE);			}else if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("1")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_ENCERRADO);			}					retorno = query.list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1056] Gerar Relatório de Acompanhamento dos Registros de Atendimento	 * 	 * @author Hugo Leonardo, Diogo Peixoto	 * @date 01/10/2010, 28/04/2011	 * 	 * @param FiltrarAcompanhamentoRegistroAtendimentoHelper	 * @return Collection	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioAcompanhamentoRASinteticoEncerrado( FiltrarAcompanhamentoRegistroAtendimentoHelper helper) 		throws ErroRepositorioException{				Collection retorno = null;		String consulta = "";		Query query = null;		Session session = HibernateUtil.getSession();				String selectMunicipio = "";		String joinMunicipio = "";		if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){			selectMunicipio = ", muni.nome";			joinMunicipio = " inner join ra.localidade loc inner join loc.municipio muni ";		}				try {				consulta += " select rau.unidadeOrganizacional.descricao, ame.descricao, "					 +  " count(distinct ra.id) "					 + selectMunicipio					 +  " from gcom.atendimentopublico.registroatendimento.RegistroAtendimento ra "					 +  " inner join ra.solicitacaoTipoEspecificacao step "					 +  " left join ra.atendimentoMotivoEncerramento ame ";								consulta += " inner join ra.registroAtendimentoUnidades rau "					 +  " inner join rau.unidadeOrganizacional uni "					 + joinMunicipio					 +  " where ra.unidadeAtual = uni.id and ";						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){								consulta += " rau.unidadeOrganizacional = :unidade  and "					     +  " rau.atendimentoRelacaoTipo = 1 and ";			}							if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){				consulta += " ame.id in (:motivo) and ";			}			if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){				consulta += " muni.id in (:municipios) and ";			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								consulta += " (ra.registroAtendimento between :dtAtendimentoIncial and :dtAtendimentoFinal) and ";			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								consulta += " (ra.dataEncerramento between :dtEncerramentoIncial and :dtEncerramentoFinal) and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) ){								consulta += " ra.codigoSituacao = :situacao and ";			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& helper.getSituacaoRAAbertos().equals("1")){								consulta += " (ra.dataPrevistaAtual >= :dtCorrente "						 +  " or ra.dataPrevistaOriginal >= :dtCorrente) and ";			}else if (Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos())					&& helper.getSituacaoRAAbertos().equals("0")){								consulta += " (ra.dataPrevistaAtual < :dtCorrente "					 	 +  " or ra.dataPrevistaOriginal < :dtCorrente) and ";			}						// remove o último AND			consulta = Util.removerUltimosCaracteres(consulta, 4);						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) 					&& (helper.getIdUnidadeAtendimento() == null || helper.getIdUnidadeAtendimento().equals(""))){								consulta += " GROUP BY muni.nome, rau.unidadeOrganizacional.descricao, ame.descricao "				 		 +  " ORDER BY muni.nome, rau.unidadeOrganizacional.descricao, ame.descricao ";			}else{				String groupBy = " GROUP BY ";				String orderBy = " ORDER BY ";				if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados())){					groupBy += " muni.nome, ";					orderBy += " muni.nome, ";				}				groupBy += " rau.unidadeOrganizacional.descricao, ame.descricao ";				orderBy += " rau.unidadeOrganizacional.descricao, ame.descricao ";				consulta += groupBy + orderBy;			}										query = (Query) session.createQuery(consulta);						if(Util.verificarNaoVazio( helper.getIdUnidadeAtendimento()) ){				query.setString("unidade", helper.getIdUnidadeAtendimento().toString());			}						if(!Util.isVazioOrNulo(helper.getIdsMotivoEncerramentoSelecionados()) ){				query.setParameterList("motivo", helper.getIdsMotivoEncerramentoSelecionados());			}						if(!Util.isVazioOrNulo(helper.getMunicipiosAssociados()) ){				query.setParameterList("municipios", helper.getMunicipiosAssociados());			}						if(helper.getPeriodoAtendimentoInicial() != null  					&& helper.getPeriodoAtendimentoFinal() != null ){								query.setDate("dtAtendimentoIncial", Util.formatarDataInicial(helper.getPeriodoAtendimentoInicial()));				query.setDate("dtAtendimentoFinal", Util.formatarDataFinal(helper.getPeriodoAtendimentoFinal()));			}						if(helper.getPeriodoEncerramentoInicial() != null  					&& helper.getPeriodoEncerramentoFinal() != null ){								query.setDate("dtEncerramentoIncial", Util.formatarDataInicial(helper.getPeriodoEncerramentoInicial()));				query.setDate("dtEncerramentoFinal", Util.formatarDataFinal(helper.getPeriodoEncerramentoFinal()));			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0") 					&& Util.verificarNaoVazio(helper.getSituacaoRAAbertos()) 					&& (helper.getSituacaoRAAbertos().equals("0") || helper.getSituacaoRAAbertos().equals("1"))){								query.setDate("dtCorrente", new Date());			}						if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("0")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_PENDENTE);			}else if(Util.verificarNaoVazio(helper.getSituacaoRA()) 					&& helper.getSituacaoRA().equals("1")){								query.setShort("situacao", RegistroAtendimento.SITUACAO_ENCERRADO);			}					retorno = query.list();				} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}    	/**
	 * [UC1107] Manter Custo de Pavimento por Repavimentadora
 	 * 
 	 * @author Hugo Leonardo
 	 * @date 27/12/2010
 	 * 
 	 * @param idRepavimentadora, idPavimento, indicadorPavimento: 1-Rua, 2-Calçada
 	 * @return boolean
	 */
	public boolean verificaRemoverCustoPavimentoPorRepavimentadora(Integer idRepavimentadora,
			Integer idPavimento, Integer indicadorPavimento)throws ErroRepositorioException{
		
		// Cria uma sessão com o hibernate
		Session session = HibernateUtil.getSession();

		// Retorno Consulta
		boolean retorno = false;

		// Cria a variável que vai conter o hql
		String consulta = "";

		try {
				
			if(indicadorPavimento == 1){
				consulta +=
						  " SELECT ospv.id "
						+ " FROM OrdemServicoPavimento ospv, UnidadeRepavimentadoraCustoPavimentoRua urr1, UnidadeRepavimentadoraCustoPavimentoRua urr2 "
						+ " INNER JOIN ospv.ordemServico os" 
						+ " WHERE ospv.unidadeRepavimentadora.id = :repavimentadora " 
						+ " AND ((urr1.pavimentoRua.id = ospv.pavimentoRua.id and ospv.pavimentoRuaRetorno is null and urr1.pavimentoRua.id = :pavimento and urr1.unidadeRepavimentadora.id = :repavimentadora) " 
						+ " OR (urr2.pavimentoRua.id = ospv.pavimentoRuaRetorno.id and ospv.pavimentoRuaRetorno is not null and urr2.pavimentoRua.id = :pavimento and urr2.unidadeRepavimentadora.id = :repavimentadora)) "
						+ " AND ( "
						+ " 	( "
						+ " 	os.dataEncerramento >= urr1.dataVigenciaInicial "
						+ " 	AND	os.dataEncerramento <= urr1.dataVigenciaFinal "
						+ " 	AND urr1.dataVigenciaFinal is not null "
						+ " 	AND ospv.pavimentoRuaRetorno is null "
						+ " 	) "
						+ " OR ( "
						+ "  	os.dataEncerramento >= urr1.dataVigenciaInicial"
						+ "  	AND urr1.dataVigenciaFinal is null"
						+ "  	AND ospv.pavimentoRuaRetorno is null"
						+ "  	)"
						+ " OR ( "
						+ "  	os.dataEncerramento >= urr2.dataVigenciaInicial"
						+ "  	AND	os.dataEncerramento <= urr2.dataVigenciaFinal"
						+ " 	AND urr2.dataVigenciaFinal is not null "
						+ "  	AND ospv.pavimentoRuaRetorno is not null"
						+ " 	) "
						+ " OR ( "
						+ " 	os.dataEncerramento >= urr2.dataVigenciaInicial "
						+ " 	AND urr2.dataVigenciaFinal is null "
						+ " 	AND ospv.pavimentoRuaRetorno is not null "
						+ " 	) "
						+ " ) ";	
			}else{
				
				consulta +=
					  " SELECT ospv.id "
					+ " FROM OrdemServicoPavimento ospv, UnidadeRepavimentadoraCustoPavimentoCalcada urr1, UnidadeRepavimentadoraCustoPavimentoCalcada urr2 "
					+ " INNER JOIN ospv.ordemServico os" 
					+ " WHERE ospv.unidadeRepavimentadora.id = :repavimentadora " 
					+ " AND ((urr1.pavimentoCalcada.id = ospv.pavimentoCalcada.id and ospv.pavimentoCalcadaRetorno is null and urr1.pavimentoCalcada.id = :pavimento and urr1.unidadeRepavimentadora.id = :repavimentadora) " 
					+ " OR (urr2.pavimentoCalcada.id = ospv.pavimentoCalcadaRetorno.id and ospv.pavimentoCalcadaRetorno is not null and urr2.pavimentoCalcada.id = :pavimento and urr2.unidadeRepavimentadora.id = :repavimentadora)) "
					+ " AND ( "
					+ " 	( "
					+ " 	os.dataEncerramento >= urr1.dataVigenciaInicial "
					+ " 	AND	os.dataEncerramento <= urr1.dataVigenciaFinal "
					+ " 	AND urr1.dataVigenciaFinal is not null "
					+ " 	AND ospv.pavimentoCalcadaRetorno is null "
					+ " 	) "
					+ " OR ( "
					+ "  	os.dataEncerramento >= urr1.dataVigenciaInicial"
					+ "  	AND urr1.dataVigenciaFinal is null"
					+ "  	AND ospv.pavimentoCalcadaRetorno is null"
					+ "  	)"
					+ " OR ( "
					+ "  	os.dataEncerramento >= urr2.dataVigenciaInicial"
					+ "  	AND	os.dataEncerramento <= urr2.dataVigenciaFinal"
					+ " 	AND urr2.dataVigenciaFinal is not null "
					+ "  	AND ospv.pavimentoCalcadaRetorno is not null"
					+ " 	) "
					+ " OR ( "
					+ " 	os.dataEncerramento >= urr2.dataVigenciaInicial "
					+ " 	AND urr2.dataVigenciaFinal is null "
					+ " 	AND ospv.pavimentoCalcadaRetorno is not null "
					+ " 	) "
					+ " ) ";
				
			}
			
			Integer idRetorno = (Integer) session.createQuery(consulta)
				.setInteger("repavimentadora", idRepavimentadora)
				.setInteger("pavimento", idPavimento)
				.setMaxResults(1).uniqueResult();
			
			if(idRetorno != null){
				retorno = true;
			}

			// Erro no hibernate
		} catch (HibernateException e) {
			// Levanta a exceção para a próxima camada
			throw new ErroRepositorioException(e, "Erro no Hibernate");
		} finally {
			// Fecha a sessão com o hibernate
			HibernateUtil.closeSession(session);
		}

		return retorno;
	}
	
	/**
	 * [UC1107] Manter Custo de Pavimento por Repavimentadora
 	 * 
 	 * @author Hugo Leonardo
 	 * @date 28/12/2010
 	 * 
 	 * @param id, idRepavimentadora, idPavimento, dataInicio, dataFinal, indicadorPavimento: 1-Rua, 2-Calçada
 	 * @return Integer
 	 * 
 	 * @see Caso retorne resultado: return 0.
 	 * 
 	 * @see Caso o indicadorPavimento = 1 e dataFinal = null: return 1.
	 * @see Caso o indicadorPavimento = 1 e dataFinal != null: return 2.
	 * 
	 * @see Caso o indicadorPavimento = 2 e dataFinal = null: return 3.
	 * @see Caso o indicadorPavimento = 2 e dataFinal != null: return 4.
	 */
	public Integer verificaAtualizarCustoPavimentoPorRepavimentadora(Integer idAtualizacao, 
			Integer idRepavimentadora, Integer idPavimento, Date dataInicio, 
			Date dataFinal, Integer indicadorPavimento, Integer tipo)
		throws ErroRepositorioException{
		
		// Cria uma sessão com o hibernate
		Session session = HibernateUtil.getSession();

		// Retorno Consulta
		Integer retorno = 0;
		Integer idRetorno = null;

		// Cria a variável que vai conter o hql
		String consulta = "";

		try {
				
			if(indicadorPavimento == 1){
				consulta +=
						  " select urr1.id "
						+ " from UnidadeRepavimentadoraCustoPavimentoRua urr1 "
						+ " where urr1.unidadeRepavimentadora.id = :repavimentadora "
						+ " and urr1.pavimentoRua.id = :pavimento "
						+ " and urr1.id <> :idAtu and ( ";
						
				if(tipo == 1){
					
					consulta += " urr1.dataVigenciaFinal is null and "
							 + "  coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio and "
							 + "  urr1.dataVigenciaInicial <= :dtFinal and ";
							
					consulta = Util.removerUltimosCaracteres(consulta, 4) + ")";
				}else{
						
					consulta += 
							  " urr1.dataVigenciaFinal is not null and "
							+ " 	coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio and "
							+ " 	urr1.dataVigenciaInicial <= :dtFinal "
							+ " or ( urr1.dataVigenciaFinal is null " 
							+ "      or coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio ) "
							+ " and urr1.dataVigenciaInicial <= :dtFinal) ";
				}

			}else{
				
				consulta +=
					  " select urr1.id "
					+ " from UnidadeRepavimentadoraCustoPavimentoCalcada urr1 "
					+ " where urr1.unidadeRepavimentadora.id = :repavimentadora "
					+ " and urr1.pavimentoCalcada.id = :pavimento "
					+ " and urr1.id <> :idAtu and ( ";
				
				if(tipo == 1 ){
					
					consulta += " urr1.dataVigenciaFinal is null and "
							 +  " coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio and "
							 +  " urr1.dataVigenciaInicial <= :dtFinal and ";
							 
					consulta = Util.removerUltimosCaracteres(consulta, 4) + ")";
					
				}else{
					consulta += 
							  " urr1.dataVigenciaFinal is not null and "
							+ " 	coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio and "
							+ "     urr1.dataVigenciaInicial <= :dtFinal "
							+ " or ( urr1.dataVigenciaFinal is null "
							+ "      or coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) >= :dtInicio ) "
							+ " and	urr1.dataVigenciaInicial <= :dtFinal) ";
				}
				
			}
			
			if(indicadorPavimento == 1){
				if(tipo == 1 ){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
				
					if(idRetorno != null){
						retorno = 1;
					}
				}else{
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
					
					if(idRetorno != null){
						retorno = 2;
					}
				}
			}else{
				if(tipo == 1){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
			
					if(idRetorno != null){
						retorno = 3;
					}
				}else{
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
					
					if(idRetorno != null){
						retorno = 4;
					}
				}
			}

			// Erro no hibernate
		} catch (HibernateException e) {
			// Levanta a exceção para a próxima camada
			throw new ErroRepositorioException(e, "Erro no Hibernate");
		} finally {
			// Fecha a sessão com o hibernate
			HibernateUtil.closeSession(session);
		}

		return retorno;
	}
	
	/**
	 * [UC1107] Manter Custo de Pavimento por Repavimentadora
 	 * 
 	 * 		[FS0010] Verificar se existem dias sem valor
 	 * 
 	 * @author Hugo Leonardo
 	 * @date 11/01/2011
 	 * 
 	 * @param id, idRepavimentadora, idPavimento, dataInicio, dataFinal, indicadorPavimento: 1-Rua, 2-Calçada
 	 * @return Integer
	 * 
	 * VerificarExistenciDiasSemValor
	 */
	public Integer verificarExistenciDiasSemValorCustoPavimentoPorRepavimentadora(Integer idAtualizacao, 
			Integer idRepavimentadora, Integer idPavimento, Date dataInicio, 
			Date dataFinal, Integer indicadorPavimento, Integer tipo) throws ErroRepositorioException{
		
		// Cria uma sessão com o hibernate
		Session session = HibernateUtil.getSession();

		// Retorno Consulta
		Integer retorno = 0;
		Integer idRetorno = null;

		// Cria a variável que vai conter o hql
		String consulta = "";

		try {
				
			if(indicadorPavimento == 1){
				
				if(tipo == 1 ){
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoRua urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoRua.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and ( " 
							 + " 	urr1.id =( "
							 + " 			select r.id "
							 + " 			from UnidadeRepavimentadoraCustoPavimentoRua r "
							 + " 			where r.unidadeRepavimentadora.id = :repavimentadora "
							 + " 			and r.pavimentoRua.id = :pavimento "
							 + " 			and r.id <> :idAtu "
							 + " 			and r.dataVigenciaFinal = ( "
							 + " 						select max(r2.dataVigenciaFinal) "
							 + " 						from UnidadeRepavimentadoraCustoPavimentoRua r2 "
							 + " 						where r2.unidadeRepavimentadora.id = :repavimentadora "
							 + " 						and r2.pavimentoRua.id = :pavimento " 
							 + " 						and r2.id <> :idAtu "
							 + " 						and coalesce(r2.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) = :dtInicio "
							 + " 			) "
							 + " 	) " 
							 + " ) "
							 + " and coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) = :dtInicio ";
					
				}else if(tipo == 2 ){
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoRua urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoRua.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and ( " 
							 + " 	urr1.id = ( "
							 + " 			select r3.id "
							 + " 			from UnidadeRepavimentadoraCustoPavimentoRua r3 "
							 + " 			where r3.unidadeRepavimentadora.id = :repavimentadora "
							 + " 			and r3.pavimentoRua.id = :pavimento "
							 + " 			and r3.id <> :idAtu "
							 + " 			and r3.dataVigenciaInicial = ( "
							 + " 						select max(r4.dataVigenciaInicial) "
							 + " 						from UnidadeRepavimentadoraCustoPavimentoRua r4 "
							 + " 						where r4.unidadeRepavimentadora.id = :repavimentadora "
							 + " 						and r4.pavimentoRua.id = :pavimento " 
							 + " 						and r4.id <> :idAtu "
							 + " 						and coalesce(r4.dataVigenciaInicial, to_date('9999-12-31','YYYY/MM/DD')) = :dtFinal "
							 + " 			) "
							 + " 	) " 
							 + "    and urr1.dataVigenciaInicial = :dtFinal "
							 + " ) ";
					
				}else{
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoRua urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoRua.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and urr1.dataVigenciaInicial > :dtInicio ";
				}
				
			}else{
				
				if(tipo == 1 ){
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoCalcada urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoCalcada.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and ( " 
							 + " 	urr1.id = ( "
							 + " 			select r.id "
							 + " 			from UnidadeRepavimentadoraCustoPavimentoCalcada r "
							 + " 			where r.unidadeRepavimentadora.id = :repavimentadora "
							 + " 			and r.pavimentoCalcada.id = :pavimento "
							 + " 			and r.id <> :idAtu "
							 + " 			and r.dataVigenciaFinal = ( "
							 + " 						select max(r2.dataVigenciaFinal) "
							 + " 						from UnidadeRepavimentadoraCustoPavimentoCalcada r2 "
							 + " 						where r2.unidadeRepavimentadora.id = :repavimentadora "
							 + " 						and r2.pavimentoCalcada.id = :pavimento " 
							 + " 						and r2.id <> :idAtu "
							 + " 						and coalesce(r2.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) = :dtInicio "
							 + " 			) "
							 + " 	) "
							 + " ) "
							 + " and coalesce(urr1.dataVigenciaFinal, to_date('9999-12-31','YYYY/MM/DD')) = :dtInicio ";
					
				}else if(tipo == 2 ){
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoCalcada urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoCalcada.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and ( " 
							 + " 	urr1.id = ( "
							 + " 			select r.id "
							 + " 			from UnidadeRepavimentadoraCustoPavimentoCalcada r "
							 + " 			where r.unidadeRepavimentadora.id = :repavimentadora "
							 + " 			and r.pavimentoCalcada.id = :pavimento "
							 + " 			and r.id <> :idAtu "
							 + " 			and r.dataVigenciaInicial = ( "
							 + " 						select max(r2.dataVigenciaInicial) "
							 + " 						from UnidadeRepavimentadoraCustoPavimentoCalcada r2 "
							 + " 						where r2.unidadeRepavimentadora.id = :repavimentadora "
							 + " 						and r2.pavimentoCalcada.id = :pavimento " 
							 + " 						and r2.id <> :idAtu "
							 + " 						and coalesce(r2.dataVigenciaInicial, to_date('9999-12-31','YYYY/MM/DD')) = :dtFinal "
							 + " 			) "
							 + " 	) "
							 + " 	and urr1.dataVigenciaInicial = :dtFinal "
							 + " ) ";
					
				}else{
					
					consulta +=" select urr1.id "
							 + " from UnidadeRepavimentadoraCustoPavimentoCalcada urr1 "
							 + " where urr1.unidadeRepavimentadora.id = :repavimentadora "
							 + " and urr1.pavimentoCalcada.id = :pavimento "
							 + " and urr1.id <> :idAtu "
							 + " and urr1.dataVigenciaInicial > :dtInicio ";
					
				}
			}
			
			if(indicadorPavimento == 1){
				
				if(tipo == 1 ){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setMaxResults(1).uniqueResult();
				
					if(idRetorno == null){
						retorno = 1;
					}else{
						retorno = 0;
					}
				}else if(tipo == 2 ){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
					
					if(idRetorno == null){
						retorno = 2;
					}else{
						retorno = 0;
					}
				}else{
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", Util.adicionarNumeroDiasDeUmaData(dataInicio, 0))
						.setMaxResults(1).uniqueResult();
				
					if(idRetorno == null){
						retorno = 0;
					}else{
						retorno = 3;
					}
				}
				
			}else{
				
				if(tipo == 1 ){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", dataInicio)
						.setMaxResults(1).uniqueResult();
			
					if(idRetorno == null){
						retorno = 4;
					}else{
						retorno = 0;
					}
				}else if(tipo == 2 ){
					
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtFinal", dataFinal)
						.setMaxResults(1).uniqueResult();
					
					if(idRetorno != null){
						retorno = 5;
					}else{
						retorno = 0;
					}
				}else{
					idRetorno = (Integer) session.createQuery(consulta)
						.setInteger("idAtu", idAtualizacao)
						.setInteger("repavimentadora", idRepavimentadora)
						.setInteger("pavimento", idPavimento)
						.setDate("dtInicio", Util.adicionarNumeroDiasDeUmaData(dataInicio, -1))
						.setMaxResults(1).uniqueResult();
				
					if(idRetorno == null){
						retorno = 0;
					}else{
						retorno = 6;
					}
				}
			}

			// Erro no hibernate
		} catch (HibernateException e) {
			// Levanta a exceção para a próxima camada
			throw new ErroRepositorioException(e, "Erro no Hibernate");
		} finally {
			// Fecha a sessão com o hibernate
			HibernateUtil.closeSession(session);
		}

		return retorno;
	}		/**     * [UC0412] Manter Tipo de Serviço     *      * @author Vivianne Sousa     * @created 07/01/2011     */    public void removerServicoTipoBoletim(Integer idServicoTipo)            throws ErroRepositorioException {        String remocao = null;        Session session = HibernateUtil.getSession();        try {            remocao = "delete ServicoTipoBoletim "                    + "where svtp_id = :idServicoTipo ";            session.createQuery(remocao).setInteger("idServicoTipo",idServicoTipo).executeUpdate();        } catch (HibernateException e) {            // levanta a exceção para a próxima camada            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            // fecha a sessão            HibernateUtil.closeSession(session);        }    }        /**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes.	 *	 * @author Hugo Leonardo	 * @date 25/01/2011	 *	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioReligacaoClientesInadiplentesOS( 			FiltrarRelatorioReligacaoClientesInadiplentesHelper relatorioHelper) 		throws ErroRepositorioException {				Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";			Query query = null;		Map parameters = new HashMap();				try {						if(relatorioHelper.getEscolhaRelatorio() == 1){								consulta = " select distinct (os.id), os.imovel.id, os.dataEncerramento "					     + " from OrdemServico os "					     + " inner join os.imovel imo "					     + " inner join os.ordemServicoUnidades orseunid "						 + " inner join os.servicoTipo servtipo "						 + " inner join imo.localidade loca ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 2){							consulta = " select os.imovel.id, count(os.imovel.id) "					     + " from OrdemServico os "					     + " inner join os.imovel imo "						 + " inner join os.servicoTipo servtipo "						 + " inner join imo.localidade loca ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 3 || relatorioHelper.getEscolhaRelatorio() == 4){				/*				consulta = " select os.imovel.id, "						 + " orseunid.usuario.id, "						 + " count(os.imovel.id), "						 + " count (orseunid.usuario.id) "					     + " from OrdemServico os "					     + " inner join os.imovel imo "					     + " inner join os.ordemServicoUnidades orseunid "						 + " inner join os.servicoTipo servtipo "						 + " inner join imo.localidade loca ";				*/								consulta = " select orseunid.usuario.id "					     + " from OrdemServico os "					     + " inner join os.imovel imo "					     + " inner join os.ordemServicoUnidades orseunid "						 + " inner join os.servicoTipo servtipo "						 + " inner join imo.localidade loca ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 5){								consulta = " select os.imovel.id, "						 + " orseunid.usuario.id, "						 + " clieimo.cliente.id, "						 + " count(os.imovel.id), "						 + " count (orseunid.usuario.id), "						 + " count (clieimo.cliente.id) "					     + " from OrdemServico os "					     + " inner join os.imovel imo "					     + " inner join imo.clienteImoveis clieimo "					     + " inner join os.ordemServicoUnidades orseunid "						 + " inner join os.servicoTipo servtipo "						 + " inner join imo.localidade loca ";			}										// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" inner join loca.gerenciaRegional gereg ";			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" inner join loca.unidadeNegocio unineg ";			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" inner join imo.setorComercial setcom ";			}			// Cliente			if(relatorioHelper.getCliente() != null && relatorioHelper.getEscolhaRelatorio() != 5){								consulta +=" inner join imo.clienteImoveis clieimo ";			}			// Usuário			if(relatorioHelper.getUsuario() != null){								consulta +=" inner join orseunid.usuario usua ";			}						consulta +=" where 1=1 ";						if(relatorioHelper.getEscolhaRelatorio() == 1){				if(relatorioHelper.getDataInicioEncerramento() != null && 						relatorioHelper.getDataFimEncerramento() != null){										consulta +=" and os.dataEncerramento between :dataInicialEncerramento and :dataFinalEncerramento ";										parameters.put("dataInicialEncerramento", relatorioHelper.getDataInicioEncerramento());					parameters.put("dataFinalEncerramento", relatorioHelper.getDataFimEncerramento());				}			}else{								consulta +=" and os.dataEncerramento between :dataInicialEncerramento and :dataFinalEncerramento ";								parameters.put("dataInicialEncerramento", relatorioHelper.getDataInicioRecorrencia());				parameters.put("dataFinalEncerramento", relatorioHelper.getDataFimRecorrencia());			}						consulta +=" and os.situacao = 2 "				     + " and servtipo.constanteFuncionalidadeTipoServico = 243 ";						if(relatorioHelper.getEscolhaRelatorio() == 1 ){			    				consulta += " and orseunid.atendimentoRelacaoTipo in (1, 3) ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 2){			    				//consulta += " and orseunid.atendimentoRelacaoTipo in (1, 3) ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 3){				    				consulta += " and orseunid.atendimentoRelacaoTipo = 1 ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 4){				    				consulta += " and orseunid.atendimentoRelacaoTipo = 3 ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 5){			    				consulta += " and orseunid.atendimentoRelacaoTipo = 3 "						  + " and clieimo.clienteRelacaoTipo.id = 2 "						  + " and clieimo.dataFimRelacao is null ";			}						// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" and gereg.id = :gerencia ";				parameters.put("gerencia", relatorioHelper.getGerenciaRegional());			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" and unineg.id = :unidade ";				parameters.put("unidade", relatorioHelper.getUnidadeNegocio());			}						// Localidade			if(relatorioHelper.getLocalidade() != null){								consulta +=" and loca.id = :localidade ";				parameters.put("localidade", relatorioHelper.getLocalidade());			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" and setcom.id = :setor ";				parameters.put("setor", relatorioHelper.getSetorComercial());			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" and clieimo.clie.id = :cliente ";				parameters.put("cliente", relatorioHelper.getCliente());			}			// Usuário			if(relatorioHelper.getUsuario() != null){									consulta +=" and usua.id = :usuario ";					parameters.put("usuario", relatorioHelper.getUsuario());			}						if(relatorioHelper.getEscolhaRelatorio() == 1){							consulta += " order by os.imovel, os.id ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 2){								consulta += " group by os.imovel.id "						  + " having count(os.imovel.id) > 1 "						  + " order by os.imovel.id ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 3 || relatorioHelper.getEscolhaRelatorio() == 4){				/*				consulta += " group by os.imovel.id, orseunid.usuario.id "						  + " having count(os.imovel.id) > 1 and count(orseunid.usuario.id) > 1 " 						  + " order by os.imovel.id ";				*/								consulta += " group by orseunid.usuario.id "						  + " having count(orseunid.usuario.id) > 1 " 						  + " order by orseunid.usuario.id ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 5){								consulta += " group by os.imovel.id, orseunid.usuario.id, clieimo.cliente.id "						  + " having count(os.imovel.id) > 1 and count(orseunid.usuario.id) > 1 " 						  + " and count(clieimo.cliente.id) > 1 "						  + " order by os.imovel.id ";			}						query = session.createQuery(consulta);						//ITERA OS PARAMETROS E COLOCA 			// OS MESMOS NA QUERY			Set set = parameters.keySet();			Iterator iterMap = set.iterator();			while (iterMap.hasNext()) {					String key = (String) iterMap.next();					if (parameters.get(key) instanceof Set) {						Set setList = (HashSet) parameters.get(key);						query.setParameterList(key, setList);					} else if (parameters.get(key) instanceof Collection) {						Collection collection = (ArrayList) parameters.get(key);						query.setParameterList(key, collection);					}else if (parameters.get(key) instanceof Date) {						Date data = (Date) parameters.get(key);						query.setTimestamp(key, data);					}else {						query.setParameter(key, parameters.get(key));					}			}						retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes.	 *	 * @author Hugo Leonardo	 * @date 28/01/2011	 * 	 * @see opcao = 1 - pagamento	 * @see opcao = 2 - historico	 *	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioReligacaoClientesInadiplentes( 			Integer os, Integer imovel, Date dataEncerramentoOS, Integer tipo) throws ErroRepositorioException {				Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";					try {						if(tipo == 1){					consulta = " SELECT contas11_.cnta_id as conta "						 + " FROM faturamento.conta contas11_ "						 + " WHERE contas11_.imov_id = :imovel "					     + " AND ( contas11_.dcst_idatual IN ( 0 , 1 , 2 ) ) "					     + " AND contas11_.cnta_dtvencimentoconta <= :dataEncerramentoOS "					     + " AND ( "					     + " 	EXISTS ( "					     + " 		SELECT pag1.pgmt_id "					     + " 		FROM arrecadacao.pagamento pag1 "					     + " 		WHERE pag1.cnta_id = contas11_.cnta_id "					     					     + " 		AND pag1.pgmt_dtpagamento > :dataEncerramentoOS "					     + " 		) "					     + "	OR "					     + "  	NOT EXISTS ( "					     + " 		SELECT pag.pgmt_id "					     + " 		FROM arrecadacao.pagamento pag "					     + " 		WHERE pag.cnta_id = contas11_.cnta_id "					     + " 	 ) "					     + " ) "					     + " order by contas11_.cnta_id ";			}else{								consulta = " SELECT contas11_.cnta_id as conta "					 + " FROM faturamento.conta_historico contas11_ "					 + " WHERE contas11_.imov_id = :imovel "				     + " AND ( contas11_.dcst_idatual IN ( 0 , 1 , 2 ) ) "				     + " AND contas11_.cnhi_dtvencimentoconta <= :dataEncerramentoOS "				     + " AND ( "				     + " 	EXISTS ( "				     + " 		SELECT pag1.pghi_id "				     + " 		FROM arrecadacao.pagamento_historico pag1 "				     + " 		WHERE pag1.cnta_id = contas11_.cnta_id "					     				     + " 		AND pag1.pghi_dtpagamento > :dataEncerramentoOS "				     + " 		) "				     + " ) "				     + " order by contas11_.cnta_id ";			}						retorno = session.createSQLQuery(consulta)				.addScalar("conta", Hibernate.INTEGER)				.setInteger("imovel", imovel)				.setDate("dataEncerramentoOS", dataEncerramentoOS)				.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes.	 *	 * @author Hugo Leonardo	 * @date 31/01/2011	 *	 * @throws ErroRepositorioException	 */	public Collection<OrdemServico> pesquisarRelatorioReligacaoClientesInadiplentes( Collection<Integer> idsOS) throws ErroRepositorioException {				Session session = HibernateUtil.getSession();		String consulta = "";			Collection<OrdemServico> retornoConsulta = new ArrayList();				try {						consulta = " SELECT os "				     + " FROM OrdemServico os "				     + " inner join fetch os.imovel imo "					 + " WHERE os.id in (:idsOS) "					 + " ORDER BY imo.id ";						if(idsOS.size() > 999){								System.out.println("## TAMANHO TOTAL = " + idsOS.size());								List<List<Integer>> particoes = CollectionUtil.particao((List<Integer>) idsOS, 999);								int qtdQuebras = 999;				int indice = idsOS.size() / qtdQuebras;                                   				if (idsOS.size() % qtdQuebras != 0){					indice ++;				}								System.out.println("## QUANTIDADE PARTIÇÕES = " + indice);								for (int i = 0; i < indice; i++) {					System.out.println("## TAMANHO PARTIÇÃO DE INDICE  " + indice +" = " + particoes.get(i).size());										Collection<OrdemServico> retornoConsultaParte = null;											retornoConsultaParte = session.createQuery(consulta).setParameterList(						"idsOS", particoes.get(i)).list();										retornoConsulta.addAll(retornoConsultaParte);										}								} else {				retornoConsulta = session.createQuery(consulta).setParameterList(						"idsOS", idsOS).list();			}					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retornoConsulta;	}		/**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes	 *	 * @author Hugo Leonardo	 * @date 01/02/2011	 *	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioReligacaoClientesInadiplentesRecorrentes( 			Integer imovel, FiltrarRelatorioReligacaoClientesInadiplentesHelper relatorioHelper) 	throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";			Query query = null;		Map parameters = new HashMap();				try {						consulta = " select distinct (os.id) "				     + " from OrdemServico os "				     + " inner join os.imovel imo "				     + " inner join os.ordemServicoUnidades orseunid "					 + " inner join os.servicoTipo servtipo "					 + " inner join imo.localidade loca ";						// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" inner join loca.gerenciaRegional gereg ";			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" inner join loca.unidadeNegocio unineg ";			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" inner join imo.setorComercial setcom ";			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" inner join imo.clienteImoveis clieimo ";			}			// Usuário			if(relatorioHelper.getUsuario() != null){								consulta +=" inner join orseunid.usuario usua ";			}						consulta +=" where imo.id = :imovel ";			parameters.put("imovel", imovel);						if(relatorioHelper.getEscolhaRelatorio() == 1){								if(relatorioHelper.getDataInicioEncerramento() != null && 						relatorioHelper.getDataFimEncerramento() != null){										consulta +=" and os.dataEncerramento between :dataInicialEncerramento and :dataFinalEncerramento ";										parameters.put("dataInicialEncerramento", relatorioHelper.getDataInicioEncerramento());					parameters.put("dataFinalEncerramento", relatorioHelper.getDataFimEncerramento());				}			}else{								if(relatorioHelper.getDataInicioRecorrencia() != null && 						relatorioHelper.getDataFimRecorrencia() != null){										consulta +=" and os.dataEncerramento between :dataInicialRecorrencia and :dataFinalRecorrencia ";										parameters.put("dataInicialRecorrencia", relatorioHelper.getDataInicioRecorrencia());					parameters.put("dataFinalRecorrencia", relatorioHelper.getDataFimRecorrencia());				}			}						consulta +=" and os.situacao = 2 "				     + " and servtipo.constanteFuncionalidadeTipoServico = 243 " 					 + " and orseunid.atendimentoRelacaoTipo.id in (1, 3) ";						// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" and gereg.id = :gerencia ";				parameters.put("gerencia", relatorioHelper.getGerenciaRegional());			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" and unineg.id = :unidade ";				parameters.put("unidade", relatorioHelper.getUnidadeNegocio());			}						// Localidade			if(relatorioHelper.getLocalidade() != null){								consulta +=" and loca.id = :localidade ";				parameters.put("localidade", relatorioHelper.getLocalidade());			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" and setcom.id = :setor ";				parameters.put("setor", relatorioHelper.getSetorComercial());			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" and clieimo.cliente.id = :cliente ";				parameters.put("cliente", relatorioHelper.getCliente());			}			// Usuário			if(relatorioHelper.getUsuario() != null){								consulta +=" and usua.id = :usuario ";				parameters.put("usuario", relatorioHelper.getUsuario());			}						consulta += " order by os.id ";						query = session.createQuery(consulta);						//ITERA OS PARAMETROS E COLOCA 			// OS MESMOS NA QUERY			Set set = parameters.keySet();			Iterator iterMap = set.iterator();			while (iterMap.hasNext()) {					String key = (String) iterMap.next();					if (parameters.get(key) instanceof Set) {						Set setList = (HashSet) parameters.get(key);						query.setParameterList(key, setList);					} else if (parameters.get(key) instanceof Collection) {						Collection collection = (ArrayList) parameters.get(key);						query.setParameterList(key, collection);					}else if (parameters.get(key) instanceof Date) {						Date data = (Date) parameters.get(key);						query.setTimestamp(key, data);					}else {						query.setParameter(key, parameters.get(key));					}			}						retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes.	 *	 * @author Hugo Leonardo	 * @date 09/02/2011	 *	 * @throws ErroRepositorioException	 */	public Collection pesquisarRelatorioReligacaoClientesInadiplentesDatasOS( 			FiltrarRelatorioReligacaoClientesInadiplentesHelper relatorioHelper, Integer imovel) 		throws ErroRepositorioException {				Collection<Object[]> retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";			Query query = null;		Map parameters = new HashMap();				try {						consulta = " select distinct(os.dataEncerramento), os.id "				     + " from OrdemServico os "				     + " inner join os.imovel imo "				     + " inner join os.ordemServicoUnidades orseunid "					 + " inner join os.servicoTipo servtipo "					 + " inner join imo.localidade loca ";							// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" inner join loca.gerenciaRegional gereg ";			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" inner join loca.unidadeNegocio unineg ";			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" inner join imo.setorComercial setcom ";			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" inner join imo.clienteImoveis clieimo ";			}			// Usuário			if(relatorioHelper.getUsuario() != null){								consulta +=" inner join orseunid.usuario usua ";			}						consulta +=" where imo.id = :imovel " 					 + " and os.dataEncerramento between :dataInicialEncerramento and :dataFinalEncerramento ";						parameters.put("imovel", imovel);			parameters.put("dataInicialEncerramento", relatorioHelper.getDataInicioRecorrencia());			parameters.put("dataFinalEncerramento", relatorioHelper.getDataFimRecorrencia());						consulta +=" and os.situacao = 2 "				     + " and servtipo.constanteFuncionalidadeTipoServico = 243 " 				     + " and orseunid.atendimentoRelacaoTipo in (1,3) ";						// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" and gereg.id = :gerencia ";				parameters.put("gerencia", relatorioHelper.getGerenciaRegional());			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" and unineg.id = :unidade ";				parameters.put("unidade", relatorioHelper.getUnidadeNegocio());			}						// Localidade			if(relatorioHelper.getLocalidade() != null){								consulta +=" and loca.id = :localidade ";				parameters.put("localidade", relatorioHelper.getLocalidade());			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" and setcom.id = :setor ";				parameters.put("setor", relatorioHelper.getSetorComercial());			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" and clieimo.cliente.id = :cliente ";				parameters.put("cliente", relatorioHelper.getCliente());			}			// Usuário			if(relatorioHelper.getUsuario() != null){									consulta +=" and usua.id = :usuario ";					parameters.put("usuario", relatorioHelper.getUsuario());			}						consulta += " order by os.dataEncerramento ";						query = session.createQuery(consulta);						//ITERA OS PARAMETROS E COLOCA 			// OS MESMOS NA QUERY			Set set = parameters.keySet();			Iterator iterMap = set.iterator();			while (iterMap.hasNext()) {					String key = (String) iterMap.next();					if (parameters.get(key) instanceof Set) {						Set setList = (HashSet) parameters.get(key);						query.setParameterList(key, setList);					} else if (parameters.get(key) instanceof Collection) {						Collection collection = (ArrayList) parameters.get(key);						query.setParameterList(key, collection);					}else if (parameters.get(key) instanceof Date) {						Date data = (Date) parameters.get(key);						query.setTimestamp(key, data);					}else {						query.setParameter(key, parameters.get(key));					}			}						retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * [UC1120] Gerar Relatório de religação de clientes inadimplentes	 *	 * @author Hugo Leonardo	 * @date 16/02/2011	 *	 * @throws ErroRepositorioException	 */	public Collection pesquisarRecorrenciaPorUsuarioQueAbriuOuEncerrouOS( 			Integer usuario, FiltrarRelatorioReligacaoClientesInadiplentesHelper relatorioHelper) 	throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";			Query query = null;		Map parameters = new HashMap();				try {					consulta = " select os.id, imo.id, os.dataEncerramento "				     + " from OrdemServico os "				     + " inner join os.imovel imo "				     + " inner join os.ordemServicoUnidades orseunid "					 + " inner join os.servicoTipo servtipo "					 + " inner join imo.localidade loca ";						// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" inner join loca.gerenciaRegional gereg ";			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" inner join loca.unidadeNegocio unineg ";			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" inner join imo.setorComercial setcom ";			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" inner join imo.clienteImoveis clieimo ";			}			// Usuário			if(relatorioHelper.getUsuario() != null){								//consulta +=" inner join orseunid.usuario usua ";			}						consulta +=" where orseunid.usuario.id = :usuario ";			parameters.put("usuario", usuario);						if(relatorioHelper.getEscolhaRelatorio() == 1){								if(relatorioHelper.getDataInicioEncerramento() != null && 						relatorioHelper.getDataFimEncerramento() != null){										consulta +=" and os.dataEncerramento between :dataInicialEncerramento and :dataFinalEncerramento ";										parameters.put("dataInicialEncerramento", relatorioHelper.getDataInicioEncerramento());					parameters.put("dataFinalEncerramento", relatorioHelper.getDataFimEncerramento());				}			}else{								if(relatorioHelper.getDataInicioRecorrencia() != null && 						relatorioHelper.getDataFimRecorrencia() != null){										consulta +=" and os.dataEncerramento between :dataInicialRecorrencia and :dataFinalRecorrencia ";										parameters.put("dataInicialRecorrencia", relatorioHelper.getDataInicioRecorrencia());					parameters.put("dataFinalRecorrencia", relatorioHelper.getDataFimRecorrencia());				}			}						consulta +=" and os.situacao = 2 "				     + " and servtipo.constanteFuncionalidadeTipoServico = 243 ";						if(relatorioHelper.getEscolhaRelatorio() == 3){								consulta += " and orseunid.atendimentoRelacaoTipo.id = 1 ";			}			else if(relatorioHelper.getEscolhaRelatorio() == 4){								consulta += " and orseunid.atendimentoRelacaoTipo.id = 3 ";			}			// Gerência Regional			if(relatorioHelper.getGerenciaRegional() != null){								consulta +=" and gereg.id = :gerencia ";				parameters.put("gerencia", relatorioHelper.getGerenciaRegional());			}						// Unidade Negócio			if(relatorioHelper.getUnidadeNegocio() != null){								consulta +=" and unineg.id = :unidade ";				parameters.put("unidade", relatorioHelper.getUnidadeNegocio());			}						// Localidade			if(relatorioHelper.getLocalidade() != null){								consulta +=" and loca.id = :localidade ";				parameters.put("localidade", relatorioHelper.getLocalidade());			}			// Setor Comercial			if(relatorioHelper.getSetorComercial() != null){								consulta +=" and setcom.id = :setor ";				parameters.put("setor", relatorioHelper.getSetorComercial());			}			// Cliente			if(relatorioHelper.getCliente() != null){								consulta +=" and clieimo.cliente.id = :cliente ";				parameters.put("cliente", relatorioHelper.getCliente());			}			// Usuário			if(relatorioHelper.getUsuario() != null){								consulta +=" and orseunid.usuario.id = :usuario ";				parameters.put("usuario", relatorioHelper.getUsuario());			}						consulta += " order by os.id ";						query = session.createQuery(consulta);						//ITERA OS PARAMETROS E COLOCA 			// OS MESMOS NA QUERY			Set set = parameters.keySet();			Iterator iterMap = set.iterator();			while (iterMap.hasNext()) {					String key = (String) iterMap.next();					if (parameters.get(key) instanceof Set) {						Set setList = (HashSet) parameters.get(key);						query.setParameterList(key, setList);					} else if (parameters.get(key) instanceof Collection) {						Collection collection = (ArrayList) parameters.get(key);						query.setParameterList(key, collection);					}else if (parameters.get(key) instanceof Date) {						Date data = (Date) parameters.get(key);						query.setTimestamp(key, data);					}else {						query.setParameter(key, parameters.get(key));					}			}						retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**     * Obtém a coleção de perfis de tipo de serviço para OS.     *      * @author Hugo Azevedo     * @date 22/06/2011     *      * @throws ControladorException     */	public Collection obterColecaoTipoOSgerada() throws ErroRepositorioException{				Session session = HibernateUtil.getSession();		String consulta = "";		Collection retorno = null;				consulta = "SELECT st.id, st.descricao "			     + " FROM ServicoTipo st "			     + " WHERE st.indicadorEmpresaCobranca = :indicador";				try{						retorno = session.createQuery(consulta)							.setInteger("indicador",ConstantesSistema.INDICADOR_USO_ATIVO)							.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;			}		/**	 * 	 * [UC1186] Gerar Relatório Ordem de Serviço Cobrança p/Resultado	 *      * Obtém a coleção de OS a partir dos parâmetros passados pela funcionalidade de Acompanhamento de Cobrança por Resultado.     *      * @author Hugo Azevedo     * @date 27/06/2011     *      * @throws ErroRepositorioException     */		public Collection obterColecaoImovelOSCobrancaResultado(String[] categoriaImovel,													  String[] perfilImovel,													  String[] gerenciaRegional,													  String[] unidadeNegocio,													  String idLocalidadeInicial,													  String idLocalidadeFinal,													  String idSetorComercialInicial,													  String idSetorComercialFinal,													  String idQuadraInicial,													  String idQuadraFinal,													  String tipoServico,													  String comando) throws ErroRepositorioException{						Session sessao = HibernateUtil.getSession();		String consulta = "";		Collection retorno = null;						consulta = "select distinct imcon.id, grc.id, grc.nome, unc.id, unc.nome "				 + "from EmpresaCobrancaConta emcobco "				 //+ "inner join fetch emcobco.contaGeral cong "				// + "inner join fetch cong.conta con "				 + "inner join emcobco.imovel imcon "				 + "inner join imcon.imovelSubcategorias imconsubc "				 + "inner join imconsubc.comp_id.subcategoria subcc "				 + "inner join subcc.categoria catc "				 + "inner join imcon.imovelPerfil ipc "				 + "inner join imcon.localidade locc "				 + "inner join locc.gerenciaRegional grc "				 + "inner join locc.unidadeNegocio unc "				 + "inner join imcon.setorComercial scc "				 + "inner join imcon.quadra qc "				 /*+ "inner join cong.contaHistorico conh "				 + "inner join conh.imovel imconh "				 + "inner join imconh.imovelSubcategorias imconhsubch "				 + "inner join imconhsubch.comp_id.subcategoria subcch  "				 + "inner join subcch.categoria catch "				 + "inner join imconh.imovelPerfil ipch "					 + "inner join imconh.localidade locch "				 + "inner join locch.gerenciaRegional grch "				 + "inner join locch.unidadeNegocio unch "				 + "inner join imconh.setorComercial scch "				 + "inner join imconh.quadra qch "*/			 + "where emcobco.comandoEmpresaCobrancaConta = :comando  and imcon.indicadorExclusao = :indicadorExclusao " ;				//Coleção de categorias		if(categoriaImovel != null && categoriaImovel.length > 0){			consulta += "and catc.id in ( :categoria ) ";		}				//Coleção de perfis do imóvel		if(perfilImovel != null && perfilImovel.length > 0){			consulta += "and ipc.id in ( :perfil ) ";				}				//Coleção de gerências regionais		if(gerenciaRegional != null && gerenciaRegional.length > 0){			consulta += "and grc.id in ( :gerenciaR ) ";					}				//Coleção de unidades de negócio		if(unidadeNegocio != null && unidadeNegocio.length > 0){			consulta += "and unc.id in ( :unidadeN ) ";					}				//Localidade inicial e final		if(idLocalidadeInicial != null && !"".equals(idLocalidadeInicial) && idLocalidadeFinal != null && !"".equals(idLocalidadeFinal)){				consulta +="and locc.id between :localidadeI AND :localidadeF ";		}				//Setor comercial inicial e final		if(idSetorComercialInicial != null && !"".equals(idSetorComercialInicial) && idSetorComercialFinal != null && !"".equals(idSetorComercialFinal)){				consulta +="and scc between :setorI AND :setorF ";					}				//Quadra inicial e final		if(idQuadraInicial != null && !"".equals(idQuadraInicial) && idQuadraFinal != null && !"".equals(idQuadraFinal)){							consulta +="and qc between :quadraI AND :quadraF ";					}				//Criando a query		Query query = sessao.createQuery(consulta);				//Inserindo os parâmetros nos seus respectivos campos		query.setString("comando",comando).setInteger("indicadorExclusao", ConstantesSistema.INDICADOR_IMOVEL_ATIVO );		if(categoriaImovel != null && categoriaImovel.length > 0)			query.setParameterList("categoria",categoriaImovel);		if(perfilImovel != null && perfilImovel.length > 0)			query.setParameterList("perfil",perfilImovel);		if(gerenciaRegional != null && gerenciaRegional.length > 0)			query.setParameterList("gerenciaR",gerenciaRegional);		if(unidadeNegocio != null && unidadeNegocio.length > 0)			query.setParameterList("unidadeN",unidadeNegocio);		if(idLocalidadeInicial != null && !"".equals(idLocalidadeInicial) && idLocalidadeFinal != null && !"".equals(idLocalidadeFinal))			query.setInteger("localidadeI",new Integer(idLocalidadeInicial)).setInteger("localidadeF",new Integer(idLocalidadeFinal));		if(idSetorComercialInicial != null && !"".equals(idSetorComercialInicial) && idSetorComercialFinal != null && !"".equals(idSetorComercialFinal))			query.setInteger("setorI",new Integer(idSetorComercialInicial)).setInteger("setorF",new Integer(idSetorComercialFinal));		if(idQuadraInicial != null && !"".equals(idQuadraInicial) && idQuadraFinal != null && !"".equals(idQuadraFinal))			query.setInteger("quadraI",new Integer(idQuadraInicial)).setInteger("quadraF",new Integer(idQuadraFinal));		try{			retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;					}		/**	 * [UC1182] Recepcionar Arquivo TXT Encerramento OS Cobrança	 * 	 * Consulta chamada pelo "[FS0008  Validar Motivo Encerramento]" 	 * 	 * @author Mariana Victor	 * @data 20/06/2011	 */	public Boolean verificarAtendimentoMotivoEncerramento(Integer idMotivoEncerramento) throws ErroRepositorioException {				Integer retorno = null;		Session session = HibernateUtil.getSession();		String consulta;			try{				consulta = " SELECT count(*) AS quantidade " //0				+ "  FROM atendimentopublico.atend_motivo_encmt "				+ "  WHERE amen_id = :idMotivoEncerramento ";						retorno = (Integer) session.createSQLQuery(consulta)				.addScalar("quantidade", Hibernate.INTEGER)				.setInteger("idMotivoEncerramento", idMotivoEncerramento)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					if (retorno != null				&& retorno.compareTo(new Integer(0)) > 0) {			return true;		}				return false;			}
	/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar utilizado para montar toda a estrutura SELECT do relatório	 * de ordem de servico por situação. No SELECT, pode haver uma parâmetro para ser	 * passado na query (caso a situação da OS seja diferente de 8 (TODAS as OS).	 * 	 * As colunas resultantes para o relatório analítico são:	 * 	 * (numeroOS, INTEGER)	 * (matriculaImovel, INTEGER)	 * (tipoServico, STRING)	 * (dataEncerramento, DATE)	 * (naoCobrada, STRING)	 * (valorConsumoFraudado, BIG_DECIMAL)	 * (numeroOS, INTEGER)	 * (valorMulta, BIG_DECIMAL)	 * (motivoEncerramento, STRING)	 * (retornoFiscalizacao, STRING)	 * (parecerEncerramento, STRING)	 * (situacaoOS, STRING)	 * 	 * As colunas resultantes para o relatório sintético são:	 * 	 * (tipoServico, STRING)	 * (motivoEncerramento, STRING)	 * (retornoFiscalizacao, STRING)	 * (situacaoOS, STRING)	 * (quantidade, Integer)	 * 	 * @author Diogo Peixoto	 * @date 02/08/2011	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoSelect(FiltrarRelatorioOSSituacaoHelper helper, boolean boletimGerado, boolean unionFiscalizadas,			String situacao){		StringBuilder sb = new StringBuilder();				if(helper.getOpcaoRelatorio().equals("1")){			sb.append("SELECT ");			sb.append("orse.orse_id AS numeroOS, "); //0 - Número Ordem Serviço			sb.append("imov.imov_id AS matriculaImovel, "); //1 - Matrícula do Imóvel			sb.append("svtp.svtp_dsservicotipo AS tipoServico, "); //2 - Tipo de Serviço			sb.append("orse.orse_tmencerramento AS dataEncerramento, "); //3 - Data Encerramento			sb.append("(CASE WHEN ((SELECT COUNT(*) ");			sb.append("FROM atendimentopublico.ordem_servico orse2 ");			sb.append("INNER JOIN atendimentopublico.fiscaliz_sit_serv_a_cob fzstSit ON fzstSit.fzst_id = orse2.fzst_id ");			sb.append("WHERE NOT EXISTS (SELECT dbtCo.imov_id ");			sb.append("FROM faturamento.debito_a_cobrar dbtCo ");			sb.append("WHERE dbtCo.imov_id = orse2.imov_id AND dbtCo.dbtp_id = fzstSit.dbtp_id AND dbtCo.dbac_tmatudebito = orse2.orse_tmencerramento) ");			sb.append("AND NOT EXISTS (SELECT dbtHist.imov_id ");			sb.append("FROM faturamento.deb_a_cobrar_hist dbtHist ");			sb.append("WHERE dbtHist.imov_id = orse2.imov_id AND dbtHist.dbtp_id = fzstSit.dbtp_id AND dbtHist.dahi_tmatudebito = orse2.orse_tmencerramento) ");			sb.append("AND orse2.orse_id = orse.orse_id) > 0) THEN '*' ");			sb.append("ELSE '' END) AS naoCobrada, ");//4 - Não Cobrada Automaticamente			sb.append("((SELECT dbac.dbac_vldebito AS valorConsumoFraudado ");			sb.append("FROM faturamento.debito_a_cobrar dbac ");			sb.append("INNER JOIN faturamento.debito_tipo dbtp ON dbac.dbtp_id = dbtp.dbtp_id ");			sb.append("WHERE dbac.imov_id = imov.imov_id AND dbac.dbac_tmatudebito = orse.orse_tmencerramento AND dbtp.dbtp_nncodigoconstante = 206) ");			sb.append("UNION ");			sb.append("(SELECT dbach.dahi_vldebito AS valorConsumoFraudado ");			sb.append("FROM faturamento.deb_a_cobrar_hist dbach ");			sb.append("INNER JOIN faturamento.debito_tipo dbtp ON dbach.dbtp_id = dbtp.dbtp_id ");			sb.append("WHERE dbach.imov_id = imov.imov_id AND dbach.dahi_tmatudebito = orse.orse_tmencerramento AND dbtp.dbtp_nncodigoconstante = 206)) ");			sb.append("AS valorConsumoFraudado, ");//5 - Valor do Consumo Fraudado			sb.append("((SELECT dbac.dbac_vldebito AS valorMulta ");			sb.append("FROM faturamento.debito_a_cobrar dbac ");			sb.append("INNER JOIN faturamento.debito_tipo dbtp ON dbac.dbtp_id = dbtp.dbtp_id ");			sb.append("WHERE dbac.imov_id = imov.imov_id AND dbac.dbac_tmatudebito = orse.orse_tmencerramento AND dbtp.dbtp_nncodigoconstante = 205) ");			sb.append("UNION ");			sb.append("(SELECT dbach.dahi_vldebito AS valorMulta ");			sb.append("FROM faturamento.deb_a_cobrar_hist dbach ");			sb.append("INNER JOIN faturamento.debito_tipo dbtp ON dbach.dbtp_id = dbtp.dbtp_id ");			sb.append("WHERE dbach.imov_id = imov.imov_id AND dbach.dahi_tmatudebito = orse.orse_tmencerramento AND dbtp.dbtp_nncodigoconstante = 205)) ");			sb.append("AS valorMulta, ");//6 - Valor da Multa			sb.append("encmt.amen_dsmotivoencerramento AS motivoEncerramento, ");//7 - Motivo Encerramento			sb.append("fzst.fzst_dsfiscalizacaosituacao AS retornoFiscalizacao, ");//8 - Retorno de Fiscalizaçã			sb.append("orse.orse_dsparecerencerramento AS parecerEncerramento ");//9 - Parecer Encerramento		}else{			if(!unionFiscalizadas){				sb.append("SELECT DISTINCT ");				sb.append("temp.numeroOS, ");				sb.append("temp.tipoServico, ");//1 Tipo de Serviço				sb.append("temp.motivoEncerramento, ");//2 - Motivo Encerramento				sb.append("temp.retornoFiscalizacao, ");//3 - Retorno de Fiscalização				//Caso a situação seja todas, pegar do parâmetro a situação da os				if(helper.getSituacaoOS().equals("8")){					sb.append(situacao);				}else{					sb.append("temp.situacaoOS, ");				}//4 - Situação da Ordem de Serviço				sb.append("SUM(temp.quantidade) AS quantidade, ");//5 - Quantidade de OS por tipo/motivo/retorno				sb.append("temp.matriculaImovel ");//				sb.append("temp.numeroOS ");				sb.append("FROM (");			}			sb.append("SELECT DISTINCT ");			sb.append("orse.orse_id AS numeroOS, ");			sb.append("svtp.svtp_dsservicotipo AS tipoServico, ");			sb.append("encmt.amen_dsmotivoencerramento AS motivoEncerramento, ");			sb.append("fzst.fzst_dsfiscalizacaosituacao AS retornoFiscalizacao, ");			if((helper.getSituacaoOS().equals("8") || helper.getSituacaoOS().equals("13")) && situacao != null){				sb.append(situacao);			}			sb.append("1 AS quantidade, ");			sb.append("imov.imov_id AS matriculaImovel ");		}					/*Se a situação da OS for diferente de TODAS, os registros encontrados serão		 * da situação passada no filtro.		 */		if(!helper.getSituacaoOS().equals("8") && !helper.getSituacaoOS().equals("13")){			sb.append(", :situacaoOS AS situacaoOS ");//10 - Situação da Ordem de Serviço		}		return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * O segundo parâmetro (boletimGerado) é um booleano que	 * indica se para um dado grupo de cobrança e um mês referencia	 * foi gerado um boletim de medição.	 * 	 * @author Diogo Peixoto	 * @date 09/06/2011	 * 	 * @param FiltrarRelatorioOSSituacaoHelper	 * @param boletimGerado	 * @return Collection<FiltrarRelatorioOSSituacaoHelper>	 * @throws ErroRepositorioException	 */	public Collection<Object[]> filtrarRelatorioOSSituacao(FiltrarRelatorioOSSituacaoHelper helper, boolean boletimGerado)		throws ErroRepositorioException{		Collection<Object[]> relatorios = new ArrayList<Object[]>();				/*		 * Esse método pesquisa as ordens de serviço por situação. O helper do parâmetro		 * possui a situação da os com os seguintes valores:		 * 		 * 1 Descontadas		 * 2 Encerradas		 * 3 Executadas		 * 4 Fiscalizadas		 * 5 Justificadas		 * 6 Penalizadas por Fiscalização		 * 7 Penalizadas por Decurso de Prazo		 * 8 Todas 		 * 9 Encerradas com Execução		 * 10 Encerradas por Decurso de Prazo		 * 11 Pendentes		 * 12 Fiscalizadas Boletim Não Gerado		 * 13 Todas Boletim Não Gerado		 * 		 */		Session session = HibernateUtil.getSession();		String consulta = "";			Map<String, Object> parameters = new HashMap<String, Object>();		StringBuilder sb = new StringBuilder();		StringBuilder sbParametrosOpcionais = new StringBuilder();		String clausulaWhere = "";		String groupBy = "";		String orderBy = "";				try {			if(!helper.getSituacaoOS().equals("2") && !helper.getSituacaoOS().equals("4")					&& !helper.getSituacaoOS().equals("8") && !helper.getSituacaoOS().equals("13")){				sb.append(this.filtrarRelatorioOSSituacaoSelect(helper, boletimGerado, false, null));				sb.append("FROM atendimentopublico.ordem_servico orse ");			}						//Descontadas			if(helper.getSituacaoOS().equals("1")){				sb.append(this.filtrarRelatorioOSSituacaoDescontadas(helper));				parameters.put("situacaoOS", "DESCONTADAS");			//Encerradas			}else if(helper.getSituacaoOS().equals("2")){				clausulaWhere += " AND orse.orse_cdsituacao = 2 ";			//Executadas			}else if(helper.getSituacaoOS().equals("3")){				sb.append(this.filtrarRelatorioOSSituacaoExecutadas(helper));				parameters.put("situacaoOS", "EXECUTADAS");						//Justificadas			}else if(helper.getSituacaoOS().equals("5")){				sb.append(this.filtrarRelatorioOSSituacaoJustificadas(helper));				parameters.put("situacaoOS", "JUSTIFICADAS");						//Penalizadas por fiscalização				}else if(helper.getSituacaoOS().equals("6")){				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaFiscalizacao(helper));				parameters.put("situacaoOS", "PENALIZADAS POR FISCALIZAÇÃO");							//Penalizadas por Decurso de Prazo			}else if(helper.getSituacaoOS().equals("7")){				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaDecursoPrazo(helper));				parameters.put("situacaoOS", "PENALIZADAS POR DECURSO DE PRAZO");							//Encerradas com Execução			}else if(helper.getSituacaoOS().equals("9")){				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(helper));				clausulaWhere += " AND orse.orse_cdsituacao = 2 AND orse.amen_id != 32 AND encmt.amen_icexecucao = 1 ";				parameters.put("situacaoOS", "ENCERRADAS COM EXECUÇÃO");							//Pendentes			}else if(helper.getSituacaoOS().equals("11")){				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(helper));				clausulaWhere += " AND orse.orse_cdsituacao = 1 ";				parameters.put("situacaoOS", "PENDENTES");						//Fiscalizadas Boletim Não Gerado				}else if(helper.getSituacaoOS().equals("12")){				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(helper));				sb.append("INNER JOIN atendimentopublico.ordem_servico orseRef ON orseRef.orse_idreferencia = orse.orse_id ");				parameters.put("situacaoOS", "FISCALIZADAS");								//Encerradas com decurso de prazo			}else if(helper.getSituacaoOS().equals("10")){				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(helper));				clausulaWhere += " AND orse.orse_cdsituacao = 2 AND orse.amen_id = 32 ";				parameters.put("situacaoOS", "ENCERRADAS COM DECURSO DE PRAZO");			}						if(helper.getOpcaoOSCobranca() != null && helper.getOpcaoOSCobranca().equalsIgnoreCase("naoCobradasAutomaticamente")){				sbParametrosOpcionais.append("INNER JOIN atendimentopublico.fiscaliz_sit_serv_a_cob fiscACobrar ON orse.fzst_id = fiscACobrar.fzst_id ");				clausulaWhere += " AND NOT EXISTS (SELECT dbtCo.imov_id ";				clausulaWhere += "FROM faturamento.debito_a_cobrar dbtCo ";				clausulaWhere += "WHERE dbtCo.imov_id = orse.imov_id AND dbtCo.dbtp_id = fiscACobrar.dbtp_id AND dbtCo.dbac_tmatudebito = orse.orse_tmencerramento) ";				clausulaWhere += " AND NOT EXISTS (SELECT dbtHist.imov_id ";				clausulaWhere += " FROM faturamento.deb_a_cobrar_hist dbtHist ";				clausulaWhere += " WHERE dbtHist.imov_id = orse.imov_id AND dbtHist.dbtp_id = fiscACobrar.dbtp_id AND dbtHist.dahi_tmatudebito = orse.orse_tmencerramento) ";			}						if(helper.getServicoTipo() != null){				clausulaWhere += " AND orse.svtp_id = :servicoTipo ";				parameters.put("servicoTipo", helper.getServicoTipo().getId());			}						boolean existeLocalidade;			existeLocalidade = helper.getLocalidade() != null ? existeLocalidade = true : false;			// Localidade			if(existeLocalidade){				sbParametrosOpcionais.append("INNER JOIN cadastro.localidade loca ON loca.loca_id = imov.loca_id ");				clausulaWhere += " AND loca.loca_id = :idLocalidade ";				parameters.put("idLocalidade", helper.getLocalidade().getId());			}						if(helper.getEloPolo() != null){				// Elo Polo				if(!existeLocalidade){					sbParametrosOpcionais.append("INNER JOIN cadastro.localidade loca ON loca.loca_id = imov.loca_id ");					existeLocalidade = true;				}				clausulaWhere += " AND loca.loca_cdelo = :idEloPolo ";				parameters.put("idEloPolo", helper.getEloPolo().getId());			}						// Gerência Regional			GerenciaRegional gerencia = helper.getGerenciaRegional();			if(gerencia != null){				if(existeLocalidade){					sbParametrosOpcionais.append("INNER JOIN cadastro.gerencia_regional ger ON ger.greg_id = loca.greg_id ");				}else{					sbParametrosOpcionais.append("INNER JOIN cadastro.localidade loca ON loca.loca_id = imov.loca_id ");					sbParametrosOpcionais.append("INNER JOIN cadastro.gerencia_regional ger ON ger.greg_id = loca.greg_id ");					existeLocalidade = true;				}				clausulaWhere += " AND ger.greg_id = :idGerencia ";				parameters.put("idGerencia", gerencia.getId());			}						// Unidade Negócio			UnidadeNegocio unidade = helper.getUnidadeNegocio();			if(unidade != null){				if(existeLocalidade){					sbParametrosOpcionais.append("INNER JOIN cadastro.unidade_negocio uni ON uni.uneg_id = loca.uneg_id ");				}else{					sbParametrosOpcionais.append("INNER JOIN cadastro.localidade loca ON loca.loca_id = imov.loca_id ");					sbParametrosOpcionais.append("INNER JOIN cadastro.unidade_negocio uni ON uni.uneg_id = loca.uneg_id ");				}				clausulaWhere += " AND uni.uneg_id = :idUnidade ";				parameters.put("idUnidade", unidade.getId());			}						// Setor Comercial			if(helper.getSetorComercial() != null){				sbParametrosOpcionais.append("INNER JOIN cadastro.setor_comercial setor ON setor.stcm_id = imov.stcm_id ");				clausulaWhere += " AND setor.stcm_id = :idSetor ";				parameters.put("idSetor", helper.getSetorComercial().getId());			}						// Quadra			if(helper.getQuadra() != null){				sbParametrosOpcionais.append("INNER JOIN cadastro.quadra quadra ON quadra.qdra_id = imov.qdra_id ");				clausulaWhere += " AND quadra.qdra_id = :idQuadra ";				parameters.put("idQuadra", helper.getQuadra().getId());			}						// Considerar o contrato de cobrança no filtro da ordem de serviço			if(helper.getIdContratoCobranca() != null && !helper.getIdContratoCobranca().equals("-1")){				if (helper.getQuadra() == null) {					sbParametrosOpcionais.append("LEFT JOIN cadastro.quadra quadra ON quadra.qdra_id = imov.qdra_id ");				}								sbParametrosOpcionais.append("LEFT JOIN micromedicao.rota rota ON rota.rota_id = (CASE WHEN (imov.rota_idalternativa is not null) THEN imov.rota_idalternativa ELSE quadra.rota_id END) ");				sbParametrosOpcionais.append("INNER JOIN cobranca.cobranca_grupo cg on cg.cbgr_id = (CASE WHEN cb.cbgr_id is not null THEN cb.cbgr_id ELSE rota.cbgr_id END) ");				sbParametrosOpcionais.append("INNER JOIN micromedicao.contrato_empresa_servico cntremp ON cntremp.cese_id = cg.cese_id ");				clausulaWhere += " AND cntremp.cese_id = :idContratoCobranca ";				parameters.put("idContratoCobranca", helper.getIdContratoCobranca());			}						boolean seletiva = helper.getSeletiva() != null && helper.getSeletiva().equals(ConstantesSistema.SIM);			boolean atendimento = helper.getAtendimento() != null && helper.getAtendimento().equals(ConstantesSistema.SIM);			boolean cobranca = helper.getCobranca() != null && helper.getCobranca().equals(ConstantesSistema.SIM);						if (!cobranca || !seletiva || !atendimento) {								if (cobranca && !seletiva && !atendimento) {					clausulaWhere += " AND orse.cbdo_id is not null ";										if (helper.getIndicadorOSSemGrupo() != null && helper.getIndicadorOSSemGrupo().equals("1")) {						clausulaWhere += " AND cb.cbgr_id is null ";					} else {						clausulaWhere += " AND cb.cbgr_id is not null ";					}				} else if (atendimento && !cobranca && !seletiva) {					clausulaWhere += " AND orse.rgat_id is not null ";				} else if (seletiva && !cobranca && !atendimento) {					clausulaWhere += " AND (orse.rgat_id is null AND orse.cbdo_id is null) ";				} else if (cobranca && atendimento && !seletiva) {					clausulaWhere += " AND ((orse.cbdo_id is not null ";										if (helper.getIndicadorOSSemGrupo() != null && helper.getIndicadorOSSemGrupo().equals("1")) {						clausulaWhere += " AND cb.cbgr_id is null ";					} else {						clausulaWhere += " AND cb.cbgr_id is not null ";					}										clausulaWhere += " ) OR orse.rgat_id is not null) ";									} else if (cobranca && seletiva && !atendimento) {					clausulaWhere += " AND ((orse.cbdo_id is not null ";										if (helper.getIndicadorOSSemGrupo() != null && helper.getIndicadorOSSemGrupo().equals("1")) {						clausulaWhere += " AND cb.cbgr_id is null ";					} else {						clausulaWhere += " AND cb.cbgr_id is not null ";					}										clausulaWhere += " ) OR (orse.rgat_id is null AND orse.cbdo_id is null)) ";									} else if (atendimento && seletiva && !cobranca) {					clausulaWhere += " AND (orse.rgat_id is not null OR (orse.rgat_id is null AND orse.cbdo_id is null)) ";				}			} else {				clausulaWhere += " AND (orse.rgat_id is not null OR (orse.cbdo_id is not null ";								if (helper.getIndicadorOSSemGrupo() != null && helper.getIndicadorOSSemGrupo().equals("1")) {					clausulaWhere += " AND cb.cbgr_id is null ";				} else {					clausulaWhere += " AND cb.cbgr_id is not null ";				}								clausulaWhere += " ) OR (orse.rgat_id is null AND orse.cbdo_id is null)) ";			}						// 2.1.5  A informação de Mês/Ano de Referência, para o caso das Ordens de Serviço de origem 			// Seletiva ou Atendimento, filtrará o Mês/Ano de geração da Ordem de Serviço ( ORSE_TMGERACAO da 			// tabela ATENDIMENTOPUBLICO.ORDEM_SERVICO ) . Para o caso de origem Cobrança usará o mesmo 			// critério já previsto hoje.			if (seletiva || atendimento) { //				String dataInicial = Util.formatarAnoMesParaMesAno(helper.getPeriodoReferenciaInicial().intValue());//				String dataFinal = Util.formatarAnoMesParaMesAno(helper.getPeriodoReferenciaFinal().intValue());								Date dataGeracaoInicial = Util.converteStringParaDateHora(helper.getDataReferenciaInicial()+" 00:00:00");				Date dataGeracaoFinal =  Util.converteStringParaDateHora(helper.getDataReferenciaFinal()+" 23:59:59");//				String mesAnoSeguinte = Util.somaMesMesAnoComBarra(mesAnoFinal, 1);				//Date dataGeracaoInicial = Util.formatarMesAnoParaData(mesAnoInicial, "01", "00:00:00");				//Date dataGeracaoFinal = Util.formatarMesAnoParaData(mesAnoFinal, "01", "00:00:00");								clausulaWhere += " AND ";								if (cobranca && helper.getIndicadorOSSemGrupo().equals("2")) {					clausulaWhere += "(";				}								clausulaWhere += " ((orse.orse_tmgeracao BETWEEN :tmGeracaoInicial AND :tmGeracaoFinal) ";								if (cobranca && helper.getIndicadorOSSemGrupo().equals("2")) {					clausulaWhere +=  " OR (cb.cbgr_id IS NOT NULL and orse.cbdo_id is not null)) ";				}								clausulaWhere += ")";				parameters.put("tmGeracaoInicial", dataGeracaoInicial);				parameters.put("tmGeracaoFinal", dataGeracaoFinal);			}						if (helper.getMotivoEncerramento() != null){				clausulaWhere += " AND orse.amen_id IN (:idsMotivoEncerramento)";			}						if (helper.getRetornoFiscalizacao() != null){				clausulaWhere += " AND orse.fzst_id IN (:idsRetornoFiscalizacao)";			}						if(helper.getSituacaoOS().equals("2")){				if(helper.getOpcaoRelatorio().equals("1")){					sb.append("SELECT DISTINCT aux.numeroOS, ");					sb.append("aux.matriculaImovel, ");					sb.append("aux.tipoServico, ");					sb.append("aux.dataEncerramento, ");					sb.append("aux.naoCobrada, ");					sb.append("aux.valorConsumoFraudado, ");					sb.append("aux.valorMulta, ");					sb.append("aux.motivoEncerramento, ");					sb.append("aux.retornoFiscalizacao, ");					sb.append("aux.parecerEncerramento, ");					sb.append("aux.situacaoOS ");				}else if(helper.getOpcaoRelatorio().equals("2")){					sb.append("SELECT DISTINCT aux.tipoServico, ");					sb.append("aux.motivoEncerramento, ");					sb.append("aux.retornoFiscalizacao, ");					sb.append("aux.situacaoOS AS situacaoOS, ");					sb.append("SUM(aux.quantidade) AS quantidade, ");					sb.append("aux.numeroOS, ");					sb.append("aux.matriculaImovel ");				}				sb.append("FROM (");				sb.append(this.filtrarRelatorioOSSituacaoSelect(helper, boletimGerado, true, null));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoExecutadas(helper));				sb.append(sbParametrosOpcionais.toString());				if(!clausulaWhere.trim().equals("")){					sb.append(" WHERE 1 = 1 ");//					clausulaWhere = clausulaWhere.replaceFirst("AND", "");//					clausulaWhere = clausulaWhere.replaceFirst("OR", "");					sb.append(clausulaWhere);				}				sb.append(" UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(helper, boletimGerado, true, null));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoJustificadas(helper));				sb.append(sbParametrosOpcionais.toString());				if(!clausulaWhere.trim().equals("")){					sb.append(" WHERE 1 = 1 ");//					clausulaWhere = clausulaWhere.replaceFirst("AND", "");					sb.append(clausulaWhere);				}				sb.append(") aux");				parameters.put("situacaoOS", "ENCERRADAS");			}else if (helper.getSituacaoOS().equals("4")){				sb.append(this.filtrarRelatorioOSSituacaoSelect(helper, boletimGerado, false, null));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoFiscalizadas(helper, boletimGerado, sbParametrosOpcionais.toString(), clausulaWhere));				parameters.put("situacaoOS", "FISCALIZADAS");			}else if(helper.getSituacaoOS().equals("8") || helper.getSituacaoOS().equals("13")){				sb.append(this.filtrarRelatorioOSSituacaoTodas(helper, boletimGerado, sbParametrosOpcionais.toString(), clausulaWhere));			}else{				sb.append(sbParametrosOpcionais.toString());			}						if(!clausulaWhere.equals("") && !helper.getSituacaoOS().equals("2") && !helper.getSituacaoOS().equals("4")					&& !helper.getSituacaoOS().equals("8") && !helper.getSituacaoOS().equals("13")){				/*				 * Este trecho do código retira o primeiro AND da cláusula where e adiciona espaço em branco				 * na última comparação para não dar erro na query.				 * Ex: 'WHERE AND os.orse_id' => 'WHERE os.orse_id '				 */				sb.append("WHERE 1 = 1 ");				clausulaWhere = clausulaWhere.trim();//				clausulaWhere = clausulaWhere.replaceFirst("AND", "");//				clausulaWhere = clausulaWhere.replaceFirst("OR", "");				clausulaWhere += " ";				sb.append(clausulaWhere);			}						//Caso seja o relatório sintético			if(helper.getOpcaoRelatorio().equals("2") && !helper.getSituacaoOS().equals("8") && !helper.getSituacaoOS().equals("13")){				groupBy += " GROUP BY tipoServico, motivoEncerramento, retornoFiscalizacao, situacaoOS,numeroOS,matriculaImovel ";				orderBy += " ORDER BY tipoServico, motivoEncerramento, retornoFiscalizacao ";								if(!helper.getSituacaoOS().equals("2")){					sb.append(") temp");				}			}						sb.append(groupBy);			sb.append(orderBy);						consulta = sb.toString();			SQLQuery sqlQuery = session.createSQLQuery(consulta);			System.out.println(consulta);			sqlQuery.setInteger("amReferenciaInicial", helper.getPeriodoReferenciaInicial());			sqlQuery.setInteger("amReferenciaFinal", helper.getPeriodoReferenciaFinal());			if (helper.getIdGrupoCobranca() != null && !helper.getIdGrupoCobranca().equals(-1)){				sqlQuery.setInteger("cobrancaGrupoID", helper.getIdGrupoCobranca());			}						if (helper.getMotivoEncerramento() != null){				sqlQuery.setParameterList("idsMotivoEncerramento", helper.getMotivoEncerramento());			}						if (helper.getRetornoFiscalizacao() != null){				sqlQuery.setParameterList("idsRetornoFiscalizacao", helper.getRetornoFiscalizacao());			}						if(helper.getOpcaoRelatorio().equalsIgnoreCase("1")){				sqlQuery = sqlQuery.addScalar("numeroOS",Hibernate.INTEGER).				addScalar("matriculaImovel",Hibernate.INTEGER).				addScalar("tipoServico",Hibernate.STRING).				addScalar("dataEncerramento",Hibernate.DATE).				addScalar("naoCobrada", Hibernate.STRING).				addScalar("valorConsumoFraudado", Hibernate.BIG_DECIMAL).				addScalar("valorMulta", Hibernate.BIG_DECIMAL).				addScalar("motivoEncerramento", Hibernate.STRING).				addScalar("retornoFiscalizacao", Hibernate.STRING).				addScalar("parecerEncerramento", Hibernate.STRING).				addScalar("situacaoOS", Hibernate.STRING);			}else{								sqlQuery = sqlQuery.addScalar("tipoServico",Hibernate.STRING).					addScalar("motivoEncerramento",Hibernate.STRING).					addScalar("retornoFiscalizacao",Hibernate.STRING).					addScalar("situacaoOS",Hibernate.STRING).					addScalar("quantidade",Hibernate.INTEGER).					addScalar("numeroOS",Hibernate.INTEGER).					addScalar("matriculaImovel",Hibernate.INTEGER);			}						//ITERA OS PARAMETROS E COLOCA 			// OS MESMOS NA QUERY			Set<String> set = parameters.keySet();			Iterator<String> iterMap = set.iterator();			while (iterMap.hasNext()) {				String key = iterMap.next();				sqlQuery.setParameter(key, parameters.get(key));			}			relatorios = sqlQuery.list();						System.out.println(consulta);		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		}finally {			HibernateUtil.closeSession(session);		}		return relatorios;	}	private String filtrarRelatorioOSSituacaoTodas(FiltrarRelatorioOSSituacaoHelper filtro, boolean boletimGerado,			String joins, String where){				StringBuilder sb = new StringBuilder();				if(boletimGerado){						if(filtro.getOpcaoRelatorio().equals("1")){				sb.append("SELECT aux4.numeroOS AS numeroOS, ");				sb.append("aux4.matriculaImovel AS matriculaImovel, ");				sb.append("aux4.tipoServico AS tipoServico, ");				sb.append("aux4.dataEncerramento AS dataEncerramento, ");				sb.append("aux4.naoCobrada AS naoCobrada, ");				sb.append("aux4.valorConsumoFraudado AS valorConsumoFraudado, ");				sb.append("aux4.valorMulta AS valorMulta, ");				sb.append("aux4.motivoEncerramento AS motivoEncerramento, ");				sb.append("aux4.retornoFiscalizacao AS retornoFiscalizacao, ");				sb.append("aux4.parecerEncerramento, ");				sb.append("aux4.SITUACAO AS situacaoOS ");				sb.append("FROM (");				sb.append("SELECT aux3.numeroOS, ");				sb.append("aux3.matriculaImovel, ");				sb.append("aux3.tipoServico, ");				sb.append("aux3.dataEncerramento, ");				sb.append("aux3.naoCobrada, ");				sb.append("aux3.valorConsumoFraudado, ");				sb.append("aux3.valorMulta, ");				sb.append("aux3.motivoEncerramento, ");				sb.append("aux3.retornoFiscalizacao, ");				sb.append("aux3.parecerEncerramento, ");				sb.append("min(aux3.Situacao) as SITUACAO ");				sb.append("FROM (");				sb.append("SELECT aux.numeroOS, ");				sb.append("aux.matriculaImovel, ");				sb.append("aux.tipoServico, ");				sb.append("aux.dataEncerramento, ");				sb.append("aux.naoCobrada, ");				sb.append("aux.valorConsumoFraudado, ");				sb.append("aux.valorMulta, ");				sb.append("aux.motivoEncerramento, ");				sb.append("aux.retornoFiscalizacao, ");				sb.append("aux.parecerEncerramento, ");				sb.append("1 AS SITUACAO ");				sb.append("FROM (");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoFiscalizadas(filtro, boletimGerado, joins, where));				sb.append(") aux ");				sb.append("UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 2 AS SITUACAO ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoDescontadas(filtro));				sb.append(joins);				String whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(" UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 3 AS SITUACAO ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoExecutadas(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(" UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 4 AS SITUACAO ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoJustificadas(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(" UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 5 AS SITUACAO ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaFiscalizacao(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(" UNION ALL ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 6 AS SITUACAO ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaDecursoPrazo(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(") aux3 ");				sb.append("GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ");				sb.append("ORDER BY 11, 2 ");				sb.append(") aux4 ");				sb.append("ORDER BY 11, 1 ");			}else if(filtro.getOpcaoRelatorio().equals("2")){				sb.append("SELECT ");				if(filtro.getSituacaoOS().equals("8") || filtro.getSituacaoOS().equals("13")){					sb.append("aux4.numeroOS, ");				}				sb.append("aux4.tipoServico AS tipoServico,  ");				sb.append("aux4.motivoEncerramento AS motivoEncerramento, ");				sb.append("aux4.retornoFiscalizacao AS retornoFiscalizacao, ");				sb.append("aux4.situacaoOS AS situacaoOS, ");				sb.append("aux4.quantidade AS quantidade, ");				sb.append("aux4.matriculaImovel AS matriculaImovel ");				sb.append("FROM( ");				sb.append("SELECT aux3.numeroOS, ");				sb.append("aux3.tipoServico, ");				sb.append("aux3.motivoEncerramento, ");				sb.append("aux3.retornoFiscalizacao, ");				sb.append("min(aux3.situacaoOS) as situacaoOS, ");				sb.append("aux3.quantidade AS quantidade, ");				sb.append("aux3.matriculaImovel AS matriculaImovel ");				sb.append("FROM( ");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "1 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoFiscalizadas(filtro, boletimGerado, joins, where));				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS, matriculaImovel  ");								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "2 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoDescontadas(filtro));				sb.append(joins);				String whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS,matriculaImovel  ");								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "3 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoExecutadas(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS, matriculaImovel  ");								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "4 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoJustificadas(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS, matriculaImovel  ");								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "5 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaFiscalizacao(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS,matriculaImovel  ");								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, "6 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoPenalizadaDecursoPrazo(filtro));				sb.append(joins);				whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);				sb.append(") temp ");				sb.append("GROUP BY numeroOS, tipoServico, motivoEncerramento, retornoFiscalizacao, temp.situacaoOS, matriculaImovel  ");								sb.append(") aux3 ");				if(filtro.getSituacaoOS().equals("8") || filtro.getSituacaoOS().equals("13")){					sb.append("GROUP BY 1, 2, 3, 4, 6,7 ");					sb.append("ORDER BY 1, 2 ");					sb.append(") aux4 ");					sb.append("ORDER BY 5, 2, 3, 4 ");				}else{					sb.append("GROUP BY 1, 2, 3, 5 ");					sb.append("ORDER BY 1, 2 ");					sb.append(") aux4 ");					sb.append("ORDER BY 4, 1, 2, 3, 5");				}			}		}else{			if(filtro.getOpcaoRelatorio().equals("1")){				sb.append("SELECT aux4.numeroOS, ");				sb.append("aux4.matriculaImovel, ");				sb.append("aux4.tipoServico, ");				sb.append("aux4.dataEncerramento, ");				sb.append("aux4.naoCobrada, ");				sb.append("aux4.valorConsumoFraudado, ");				sb.append("aux4.valorMulta, ");				sb.append("aux4.motivoEncerramento, ");				sb.append("aux4.retornoFiscalizacao, ");				sb.append("aux4.parecerEncerramento, ");				sb.append("aux4.SITUACAO AS situacaoOS ");				sb.append("FROM (");				sb.append("SELECT ");				sb.append("aux3.numeroOS, ");				sb.append("aux3.matriculaImovel, ");				sb.append("aux3.tipoServico, ");				sb.append("aux3.dataEncerramento, ");				sb.append("aux3.naoCobrada, ");				sb.append("aux3.valorConsumoFraudado, ");				sb.append("aux3.valorMulta, ");				sb.append("aux3.motivoEncerramento, ");				sb.append("aux3.retornoFiscalizacao, ");				sb.append("aux3.parecerEncerramento, ");				sb.append("min(aux3.situacaoOS) as SITUACAO ");				sb.append("FROM (");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 7 AS situacaoOS ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));				sb.append("INNER JOIN atendimentopublico.ordem_servico orseRef ON orseRef.orse_idreferencia = orse.orse_id ");				sb.append(joins);				String whereTratado = "";				if(!where.trim().equals("")){					sb.append("WHERE 1 = 1 ");					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 8 AS situacaoOS ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));								sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 2 AND orse.amen_id != 32 AND encmt.amen_icexecucao = 1 ");				sb.append(where);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 9 AS situacaoOS ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));								sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 1 ");				sb.append(where);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, false, null));				sb.append(", 10 AS situacaoOS ");				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));								sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 2 AND orse.amen_id = 32 ");				sb.append(where);								sb.append(") aux3 ");				sb.append("GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ");				sb.append("ORDER BY 1, 2 ");				sb.append(") aux4 ORDER	BY 11, 1 ");							}else if(filtro.getOpcaoRelatorio().equals("2")){				sb.append("SELECT ");				if(filtro.getSituacaoOS().equals("8") || filtro.getSituacaoOS().equals("13")){					sb.append("aux4.numeroOS, ");				}				sb.append("aux4.tipoServico, ");				sb.append("aux4.motivoEncerramento, ");				sb.append("aux4.retornoFiscalizacao, ");				sb.append("aux4.SITUACAO AS situacaoOS, ");				sb.append("aux4.quantidade AS quantidade, ");				sb.append("aux4.matriculaImovel AS matriculaImovel ");				sb.append("FROM (");				sb.append("SELECT ");				sb.append("aux3.numeroOS, ");				sb.append("aux3.tipoServico, ");				sb.append("aux3.motivoEncerramento, ");				sb.append("aux3.retornoFiscalizacao, ");				sb.append("min(aux3.situacaoOS) AS SITUACAO, ");				sb.append("aux3.quantidade AS quantidade, ");				sb.append("aux3.matriculaImovel AS matriculaImovel ");				sb.append("FROM (");				sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, true, " 7 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));				sb.append("INNER JOIN atendimentopublico.ordem_servico orseRef ON orseRef.orse_idreferencia = orse.orse_id ");				sb.append(joins);				String whereTratado = "";				if(!where.trim().equals("")){					whereTratado = where.trim();//					whereTratado = whereTratado.replaceFirst("AND", "");//					whereTratado = whereTratado.replaceFirst("OR", "");					sb.append("WHERE 1 = 1 ");					whereTratado += " ";				}				sb.append(whereTratado);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, true, " 8 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));				sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 2 AND orse.amen_id != 32 AND encmt.amen_icexecucao = 1 ");				sb.append(where);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, true, " 9 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));				sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 1 ");				sb.append(where);								sb.append(" UNION ALL ");								sb.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, true, " 10 AS situacaoOS, "));				sb.append("FROM atendimentopublico.ordem_servico orse ");				sb.append(this.filtrarRelatorioOSSituacaoBoletimNaoGerado(filtro));				sb.append(joins);				sb.append("WHERE orse.orse_cdsituacao = 2 AND orse.amen_id = 32 ");				sb.append(where);								if(filtro.getSituacaoOS().equals("8") || filtro.getSituacaoOS().equals("13")){					sb.append(") aux3 GROUP BY 1, 2, 3, 4, 6,7 ");					sb.append(") aux4 ORDER BY 5, 2, 3, 4, 1 ");				}else{					sb.append(") aux3 GROUP BY 1, 2, 3 ");										sb.append(") aux4 ORDER BY 4, 1, 2, 3 ");				}			}		}				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoDescontadas(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();		sb.append("LEFT JOIN cobranca.cobr_boletim_desc desco ON desco.orse_id = orse.orse_id ");		sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoExecutadas(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();		sb.append("LEFT JOIN cobranca.cobr_boletim_exec execu ON execu.orse_id = orse.orse_id ");		sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON execu.cobm_id = cb.cobm_id AND ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoJustificadas(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();		sb.append("LEFT JOIN cobranca.cobranca_documento cbdo ON cbdo.cbdo_id = orse.cbdo_id AND orse.orse_cdsituacao = 2 ");		sb.append("LEFT JOIN cobranca.cobranca_acao_ativ_crg caac ON caac.caac_id = cbdo.caac_id ");		sb.append("LEFT JOIN cobranca.cobranca_acao_cronograma cbcr ON cbcr.cbcr_id = caac.cbcr_id ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("LEFT JOIN cobranca.cobranca_grupo_crg_mes cb ON cb.cbcm_id = cbcr.cbcm_id AND cb.cbgr_id = :cobrancaGrupoID ");			sb.append("AND cb.cbcm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("LEFT JOIN cobranca.cobranca_grupo_crg_mes cb ON cb.cbcm_id = cbcr.cbcm_id ");			sb.append("AND cb.cbcm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("INNER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id AND encmt.amen_icexecucao = 2 ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoBoletimNaoGerado(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();				sb.append("LEFT JOIN cobranca.cobranca_documento cbdo ON cbdo.cbdo_id = orse.cbdo_id ");		sb.append("LEFT JOIN cobranca.cobranca_acao_ativ_crg caac ON caac.caac_id = cbdo.caac_id ");		sb.append("LEFT JOIN cobranca.cobranca_acao_cronograma cbcr ON cbcr.cbcr_id = caac.cbcr_id ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("LEFT JOIN cobranca.cobranca_grupo_crg_mes cb ON cb.cbcm_id = cbcr.cbcm_id AND cb.cbgr_id = :cobrancaGrupoID ");			sb.append("AND cb.cbcm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("LEFT JOIN cobranca.cobranca_grupo_crg_mes cb ON cb.cbcm_id = cbcr.cbcm_id ");			sb.append("AND cb.cbcm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoPenalizadaFiscalizacao(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();		sb.append("LEFT JOIN cobranca.cob_ac_os_nao_aceitas naoAc ON naoAc.orse_id = orse.orse_id AND naoAc.caon_icaceita = 2 ");		sb.append("LEFT JOIN cobranca.cobr_boletim_desc desco ON desco.orse_id = naoAc.orse_id ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			sb.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			sb.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @return String	 */	private String filtrarRelatorioOSSituacaoPenalizadaDecursoPrazo(FiltrarRelatorioOSSituacaoHelper filtro){		StringBuilder sb = new StringBuilder();		sb.append("LEFT JOIN cobranca.cobr_boletim_desc desco ON desco.orse_id = orse.orse_id ");		sb.append("AND desco.orse_id NOT IN (SELECT orse_id FROM cobranca.cob_ac_os_nao_aceitas naoAc) ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			sb.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			sb.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");				return sb.toString();	}		/**	 * [UC1177] Gerar Relatório de Ordens de Serviço por Situação	 * 	 * Método auxiliar para a geração do relatório de ordem de serviço	 * por situação.	 * 	 * @param filtro	 * @param boletimGerado	 * @return String	 */	private String filtrarRelatorioOSSituacaoFiscalizadas(FiltrarRelatorioOSSituacaoHelper filtro, boolean boletimGerado,			String joins, String where){		StringBuilder sb = new StringBuilder();		StringBuilder join = new StringBuilder();		String whereTratado = ""; 						sb.append("LEFT JOIN atendimentopublico.ordem_servico orseRef ON orseRef.orse_idreferencia = orse.orse_id ");		sb.append("LEFT OUTER JOIN cobranca.cobr_boletim_exec execu ON execu.orse_id = orse.orse_id ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON execu.cobm_id = cb.cobm_id AND ");			sb.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			sb.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON execu.cobm_id = cb.cobm_id AND ");			sb.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		sb.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		sb.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");		sb.append(joins);		if(!where.trim().equals("")){			sb.append("WHERE 1 = 1 ");//			whereTratado = where.replaceFirst("AND", "");			sb.append(where);		}		sb.append("UNION ");		join.append(this.filtrarRelatorioOSSituacaoSelect(filtro, boletimGerado, true, "1 AS situacaoOS, "));		join.append("FROM atendimentopublico.ordem_servico orse ");		join.append("LEFT JOIN atendimentopublico.ordem_servico orseRef ON orseRef.orse_idreferencia = orse.orse_id ");		join.append("LEFT OUTER JOIN cobranca.cobr_boletim_desc desco ON desco.orse_id = orse.orse_id ");		if (filtro.getIdGrupoCobranca() != null && !filtro.getIdGrupoCobranca().equals(-1)){			join.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			join.append("cb.cbgr_id = :cobrancaGrupoID AND cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}else{			join.append("LEFT JOIN cobranca.cobr_boletim_medicao cb ON desco.cobm_id = cb.cobm_id AND ");			join.append("cb.cobm_amreferencia BETWEEN :amReferenciaInicial AND :amReferenciaFinal ");		}		join.append("LEFT JOIN cadastro.imovel imov ON orse.imov_id = imov.imov_id ");		join.append("LEFT OUTER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = orse.svtp_id ");		join.append("LEFT OUTER JOIN atendimentopublico.atend_motivo_encmt encmt ON encmt.amen_id = orse.amen_id ");		join.append("LEFT OUTER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = orse.fzst_id ");		join.append(joins);		if(!where.trim().equals("")){			join.append("WHERE 1 = 1 ");//			whereTratado = where.replaceFirst("AND", "");			join.append(where);		}		sb.append(join.toString());		return sb.toString();	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * O segundo parâmetro (relatorioDefinitivo) é um booleano que	 * indica se o relatório é definitivo ou não, pois o resultado	 * da query é diferente para os relatórios definitivos e os	 * não-definitivos	 * 	 * @author Diogo Peixoto	 * @date 26/07/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 * @param relatorioDefinitivo	 * @return Collection<Object[]>	 * @throws ErroRepositorioException	 */	public Collection<Object[]> filtrarRelatorioAcompanhamentoBoletimMedicao(			FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro, boolean relatorioDefinitivo) throws ErroRepositorioException{				Collection<Object[]> relatorios = new ArrayList<Object[]>();		Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();				try {			sb.append(" SELECT itensServico.idItemServico, ");			sb.append(" itensServico.descricaoServico,  ");			sb.append(" itensServico.quantidadeOrcada,  ");			sb.append(" itensServico.valorUnitario,  ");			sb.append(" sum(itensServico.quantidade) as quantidadeItem, "); 			sb.append(" (itensServico.valorUnitario * sum(itensServico.quantidade)) as valorItem, ");			sb.append(" itensServico.unidadeItem, ");			sb.append(" itensServico.valorOrcado,  ");			sb.append(" sum(itensServico.valorMedidoPeriodo) AS valorMedidoPeriodo, ");			sb.append(" itensServico.cdItemServico AS cdItemServico "); 			sb.append(" FROM (SELECT  ");			sb.append(" itse.itse_id AS idItemServico, "); 			sb.append(" itse.itse_dsitemservico AS descricaoServico,  ");			sb.append(" itsc.itsc_qtorcadaitemservico AS quantidadeOrcada, "); 			sb.append(" 1 AS quantidade,  ");			sb.append(" itsc.itsc_vlitemservcontr AS valorUnitario,  ");			sb.append(" (CASE WHEN itse.itse_cdconstantecalculo IN (3, 7, 9, 11, 13, 4, 8, 10, 12, 14) THEN 'UND'  ");			sb.append(" ELSE '' END) AS unidadeItem, ");			sb.append(" itsc.itsc_vlorcadoitemservico AS valorOrcado,  ");			sb.append(" cbex.cbex_vlservico AS valorMedidoPeriodo, ");			sb.append(" itse.itse_cdconstantecalculo AS cdItemServico  ");			sb.append(" FROM cobranca.cobr_boletim_exec cbex ");			sb.append(" INNER JOIN cobranca.cobr_boletim_medicao cobm ON (cbex.cobm_id = cobm.cobm_id AND cobm.cobm_amreferencia = :amReferencia) ");			sb.append(" INNER JOIN micromedicao.contrato_empresa_servico cese ON (cobm.cese_id = cese.cese_id AND cese.cese_id = :idContrato) ");			sb.append(" INNER JOIN atendimentopublico.ordem_servico orse ON (cbex.orse_id = orse.orse_id) ");			sb.append(" INNER JOIN micromedicao.item_servico_contrato itsc ON (cese.cese_id = itsc.cese_id AND orse.svtp_id = itsc.svtp_id) ");			sb.append(" INNER JOIN micromedicao.item_servico itse ON (itsc.itse_id = itse.itse_id) ");			sb.append(" LEFT OUTER JOIN atendimentopublico.ordem_servico_boletim orbo ON (cbex.orse_id = orbo.orse_id) ");			sb.append(" WHERE (itse.itse_cdconstantecalculo IN (2,6) AND orbo.orbo_icpavimento = 3)  ");			sb.append(" OR (itse.itse_cdconstantecalculo IN (3,7,9,11,13) AND orbo.orbo_icpavimento = 2)  ");			sb.append(" OR (itse.itse_cdconstantecalculo IN (4,8,10,12,14) AND orbo.orbo_icpavimento = 1)  ");			sb.append(" OR (itse.itse_cdconstantecalculo IN (1,5))  ");			sb.append(" ORDER BY idItemServico) itensServico  ");			sb.append(" GROUP BY idItemServico, cdItemServico, descricaoServico, quantidadeOrcada, valorUnitario, unidadeItem, valorOrcado  ");			sb.append(" UNION ");			sb.append(" SELECT itensServico.idItemServico,  ");			sb.append(" itensServico.descricaoServico,  ");			sb.append(" itensServico.quantidadeOrcada,  ");			sb.append(" itensServico.valorUnitario,  ");			sb.append(" sum(itensServico.quantidade) as quantidadeItem,  ");			sb.append(" (itensServico.valorUnitario * sum(itensServico.quantidade)) as valorItem,  ");			sb.append(" itensServico.unidadeItem,  ");			sb.append(" itensServico.valorOrcado,  ");			sb.append(" (itensServico.valorUnitario * sum(itensServico.quantidade)) AS valorMedidoPeriodo, ");			sb.append(" itensServico.cdItemServico  ");			sb.append(" FROM (SELECT  ");			sb.append(" itse.itse_id AS idItemServico, ");			sb.append(" itse.itse_dsitemservico AS descricaoServico,  ");			sb.append(" itsc.itsc_qtorcadaitemservico AS quantidadeOrcada,  ");			sb.append(" (CASE WHEN itse.itse_cdconstantecalculo = 15 THEN orbo.orbo_nnrepasfalto  ");			sb.append(" WHEN itse.itse_cdconstantecalculo = 16 THEN orbo.orbo_nnrepparalelo  ");			sb.append(" WHEN itse.itse_cdconstantecalculo = 17 THEN orbo.orbo_nnrepcalcada END) AS quantidade, ");			sb.append(" itsc.itsc_vlitemservcontr AS valorUnitario,  ");			sb.append(" (CASE WHEN itse.itse_cdconstantecalculo IN (15, 16, 17) THEN 'M2'  ");			sb.append(" ELSE '' END) AS unidadeItem,  ");			sb.append(" itsc.itsc_vlorcadoitemservico AS valorOrcado,  ");			sb.append(" itsc.itsc_vlitemservcontr AS valorMedidoPeriodo, ");			sb.append(" itse.itse_cdconstantecalculo AS cdItemServico ");			sb.append(" FROM cobranca.cobr_boletim_exec cbex  ");			sb.append(" INNER JOIN cobranca.cobr_boletim_medicao cobm ON (cbex.cobm_id = cobm.cobm_id AND cobm.cese_id = :idContrato AND cobm.cobm_amreferencia = :amReferencia )  ");     			sb.append(" INNER JOIN micromedicao.item_servico_contrato itsc ON (cobm.cese_id = itsc.cese_id) 	");			sb.append(" INNER JOIN micromedicao.item_servico itse ON (itsc.itse_id = itse.itse_id)  ");			sb.append(" LEFT OUTER JOIN atendimentopublico.ordem_servico_boletim orbo ON (cbex.orse_id = orbo.orse_id) ");			sb.append(" WHERE itse.itse_cdconstantecalculo > 14 ");			sb.append(" ORDER BY idItemServico) itensServico  ");			sb.append(" GROUP BY idItemServico, cdItemServico, descricaoServico, quantidadeOrcada, valorUnitario, unidadeItem, valorOrcado "); 			sb.append(" ORDER BY idItemServico  ");						SQLQuery sqlQuery = session.createSQLQuery(sb.toString());						sqlQuery = sqlQuery.addScalar("idItemServico",Hibernate.INTEGER).			addScalar("descricaoServico",Hibernate.STRING).			addScalar("quantidadeOrcada",Hibernate.BIG_DECIMAL).			addScalar("valorUnitario",Hibernate.BIG_DECIMAL).			addScalar("quantidadeItem", Hibernate.INTEGER).			addScalar("valorItem", Hibernate.BIG_DECIMAL).			addScalar("unidadeItem", Hibernate.STRING).			addScalar("valorOrcado", Hibernate.BIG_DECIMAL).			addScalar("valorMedidoPeriodo", Hibernate.BIG_DECIMAL).			addScalar("cdItemServico",Hibernate.INTEGER);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						relatorios = sqlQuery.list();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return relatorios;	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * Método que vai retornar as quantidades acumuladas e os valores acumulados	 * no período para geração do relatório de acompanhamento do boletim de medição.	 * 	 * @author Diogo Peixoto	 * @date 01/08/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 * @param relatorioDefinitivo	 * @return Collection<Object[]>	 * @throws ErroRepositorioException	 */	public Collection<Object[]> filtrarRelatorioAcompanhamentoBoletimMedicaoAcumuladas(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) 	throws ErroRepositorioException{				Collection<Object[]> relatorios = new ArrayList<Object[]>();		Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();				try {			sb.append(" SELECT itensServico.idItemServico, ");			sb.append("   itensServico.descricaoServico, ");			sb.append("   sum(itensServico.quantidade) as quantidadeAcumuladaPeriodo, "); 			sb.append("   sum(itensServico.valorMedidoPeriodo) AS valorAcumuladoPeriodo  ");			sb.append(" FROM (SELECT  ");			sb.append("      itse.itse_id AS idItemServico, ");  			sb.append("      itse.itse_dsitemservico AS descricaoServico, ");			sb.append("      1 AS quantidade,  ");			sb.append("      cbex.cbex_vlservico AS valorMedidoPeriodo  ");			sb.append("    	FROM cobranca.cobr_boletim_exec cbex ");			sb.append("         INNER JOIN cobranca.cobr_boletim_medicao cobm ON (cbex.cobm_id = cobm.cobm_id AND cobm.cobm_amreferencia = :amReferencia)");			sb.append("         INNER JOIN micromedicao.contrato_empresa_servico cese ON (cobm.cese_id = cese.cese_id AND cese.cese_id = :idContrato) ");			sb.append("         INNER JOIN atendimentopublico.ordem_servico orse ON (cbex.orse_id = orse.orse_id) ");			sb.append(" 	INNER JOIN micromedicao.item_servico_contrato itsc ON (cese.cese_id = itsc.cese_id AND orse.svtp_id = itsc.svtp_id) ");			sb.append(" 	INNER JOIN micromedicao.item_servico itse ON (itsc.itse_id = itse.itse_id) ");			sb.append(" 	LEFT OUTER JOIN atendimentopublico.ordem_servico_boletim orbo ON (cbex.orse_id = orbo.orse_id) ");			sb.append("     WHERE (itse.itse_cdconstantecalculo IN (2,6) AND orbo.orbo_icpavimento = 3) ");			sb.append("      OR (itse.itse_cdconstantecalculo IN (3,7,9,11,13) AND orbo.orbo_icpavimento = 2)  ");			sb.append("      OR (itse.itse_cdconstantecalculo IN (4,8,10,12,14) AND orbo.orbo_icpavimento = 1)  ");			sb.append("      OR (itse.itse_cdconstantecalculo IN (1,5)) "); 			sb.append("     ORDER BY idItemServico) itensServico  ");			sb.append(" GROUP BY idItemServico, descricaoServico  ");			sb.append(" UNION ");			sb.append(" SELECT itensServico.idItemServico, ");			sb.append("   itensServico.descricaoServico, ");			sb.append("   sum(itensServico.quantidade) as quantidadeAcumuladaPeriodo, ");			sb.append("   (itensServico.valorMedidoPeriodo * sum(itensServico.quantidade)) AS valorAcumuladoPeriodo  ");			sb.append(" FROM (SELECT  ");			sb.append("      itse.itse_id AS idItemServico,  ");			sb.append("      itse.itse_dsitemservico AS descricaoServico,  ");			sb.append("       (CASE WHEN itse.itse_cdconstantecalculo = 15 THEN orbo.orbo_nnrepasfalto  ");			sb.append(" 	WHEN itse.itse_cdconstantecalculo = 16 THEN orbo.orbo_nnrepparalelo  ");			sb.append(" 	WHEN itse.itse_cdconstantecalculo = 17 THEN orbo.orbo_nnrepcalcada END) AS quantidade,   ");			sb.append("      itsc.itsc_vlitemservcontr AS valorMedidoPeriodo  ");			sb.append("     FROM cobranca.cobr_boletim_exec cbex  ");			sb.append(" INNER JOIN cobranca.cobr_boletim_medicao cobm ON (cbex.cobm_id = cobm.cobm_id AND cobm.cese_id = :idContrato AND cobm.cobm_amreferencia = :amReferencia )  ");  			sb.append(" INNER JOIN micromedicao.item_servico_contrato itsc ON (cobm.cese_id = itsc.cese_id) 	");			sb.append(" INNER JOIN micromedicao.item_servico itse ON (itsc.itse_id = itse.itse_id)  ");			sb.append(" LEFT OUTER JOIN atendimentopublico.ordem_servico_boletim orbo ON (cbex.orse_id = orbo.orse_id) ");			sb.append("     WHERE itse.itse_cdconstantecalculo > 14 ");			sb.append("     ORDER BY idItemServico) itensServico  ");			sb.append(" GROUP BY idItemServico, descricaoServico, valorMedidoPeriodo "); 			sb.append(" ORDER BY idItemServico ");						SQLQuery sqlQuery = session.createSQLQuery(sb.toString());						sqlQuery = sqlQuery.addScalar("idItemServico",Hibernate.INTEGER).			addScalar("descricaoServico",Hibernate.STRING).			addScalar("quantidadeAcumuladaPeriodo", Hibernate.INTEGER).			addScalar("valorAcumuladoPeriodo", Hibernate.BIG_DECIMAL);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						relatorios = sqlQuery.list();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return relatorios;	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * @author Diogo Peixoto	 * @date 01/08/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 *	 * @return Collection<BigDecimal>	 * @throws ErroRepositorioException	 */	public Collection<BigDecimal> filtrarRelatorioAcompanhamentoBoletimMedicaoPenalidades(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro,			boolean relatorioDefinitivo) throws ErroRepositorioException{		Collection<BigDecimal> relatorios = null; 		try {			relatorios = this.filtrarRelatorioAcompanhamentoBoletimMedicaoPenalidadesOSFiscalizacao(filtro);			if(relatorioDefinitivo){				relatorios.addAll(this.filtrarRelatorioAcompanhamentoBoletimMedicaoPenalidadesCorteSupressaoNaoRealizacaoServico(filtro));			}		}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		}		return relatorios;	}		/*	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 *	 * Método auxiliar que vai retornar as penalidades de ordem de serviço	 * e as penalidades de fiscalização.	 * 	 * @author Diogo Peixoto	 * @date 01/08/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 *	 * @return Collection<BigDecimal>	 * @throws ErroRepositorioException	 */	private Collection<BigDecimal> filtrarRelatorioAcompanhamentoBoletimMedicaoPenalidadesOSFiscalizacao(			FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) throws ErroRepositorioException{				Collection<Object[]> relatorios = new ArrayList<Object[]>();		Collection<BigDecimal> retorno = new ArrayList<BigDecimal>(); 		Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();				try {			sb.append("SELECT ");			sb.append("SUM((SELECT cbde.cbde_vldesconto ");			sb.append("FROM atendimentopublico.ordem_servico orse ");			sb.append("WHERE orse.orse_id = cbde.orse_id AND orse.amen_id = 32)) AS penalidadeOS, ");//0 - Penalidade OS						sb.append("SUM((SELECT cbde.cbde_vldesconto ");			sb.append("FROM atendimentopublico.ordem_servico orse ");			sb.append("WHERE orse.orse_id = cbde.orse_id AND orse.amen_id != 32)) AS penalidadeFiscalizacao ");//0 - Penalidade Fiscalização						sb.append("FROM cobranca.COBR_BOLETIM_DESC cbde ");			sb.append("INNER JOIN cobranca.cobr_boletim_medicao cobm on (cbde.cobm_id = cobm.cobm_id and cobm.cobm_amreferencia = :amReferencia) ");			sb.append("INNER JOIN micromedicao.CONTRATO_EMPRESA_SERVICO cese on (cobm.cese_id = cese.cese_id and cese.cese_id = :idContrato) ");			SQLQuery sqlQuery = session.createSQLQuery(sb.toString());						sqlQuery = sqlQuery.addScalar("penalidadeOS", Hibernate.BIG_DECIMAL).			addScalar("penalidadeFiscalizacao", Hibernate.BIG_DECIMAL);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						relatorios = sqlQuery.list();						Object[] penalidades = relatorios.iterator().next();			BigDecimal penalidadeOS = new BigDecimal("0.00");			if(penalidades[0] != null){				penalidadeOS = (BigDecimal) penalidades[0];			}			BigDecimal penalidadeFiscalizacao = new BigDecimal("0.00");			if(penalidades[1] != null){				penalidadeFiscalizacao = (BigDecimal) penalidades[1];			}			retorno.add(penalidadeOS);			retorno.add(penalidadeFiscalizacao);		}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}		/*	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 *	 * Método auxiliar que vai retornar as penalidades de ordem de serviço	 * e as penalidades de fiscalização.	 * 	 * @author Diogo Peixoto	 * @date 01/08/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 *	 * @return Collection<BigDecimal>	 * @throws ErroRepositorioException	 */	private Collection<BigDecimal> filtrarRelatorioAcompanhamentoBoletimMedicaoPenalidadesCorteSupressaoNaoRealizacaoServico(			FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) throws ErroRepositorioException{				Collection<Object[]> relatorios = new ArrayList<Object[]>();		Collection<BigDecimal> retorno = new ArrayList<BigDecimal>(); 		Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();				try {			sb.append("SELECT ");			sb.append("SUM((SELECT (cbex.cbex_vlservico) * 2 ");			sb.append("FROM cobranca.motivo_nao_aceit_enc_os mnac ");			sb.append("WHERE caon.mnac_id = mnac.mnac_id and mnac.mnac_nnmultdesccortesupindev IS NOT NULL)) AS penalidadeCorteSupressao, ");			sb.append("SUM((SELECT (cbex.cbex_vlservico) * 2 ");			sb.append("FROM cobranca.motivo_nao_aceit_enc_os mnac ");			sb.append("WHERE caon.mnac_id = mnac.mnac_id and mnac.mnac_nnmultdescservnaoexec IS NOT NULL)) AS penalidadeNaoRealizacaoServico ");			sb.append("FROM cobranca.cobr_boletim_exec cbex ");			sb.append("INNER JOIN cobranca.cobr_boletim_medicao cobm on (cbex.cobm_id = cobm.cobm_id and cobm.cobm_amreferencia = :amReferencia) ");			sb.append("INNER JOIN micromedicao.contrato_empresa_servico cese on (cobm.cese_id = cese.cese_id and cese.cese_id = :idContrato) ");			sb.append("INNER JOIN cobranca.cob_ac_os_nao_aceitas caon on (cbex.orse_id = caon.orse_id) ");			SQLQuery sqlQuery = session.createSQLQuery(sb.toString());						sqlQuery = sqlQuery.addScalar("penalidadeCorteSupressao", Hibernate.BIG_DECIMAL).			addScalar("penalidadeNaoRealizacaoServico", Hibernate.BIG_DECIMAL);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						relatorios = sqlQuery.list();						Object[] penalidades = relatorios.iterator().next();			BigDecimal penalidadeCorteSupressao = new BigDecimal("0.00");			if(penalidades[0] != null){				penalidadeCorteSupressao = (BigDecimal) penalidades[0];			}			BigDecimal penalidadeNaoRealizacaoServicos = new BigDecimal("0.00");			if(penalidades[1] != null){				penalidadeNaoRealizacaoServicos = (BigDecimal) penalidades[1];			}			retorno.add(penalidadeCorteSupressao);			retorno.add(penalidadeNaoRealizacaoServicos);					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * @author Diogo Peixoto	 * @date 28/07/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 * @param relatorioDefinitivo	 * @return Quantidade de OS Executadas para determinado boletim de medição	 * @throws ErroRepositorioException	 */	public Integer pesquisarQuantidadeOSExecutadas(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) 		throws ErroRepositorioException{				Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();		Integer qtdeOSExecutadas = 0;				try {			sb.append("SELECT COUNT(execu.orse_id) AS quantidade ");			sb.append("FROM cobranca.cobr_boletim_exec execu ");			sb.append("INNER JOIN cobranca.cobr_boletim_medicao med ON execu.cobm_id = med.cobm_id AND med.cobm_amreferencia = :amReferencia ");			sb.append("AND med.cese_id = :idContrato ");						String consulta = sb.toString();			SQLQuery sqlQuery = session.createSQLQuery(consulta);				sqlQuery = sqlQuery.addScalar("quantidade",Hibernate.INTEGER);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						qtdeOSExecutadas = (Integer) sqlQuery.uniqueResult();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return qtdeOSExecutadas;	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * @author Diogo Peixoto	 * @date 28/07/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 * @param relatorioDefinitivo	 * @return Quantidade de OS Penalizadas para determinado boletim de medição	 * @throws ErroRepositorioException	 */	public Integer pesquisarQuantidadeOSPenalizadas(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) 		throws ErroRepositorioException{				Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();		Integer qtdeOSPenalizadas = 0;				try {			sb.append("SELECT COUNT(desco.orse_id) AS quantidade ");			sb.append("FROM cobranca.cobr_boletim_desc desco ");			sb.append("INNER JOIN cobranca.cobr_boletim_medicao med ON med.cobm_id = desco.cobm_id AND med.cobm_amreferencia = :amReferencia ");			sb.append("AND med.cese_id = :idContrato ");						String consulta = sb.toString();			SQLQuery sqlQuery = session.createSQLQuery(consulta);				sqlQuery = sqlQuery.addScalar("quantidade",Hibernate.INTEGER);							sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());			sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());						qtdeOSPenalizadas = (Integer) sqlQuery.uniqueResult();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return qtdeOSPenalizadas;	}		/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * @author Diogo Peixoto	 * @date 01/08/2011	 * 	 * @param FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper	 * @return Taxa de Sucesso do Boletim de Medição	 * 	 * @throws ErroRepositorioException	 */	public BigDecimal pesquisarTaxaSucessoBoletimMedicao(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) throws ErroRepositorioException{				Session session = HibernateUtil.getSession();		StringBuilder sb = new StringBuilder();		BigDecimal taxaSucesso = new BigDecimal("0.00");				try {			sb.append("SELECT sum(cbsu.CBSU_VLTXSUCESSO) AS taxaSucesso ");			sb.append("FROM cobranca.COBR_BOLETIM_SUCESSO cbsu ");			sb.append("INNER JOIN cobranca.cobr_boletim_medicao cobm on (cbsu.cobm_id = cobm.cobm_id and cobm.cobm_amreferencia = :amReferencia) ");			sb.append("INNER JOIN micromedicao.contrato_empresa_servico cese on (cobm.cese_id = cese.cese_id and cese.cese_id = :idContrato) ");						String consulta = sb.toString();			SQLQuery sqlQuery = session.createSQLQuery(consulta);				sqlQuery = sqlQuery.addScalar("taxaSucesso",Hibernate.BIG_DECIMAL);								sqlQuery.setInteger("amReferencia", filtro.getMesAnoReferencia());			sqlQuery.setInteger("idContrato", filtro.getIdContratoEmpresaServico());						taxaSucesso = (BigDecimal) sqlQuery.uniqueResult();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return taxaSucesso;	}			/**	 * [UC1178] Gerar Relatório de Acompanhamento dos Boletins de Medição	 * 	 * Método que vai retornar um booleano indicando se o contrato selecionado	 * esta associado a grupos de cobrança.	 * 	 * @author Ana Maria	 * @date 09/07/2014	 * 	 * @return boolean	 * @throws ErroRepositorioException	 */	public boolean existeGruposAssociadoContrato(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro)			throws ErroRepositorioException {				Session session = HibernateUtil.getSession();		String consulta;		Integer quantidade = null;		boolean retorno = false;				try {			consulta = " select count(*) AS quantidade "					 + " from cobranca.cobranca_grupo cbgr "					 + " where cbgr.cese_id = :idContrato ";														quantidade = (Integer) session.createSQLQuery(consulta)					.addScalar("quantidade", Hibernate.INTEGER)					.setInteger("idContrato", filtro.getIdContratoEmpresaServico())					.setMaxResults(1).uniqueResult();			if (quantidade != null && quantidade > 0) {				retorno = true;			}		} catch (HibernateException e) {			// levanta a exceção para a próxima camada			e.printStackTrace();			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			// fecha a sessão			HibernateUtil.closeSession(session);		}		return retorno;			}		public boolean gruposIniciaodsJaForamEncerrados(FiltrarRelatorioAcompanhamentoBoletimMedicaoHelper filtro) 		throws ErroRepositorioException{		Session sessao = HibernateUtil.getSession();				boolean encerrado = true;		StringBuilder sb = new StringBuilder();		sb.append("SELECT acao.caac_tmrealizacao AS dataRealizacao ");		sb.append("FROM cobranca.cobranca_acao_ativ_crg acao ");		sb.append("INNER JOIN cobranca.cobranca_acao_cronograma cron ON cron.cbcr_id = acao.cbcr_id ");		sb.append("INNER JOIN cobranca.cobranca_grupo_crg_mes mes ON mes.cbcm_id = cron.cbcm_id AND mes.cbcm_amreferencia = :amReferencia ");		sb.append("INNER JOIN cobranca.cobranca_grupo grupo ON grupo.cbgr_id = mes.cbgr_id ");		sb.append("INNER JOIN micromedicao.contrato_empresa_servico cont ON cont.cese_id = grupo.cese_id AND grupo.cese_id = :numeroContrato");		SQLQuery query = sessao.createSQLQuery(sb.toString());		query.setInteger("amReferencia", filtro.getMesAnoReferencia());		query.setInteger("numeroContrato", filtro.getIdContratoEmpresaServico());		query.addScalar("dataRealizacao", Hibernate.DATE);				List<Date> retorno = (List<Date>) query.list();		/*Verifica se existe alguma data igual a NULL, se existe é porque os grupos iniciados		 * não foram executados.		 */		for (Date date : retorno) {			if(date == null){				encerrado = false;				break;			}		}		return encerrado;	}			/**	 * [UC1186] Gerar Relatório Ordem de Serviço Cobrança p/Resultado	 * 	 * Pesquisar as Ordens de serviços a partir de seu imóvel e tipo de serviço	 * 	 * @author Hugo Azevedo	 * @data 02/07/2011	 */			public Collection obterOSImovelTipoServico(Integer id, Integer tipoServico) throws ErroRepositorioException {				Session session = HibernateUtil.getSession();		Collection<OrdemServico> retorno = new ArrayList();				try {						Criteria crit = session.createCriteria(OrdemServico.class);			crit.setFetchMode("imovel", FetchMode.JOIN);			crit.setFetchMode("servicoTipo", FetchMode.JOIN);			crit.setFetchMode("atendimentoMotivoEncerramento", FetchMode.JOIN);			crit.add(Restrictions.eq("imovel.id",id));			if(tipoServico != null && tipoServico.intValue() != -1){				crit.add(Restrictions.eq("servicoTipo.id",tipoServico.intValue()));			}						retorno = (Collection<OrdemServico>) crit.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}return retorno;	}			/**	 * 	 * [UC1186] Gerar Relatório Ordem de Serviço Cobrança p/Resultado	 *      * Obtém a quantida de OS a partir dos parâmetros passados pela funcionalidade de Acompanhamento de Cobrança por Resultado.     *      * @author Hugo Azevedo     * @date 27/06/2011     *      * @throws ErroRepositorioException     */		public Collection obterTotalOSColecaoImovelTipoServico(Collection colecaoImovel,Integer tipoServico) throws ErroRepositorioException{				 		Session sessao = HibernateUtil.getSession();		String consulta = "";		Collection retorno = null;				consulta = "select count(os.id) "			      +"from OrdemServico os "			      +"inner join os.imovel imo "			      +"inner join os.servicoTipo st "			      +"where imo.id in ( :colecaoImovel ) ";		if(tipoServico != null && tipoServico.intValue() != -1)			consulta += "and st.id = :tipoServico";				try{			Query query = sessao.createQuery(consulta);			query.setParameterList("colecaoImovel",colecaoImovel);			if(tipoServico != null && tipoServico.intValue() != -1)				query.setInteger("tipoServico",tipoServico);				retorno = query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;			}		/**	 * [UC1189] Inserir Registro de Atendimento Loja Virtual	 * 	 * @author Magno Gouveia	 * @date 12/07/2011	 * 	 * @return	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarSolicitacaoTipoLojaVirtual() throws ErroRepositorioException{				Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;				String consulta = "SELECT "						+ " DISTINCT(sotp.sotp_id) AS idSolicitacao, sotp.sotp_dssolicitacaotipo AS descricao "						+ " FROM atendimentopublico.solicitacao_tipo sotp "						+ " INNER JOIN atendimentopublico.solicitacao_tipo_espec step ON step.sotp_id = sotp.sotp_id " 						+ " WHERE step.step_icuso = 1 " 						+ " 	AND step.step_iclojavirtual = 1 "						+ " ORDER BY sotp.sotp_dssolicitacaotipo"; 				try{			retorno = sessao.createSQLQuery(consulta)							.addScalar("idSolicitacao", Hibernate.SHORT)							.addScalar("descricao", Hibernate.STRING)							.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;			}		/**	 * [UC1196] Exibir Lojas de Atendimento na Loja Virtual	 * [SB0001] Selecionar Municípios da Região	 * 	 * @author Magno Gouveia	 * @date 14/07/2011	 * 	 * @return colecaoDeMunicipios	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarMunicipiosLojaVirtualCompesa() throws ErroRepositorioException {				Session sessao = HibernateUtil.getSession();				Collection<Object[]> retorno = null;				String consulta = "SELECT DISTINCT " 						+ 	 " m.mreg_id     	  AS microrregiao, "						+ 	 " m.muni_id          AS idMunicipio, "						+ 	 " m.muni_nmmunicipio AS municipio "						+ "	FROM cadastro.municipio m "						+ "	INNER JOIN cadastro.bairro b ON b.muni_id = m.muni_id "						+ "	INNER JOIN cadastro.loja_atendimento la ON la.bair_id = b.bair_id "						+ "	WHERE m.muni_icuso = 1 "						+ " ORDER BY m.muni_nmmunicipio";				try{			retorno = sessao.createSQLQuery(consulta)							.addScalar("microrregiao", Hibernate.INTEGER)							.addScalar("idMunicipio", Hibernate.INTEGER)							.addScalar("municipio", Hibernate.STRING)							.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;	}		/**	 * [UC1196] Exibir Lojas de Atendimento na Loja Virtual	 * [SB0002] Exibir Dados da Loja	 * 	 * @author Magno Gouveia	 * @date 14/07/2011	 * 	 * @param id do município	 * @return colecaoDeLojasDeAtendimento	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarLojasDeAtendimentoLojaVirtualCompesa(Integer idMunicipio) throws ErroRepositorioException {				Session sessao = HibernateUtil.getSession();				Collection<Object[]> retorno = null;				String consulta = "SELECT la.loja_nmloja 	      AS nomeLoja, " 						+ 	" l.logr_nmlogradouro         AS logradouro, "						+ 	" la.loja_nnimovel            AS numero, "						+ 	" m.muni_nmmunicipio          AS municipio, "						+ 	" b.bair_nmbairro             AS bairro, "						+ 	" la.loja_dspontorefencia     AS pontoReferencia, "						+ 	" la.loja_cdddd            	  AS ddd, "						+ 	" la.loja_nnfone           	  AS fone, " 						+ 	" la.loja_nnfonefax        	  AS fax, "						+ 	" la.loja_dsemail          	  AS email, "						+ 	" la.loja_imloja           	  AS imagem, "						+ 	" lt.lgtp_dslogradourotipo	  AS logradouroTipo, "						+ 	" ltl.lgtt_dslogradourotitulo AS logradouroTitulo "						+ " FROM cadastro.loja_atendimento la "						+ " INNER JOIN cadastro.bairro b ON b.bair_id      		      = la.bair_id " 						+ " INNER JOIN cadastro.logradouro l ON l.logr_id  		  	  = la.logr_id "						+ " INNER JOIN cadastro.logradouro_tipo lt ON lt.lgtp_id  	  = l.lgtp_id "						+ " LEFT JOIN cadastro.logradouro_titulo ltl ON ltl.lgtt_id  = l.lgtt_id "						+ " INNER JOIN cadastro.municipio m ON m.muni_id   		  	  = b.muni_id "						+ " WHERE m.muni_icuso = 1 "						+   " AND b.bair_icuso = 1 "						+   " AND l.logr_icuso = 1 "						+	" AND m.muni_id    = :idMunicipio "						+ " ORDER BY la.loja_nmloja";				try{			retorno = sessao.createSQLQuery(consulta)							.addScalar("nomeLoja", Hibernate.STRING)							.addScalar("logradouro", Hibernate.STRING)							.addScalar("numero", Hibernate.STRING)							.addScalar("municipio", Hibernate.STRING)							.addScalar("bairro", Hibernate.STRING)							.addScalar("pontoReferencia", Hibernate.STRING)							.addScalar("ddd", Hibernate.STRING)							.addScalar("fone", Hibernate.STRING)							.addScalar("fax", Hibernate.STRING)							.addScalar("email", Hibernate.STRING)							.addScalar("imagem", Hibernate.BLOB)							.addScalar("logradouroTipo", Hibernate.STRING)							.addScalar("logradouroTitulo", Hibernate.STRING)							.setInteger("idMunicipio", idMunicipio)							.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;	}	public Collection obterColecaoOSFiscalizacaoNaoExecutadas() throws ErroRepositorioException{				Session sessao = HibernateUtil.getSession();		String consulta = "";		Collection retorno = new ArrayList();						try{			consulta = " select os.orse_id," +					   " os.orse_tmgeracao " +					   " from atendimentopublico.ordem_servico os" +					   " inner join atendimentopublico.servico_tipo st on os.svtp_id = st.svtp_id" +					   " inner join atendimentopublico.servico_tipo_referencia str on st.strf_id = str.strf_id" +					   " where os.orse_tmencerramento is null" +					   " and os.orse_idreferencia is not null" +					   " and str.strf_icfiscalizacao = :idFiscalizacao";						Query query = sessao.createSQLQuery(consulta)					           .addScalar("orse_id", Hibernate.INTEGER)					           .addScalar("orse_tmgeracao",Hibernate.DATE)					           .setInteger("idFiscalizacao",ConstantesSistema.INDICADOR_USO_ATIVO);					   retorno = query.list();								} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return retorno;			}	/**	 * [UC1199]  Acompanhar Arquivos de Roteiro	 * [SB0003]  Pesquisar Fotos da OS	 * 	 * Método que vai retornar as fotos de uma determinada	 * ordem de serviço passada no parâmetro.	 * 	 * @author Diogo Peixoto	 * @date 12/08/2011	 * 	 * @param Integer - ID da Ordem de Serviço	 * 	 * @return Collection<Object[]> - Coleção das Fotos da OS	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarFotosOrdemServico(Integer idOS) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;		StringBuilder sb = new StringBuilder();				sb.append("SELECT ");		sb.append("osFoto.osft_id AS id, ");//0 - ID Ordem Serviço Foto		sb.append("osFoto.orse_id AS idOS, ");//1 - ID Ordem Serviço		sb.append("osFoto.osft_dsfoto AS descricaoFoto, ");//2 - Descrição Foto		sb.append("osFoto.osft_imfoto AS foto ");//3 - Foto		sb.append("FROM ");		sb.append("atendimentopublico.ordem_servico_foto osFoto ");		sb.append("INNER JOIN atendimentopublico.ordem_servico orse ON orse.orse_id = osFoto.orse_id AND orse.orse_id = :idOS ");		sb.append("ORDER BY idOS,osFoto.fsos_id  ");				try{			Query query = sessao.createSQLQuery(sb.toString())			.addScalar("id", Hibernate.INTEGER)			.addScalar("idOS", Hibernate.INTEGER)			.addScalar("descricaoFoto", Hibernate.STRING)			.addScalar("foto", Hibernate.BINARY)			.setInteger("idOS", idOS);						retorno = query.list();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * [UC1199]  Acompanhar Arquivos de Roteiro	 * [SB0003]  Pesquisar Fotos da OS	 * 	 * Método que vai retornar as fotos de uma determinada	 * ordem de serviço passada no parâmetro.	 * 	 * @author Diogo Peixoto	 * @date 12/08/2011	 * 	 * @param Integer - ID da Foto da Ordem de Serviço	 * 	 * @return Collection<Object[]> - Foto da Ordem de Serviço	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarFotosOrdemServicoPorIdFoto(Integer idFoto) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;		StringBuilder sb = new StringBuilder();				sb.append("SELECT ");		sb.append("osFoto.osft_id AS id, ");//0 - ID Ordem Serviço Foto		sb.append("osFoto.orse_id AS idOS, ");//1 - ID Ordem Serviço		sb.append("osFoto.osft_dsfoto AS descricaoFoto, ");//2 - Descrição Foto		sb.append("osFoto.osft_imfoto AS foto ");//3 - Foto		sb.append("FROM ");		sb.append("atendimentopublico.ordem_servico_foto osFoto ");		sb.append("INNER JOIN atendimentopublico.ordem_servico orse ON orse.orse_id = osFoto.orse_id ");		sb.append("WHERE osFoto.osft_id = :idFoto ");				try{			Query query = sessao.createSQLQuery(sb.toString())			.addScalar("id", Hibernate.INTEGER)			.addScalar("idOS", Hibernate.INTEGER)			.addScalar("descricaoFoto", Hibernate.STRING)			.addScalar("foto", Hibernate.BINARY)			.setInteger("idFoto", idFoto);						retorno = query.list();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}				/**	 * #11015: Funcionalidades para gestão dos "Grandes Clientes"	 * [UC0362] Efetuar Instalação do Hidrômetro / [UC0364] Efetuar Substituição do Hidrômetro	 * 	 * @author Diogo Luiz	 * @date 05/06/2015	 * 	 * @param imovel	 * @param hidrometroInstalacaoHistorico	 * @throws ControladorException	 */	public Integer pesquisarPerfilAssociadoHidrometroCapacidade(Imovel imovel, HidrometroCapacidade hidrometroCapacidade) 			throws ErroRepositorioException{						Session session = HibernateUtil.getSession();		StringBuilder consulta = new StringBuilder();		Integer retorno = null;				try{			consulta.append(" select distinct iper.iper_id as imovel_perfil from cadastro.imovel_perfil iper "); 			consulta.append(" inner join cadastro.imovel_perfil_capac_hidr ipch on ipch.iper_id = iper.iper_id ");			consulta.append(" where ipch.hicp_id = :idCapacidade ");			consulta.append(" and iper.iper_icuso = 1 "); 			consulta.append(" and iper.iper_icperfiltelemedido = (select iper_icperfiltelemedido from cadastro.imovel_perfil iper2 "); 			consulta.append(" 									  inner join cadastro.imovel imov on imov.iper_id = iper2.iper_id "); 			consulta.append(" 									  where imov.imov_id = :idImovel) ");							    							retorno = (Integer)session.createSQLQuery(consulta.toString())						  .addScalar("imovel_perfil", Hibernate.INTEGER)						  .setInteger("idImovel", imovel.getId())						  .setInteger("idCapacidade", hidrometroCapacidade.getId())						  .setMaxResults(1)						  .uniqueResult();							} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}						return retorno;	}			/**	 * Método que pesquisa as ordens seletivas para um	 * determinado comando	 * 	 * [UC 1220] Gerar Arquivo Texto para as Os de Visita	 * [SB 0001] Consultar Ordem de Serviço Seletiva	 * @author Raimundo Martins	 * @date 15/09/2011	 * 	 * @return coleção das ordens de serviços selecionadas	 */	public Collection<Object[]> consultarOrdemServicoSeletiva(String comOrdemSeletiva, String local, 		String setorInicial, String setorFinal, String quadraIni, String quadraFin) throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		Collection<Object[]> retorno = null;		String hql = "SELECT orse.orse_id AS osId, " +				"orse.coss_id AS comandoId, " +				"  imov.loca_id               AS localidade, " +				"  stcm.stcm_cdsetorcomercial AS setorComercial, " +				"  qdra.qdra_nnquadra         AS quadra, " +				"  imov.imov_nnlote           AS lote, " +				"  imov.imov_nnsublote        AS sublote " +				"FROM ATENDIMENTOPUBLICO.ordem_servico orse " +				"INNER JOIN CADASTRO.imovel imov " +				"ON orse.imov_id = imov.imov_id " +				"INNER JOIN CADASTRO.setor_comercial stcm " +				"ON imov.stcm_id = stcm.stcm_id " +				"INNER JOIN CADASTRO.quadra qdra " +				"ON qdra.qdra_id     = imov.qdra_id " +				"WHERE orse.coss_id IS NOT NULL " +				"AND orse.coss_id    = :comandoCod " +				"AND orse.orse_cdsituacao = :situacao "+				"AND orse.svtp_id = :servicoTipo " +				"AND  not exists (select orse_id " +                				 "from ATENDIMENTOPUBLICO.arq_txt_ret_visita_campo arq " +                				 "where orse.orse_id = arq.orse_id)";				if(local !=null && !local.trim().equals("")){			hql+=" AND imov.loca_id    = :localidadeCod ";		}				if((setorInicial !=null && !setorInicial.trim().equals("")) && setorInicial.equals(setorFinal)){			hql +=" AND stcm.stcm_cdsetorcomercial = :setorComercialCod ";		}				else if(setorInicial !=null && setorFinal !=null && !setorInicial.trim().equals("") && !setorFinal.trim().equals("")){			hql +=" AND stcm.stcm_cdsetorcomercial BETWEEN :setorComercialInicial AND :setorComercialFinal ";		}		if(quadraIni !=null && quadraFin !=null && !quadraIni.trim().equals("") && !quadraFin.trim().equals("")){			hql += " AND qdra.qdra_nnquadra BETWEEN :quadraInicial AND :quadraFinal ";		}		try{			Query query = session.createSQLQuery(hql+" ORDER BY localidade, setorComercial, quadra, lote, sublote")					.addScalar("osId", Hibernate.INTEGER)					.addScalar("comandoId", Hibernate.INTEGER)					.addScalar("localidade", Hibernate.INTEGER)					.addScalar("setorComercial", Hibernate.INTEGER)					.addScalar("quadra", Hibernate.INTEGER)					.addScalar("lote", Hibernate.INTEGER)					.addScalar("sublote", Hibernate.INTEGER);						query.setInteger("comandoCod", Integer.parseInt(comOrdemSeletiva))								.setShort("situacao", OrdemServico.SITUACAO_PENDENTE)				.setInteger("servicoTipo", ServicoTipo.TIPO_INSPECAO_ANORMALIDADE);						if(local !=null && !local.trim().equals("")){				query.setInteger("localidadeCod", Integer.parseInt(local));			}						if((setorInicial !=null && !setorInicial.trim().equals("")) && setorInicial.equals(setorFinal)){				query.setInteger("setorComercialCod", Integer.parseInt(setorInicial));			}			else if(setorInicial !=null && setorFinal !=null && !setorInicial.trim().equals("") && !setorFinal.trim().equals("")){				query.setInteger("setorComercialInicial", Integer.parseInt(setorInicial));				query.setInteger("setorComercialFinal", Integer.parseInt(setorFinal));			}						if(quadraIni !=null && quadraFin !=null && !quadraIni.trim().equals("") && !quadraFin.trim().equals("")){				query.setInteger("quadraInicial", Integer.parseInt(quadraIni));				query.setInteger("quadraFinal", Integer.parseInt(quadraFin));			}			retorno = query.list();			return retorno;								} catch(HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		}		finally {			HibernateUtil.closeSession(session);		}	}		/**	 * Método que verifica a existência do arquivo	 * texto para aquele comando, localidade,	 * setor comercial inicial, setor comercial final	 * quadra inicial e quadra final	 * 	 * 	 * [UC 1220] Gerar Arquivo Texto para as Os de Visita	 * [FS 0005] Geração do Arquivo Texto	 * @author Raimundo Martins	 * @date 22/09/2011	 * 	 * @return true se tiver o arquivo, false senão	 */	public Boolean verificarExistenciaArquivoTextoVisitaCampo(String comOrdemSeletiva, String local, String setorInicial, 			String setorFinal, String quadraIni, String quadraFin) throws ErroRepositorioException{				Session session = HibernateUtil.getSession();		Collection<Object[]> retorno = null;		String hql = " SELECT txvc.coss_id                 AS comando, " +				"  txvc.loca_id                      AS localidade, " +				"  txvc.txvc_cdsetorcomercialinicial AS setorInicial, " +				"  txvc.txvc_cdsetorcomercialfinal   AS setorFinal, " +				"  txvc.txvc_nnquqdrainicial         AS quadraInicial, " +				"  txvc.txvc_nnquqdrafinal           AS quadraFinal " +				"FROM ATENDIMENTOPUBLICO.arq_txt_visita_campo txvc " +				"INNER JOIN MICROMEDICAO.situacao_transm_leitura sitl " +				"ON sitl.sitl_id                       = txvc.sitl_id " +				"WHERE txvc.coss_id                    = :comandoId "+				"AND txvc.sitl_id                     != :situacaoLeitura";				/*"AND txvc.loca_id                      = :localidadeCod " +				"AND txvc.txvc_cdsetorcomercialinicial = :setorInicialCod " +				"AND txvc.txvc_cdsetorcomercialfinal   = :setorFinalCod " +				";*/				/*if(quadraIni !=null && quadraFin !=null && !quadraIni.trim().equals("") && !quadraFin.trim().equals("")){			hql +=" AND txvc.txvc_nnquqdrainicial         = :quadraInicialCod ";			hql +=" AND txvc.txvc_nnquqdrafinal           = :quadraFinalCod ";		}*/		try{			Query query = session.createSQLQuery(hql)										.addScalar("comando", Hibernate.INTEGER)					.addScalar("localidade", Hibernate.INTEGER)					.addScalar("setorInicial", Hibernate.INTEGER)					.addScalar("setorFinal", Hibernate.INTEGER)					.addScalar("quadraInicial", Hibernate.INTEGER)					.addScalar("quadraFinal", Hibernate.INTEGER);						query.setInteger("comandoId", Integer.parseInt(comOrdemSeletiva));			query.setInteger("situacaoLeitura", SituacaoTransmissaoLeitura.TRANSMITIDO);			/*query.setInteger("localidadeCod", Integer.parseInt(local));			query.setInteger("setorInicialCod", Integer.parseInt(setorInicial));			query.setInteger("setorFinalCod", Integer.parseInt(setorFinal));			*/					/*if(quadraIni !=null && quadraFin !=null && !quadraIni.trim().equals("") && !quadraFin.trim().equals("")){				query.setInteger("quadraInicialCod", Integer.parseInt(quadraIni));				query.setInteger("quadraFinalCod", Integer.parseInt(quadraFin));			}*/			retorno = query.list();						if(retorno !=null && !retorno.isEmpty()){				for(Object[] ob : retorno){					/*					 * Valores retornados da consulta ao banco					 * */					String localidade = ob[1].toString();					String setorIni = ob[2].toString();					String setorFin = ob[3].toString();					String qdrIni = null;					if(ob[4] !=null){						qdrIni = ob[4].toString();					}					String qdrFin = null;					if(ob[5] !=null){						qdrFin = ob[5].toString();					}										/*Verifica se os valores informados são iguais					 * aos valores consultados*/					if(localidade.equals(local) && 					   setorIni.equals(setorInicial) &&					   setorFin.equals(setorFinal) &&					   qdrIni.equals(quadraIni)){						return true;					}					/*Caso os setores sejam iguais, verifica					 * se as quadras informadas estão contidas					 * nas quadras consultadas					 * */					else if(localidade.equals(local) && 					   setorIni.equals(setorInicial) &&					   setorFin.equals(setorFinal)){						if(qdrIni !=null && qdrFin!=null && !qdrIni.trim().equals("") && !qdrFin.trim().equals("")){							if(quadraIni !=null && quadraFin!=null && !quadraIni.trim().equals("") && !quadraFin.trim().equals("")){								for(Integer i = Integer.parseInt(qdrIni); i <= Integer.parseInt(qdrFin); i++){									if(i.compareTo(Integer.parseInt(quadraIni)) >= 0											&& i.compareTo(Integer.parseInt(quadraFin)) <= 0){										return true;									}								}							}						}					}					/* Caso os setores sejam diferentes,					 * verifica se os setores informados					 * estão contidos nos setores					 * consultados					 * */					else{						if(localidade.equals(local)){							for(Integer i = Integer.parseInt(setorIni); i <= Integer.parseInt(setorFin); i++){								if(i.compareTo(Integer.parseInt(setorInicial)) >= 0 &&										i.compareTo(Integer.parseInt(setorFinal)) <=0){									return true;								}							}						}					}				}				return false;							}						return false;											} catch(HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		}		finally {			HibernateUtil.closeSession(session);		}			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 *  1. O sistema exibe as informações do arquivo texto;	 * 	 * @author Mariana Victor	 * @date 22/09/2011	 * 	 * @param Integer	 * 	 * @return Object[]	 * @throws ErroRepositorioException	 */	public Object[] pesquisarDadosArquivoTextoOSVisita(Integer idArquivoTexto) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Object[] retorno = null;				try{			String consulta = "SELECT "				+ "coss.coss_dscomando AS comando, " //0				+ "loca.loca_id AS idLocalidade, " //1				+ "loca.loca_nmlocalidade AS nomeLocalidade, " //2				+ "txvc.txvc_cdsetorcomercialinicial AS codigoSetorInicial, " //3				+ "txvc.txvc_cdsetorcomercialfinal AS codigoSetorFinal, " //4				+ "txvc.txvc_nnquqdrainicial AS codigoQuadraInicial, " //5				+ "txvc.txvc_nnquqdrafinal AS codigoQuadraFinal, " //6				+ "CASE WHEN (leit.func_id is not null) THEN "				+ "  func.func_nmfuncionario "				+ "ELSE "				+ "clie.clie_nmcliente "				+ "END AS agenteComercial " //7				+ "FROM atendimentopublico.arq_txt_visita_campo txvc "				+ "INNER JOIN atendimentopublico.comando_ordem_seletiva coss on coss.coss_id = txvc.coss_id "				+ "INNER JOIN cadastro.localidade loca ON txvc.loca_id = loca.loca_id "				+ "INNER JOIN micromedicao.leiturista leit ON leit.leit_id = txvc.leit_id "				+ "LEFT JOIN cadastro.funcionario func ON leit.func_id = func.func_id "				+ "LEFT JOIN cadastro.cliente clie ON leit.clie_id = clie.clie_id "				+ "WHERE txvc.txvc_id = :idArquivoTexto ";						retorno = (Object[]) sessao.createSQLQuery(consulta)				.addScalar("comando", Hibernate.STRING)				.addScalar("idLocalidade", Hibernate.INTEGER)				.addScalar("nomeLocalidade", Hibernate.STRING)				.addScalar("codigoSetorInicial", Hibernate.INTEGER)				.addScalar("codigoSetorFinal", Hibernate.INTEGER)				.addScalar("codigoQuadraInicial", Hibernate.INTEGER)				.addScalar("codigoQuadraFinal", Hibernate.INTEGER)				.addScalar("agenteComercial", Hibernate.STRING)				.setInteger("idArquivoTexto", idArquivoTexto)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 *  2.	O sistema deverá exibir a lista das ordens de serviço associadas ao arquivo texto 	 * 	 * @author Mariana Victor	 * @date 22/09/2011	 * 	 * @param Integer	 * 	 * @return Collection<Object[]>	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarDadosOrdensServicoArquivoTextoVisitaCampo(Integer idArquivoTexto) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;				try{			String consulta = "SELECT "				+ "atrv.orse_id AS idOrdemServico, " //0				+ "orse.imov_id AS idImovel, " //1				+ "orse.orse_cdsituacao AS situacaoOS, " //2				+ "atrv.atrv_tmrecebimento AS dataRecebimento, " //3				+ "atrv.atrv_icconferida AS indicadorConferida, " //4				+ "rota.ftgr_id AS grupoFaturamento, " //5				+ "last.last_dsligacaoaguasituacao AS ligAguaSituacao, " //6				+ "lest.lest_dsligacaoesgotosituacao AS ligEsgSituacao, " //7				+ "lesg.lesg_nnconsumominimoesgoto AS consumoFixoEsgoto, " //8				+ "imov.imov_tmultimaalteracao AS ultimaAlteracao " //9				+ "FROM atendimentopublico.arq_txt_ret_visita_campo atrv "				+ "INNER JOIN atendimentopublico.ordem_servico orse ON atrv.orse_id = orse.orse_id "				+ "INNER JOIN cadastro.imovel imov ON imov.imov_id = orse.imov_id "				+ "INNER JOIN cadastro.quadra qdra ON qdra.qdra_id = imov.qdra_id "				+ "INNER JOIN micromedicao.rota rota ON qdra.rota_id = rota.rota_id "				+ "LEFT JOIN atendimentopublico.ligacao_agua_situacao last ON last.last_id = imov.last_id "				+ "LEFT JOIN atendimentopublico.ligacao_esgoto_situacao lest ON lest.lest_id = imov.lest_id "				+ "LEFT JOIN atendimentopublico.ligacao_esgoto lesg ON lesg.lesg_id = orse.imov_id "				+ "WHERE atrv.txvc_id = :idArquivoTexto "				+ "ORDER BY atrv.orse_id ";						retorno = sessao.createSQLQuery(consulta)				.addScalar("idOrdemServico", Hibernate.INTEGER)				.addScalar("idImovel", Hibernate.INTEGER)				.addScalar("situacaoOS", Hibernate.SHORT)				.addScalar("dataRecebimento", Hibernate.TIMESTAMP)				.addScalar("indicadorConferida", Hibernate.INTEGER)				.addScalar("grupoFaturamento", Hibernate.INTEGER)				.addScalar("ligAguaSituacao", Hibernate.STRING)				.addScalar("ligEsgSituacao", Hibernate.STRING)				.addScalar("consumoFixoEsgoto", Hibernate.INTEGER)				.addScalar("ultimaAlteracao", Hibernate.TIMESTAMP)				.setInteger("idArquivoTexto", idArquivoTexto)				.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 *  Pesquisa o id do imóvel associado à ordem de serviço	 * 	 * @author Mariana Victor	 * @date 23/09/2011	 * 	 * @param Integer	 * 	 * @return Integer	 * @throws ErroRepositorioException	 */	public Integer pesquisarIdImovelAssociadoAOrdemVisitaCampo(Integer idOrdemServico) 		throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Integer retorno = null;				try{			String consulta = "SELECT "				+ "orse.imov_id AS idImovel " //1				+ "FROM atendimentopublico.ordem_servico orse "				+ "WHERE orse.orse_id = :idOrdemServico ";						retorno = (Integer) sessao.createSQLQuery(consulta)				.addScalar("idImovel", Hibernate.INTEGER)				.setInteger("idOrdemServico", idOrdemServico)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * SB0001 - Consultar/Atualizar Dados da Ordem de Serviço	 *  3. Anormalidade Registrada 	 *  4. Anormalidade Encontrada 	 *  5. Tipo de Pavimento de Calçada 	 *  6. Tipo de Pavimento de Rua 	 * 	 * @author Mariana Victor	 * @date 26/09/2011	 * 	 * @param Integer	 * 	 * @return Object[]	 * @throws ErroRepositorioException	 */	public Object[] pesquisarDadosAnormalidadePavimentoOSVisitaCampo(Integer idOrdemServico) 			throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Object[] retorno = null;				try{			String consulta = "SELECT "				+ "osvc.osvc_dsanormalidaderegistrada AS anormalidadeRegistrada, " //0				+ "ltan.ltan_dsleituraanormalidade AS anormalidadeEncontrada, " //1				+ "pcal.pcal_dspavimentocalcada AS pavimentoCalcada, " //2				+ "prua.prua_dspavimentorua AS pavimentoRua, " //3				+ "atrv.atrv_id AS idArqTxtRetVisiCampo, " //4				+ "atrv.atrv_icnenhuma AS indicadorAcoesRetornadas, " //5				+ "orse.orse_cdsituacao AS situacaoOS " //6				+ "FROM atendimentopublico.os_seletiva_visita_campo osvc "				+ "INNER JOIN atendimentopublico.arq_txt_ret_visita_campo atrv ON atrv.orse_id = osvc.orse_id "				+ "INNER JOIN atendimentopublico.ordem_servico orse ON atrv.orse_id = orse.orse_id "				+ "LEFT JOIN micromedicao.leitura_anormalidade ltan ON atrv.ltan_id = ltan.ltan_id "				+ "LEFT JOIN cadastro.pavimento_calcada pcal ON atrv.pcal_id = pcal.pcal_id "				+ "LEFT JOIN cadastro.pavimento_rua prua ON atrv.prua_id = prua.prua_id "				+ "WHERE osvc.orse_id = :idOrdemServico ";						retorno = (Object[]) sessao.createSQLQuery(consulta)				.addScalar("anormalidadeRegistrada", Hibernate.STRING)				.addScalar("anormalidadeEncontrada", Hibernate.STRING)				.addScalar("pavimentoCalcada", Hibernate.STRING)				.addScalar("pavimentoRua", Hibernate.STRING)				.addScalar("idArqTxtRetVisiCampo", Hibernate.INTEGER)				.addScalar("indicadorAcoesRetornadas", Hibernate.SHORT)				.addScalar("situacaoOS", Hibernate.SHORT)				.setInteger("idOrdemServico", idOrdemServico)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	} 		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * SB0001 - Consultar/Atualizar Dados da Ordem de Serviço	 *  7.1.1. O sistema deverá exibir todas as ações para correção das anormalidades encontradas 	 * 	 * @author Mariana Victor	 * @date 26/09/2011	 * 	 * @param Integer	 * 	 * @return Collection<Object[]>	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarAcoesParaCorrecaoAnormalidadesEncontradas(		Integer idArquivoTextoRetornoVisitaCampo) 			throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;				try{			String consulta = "SELECT "				+ "svtp.svtp_id AS idServicoTipo, "				+ "svtp.svtp_dsservicotipo AS servicoTipo "				+ "FROM atendimentopublico.arq_txt_ret_acao_viscam atra "				+ "INNER JOIN atendimentopublico.servico_tipo svtp ON svtp.svtp_id = atra.svtp_id "				+ "WHERE atra.atrv_id = :idArquivoTextoRetornoVisitaCampo ";						retorno = sessao.createSQLQuery(consulta)				.addScalar("idServicoTipo", Hibernate.INTEGER)				.addScalar("servicoTipo", Hibernate.STRING)				.setInteger("idArquivoTextoRetornoVisitaCampo",					idArquivoTextoRetornoVisitaCampo)				.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	} 		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * SB0001 - Consultar/Atualizar Dados da Ordem de Serviço	 * 8.2.	Para as ações selecionadas e com ordem de serviço gerada, o sistema deverá atualizar a tabela de retorno	 * 8.3.	Para as ações não selecionadas, o sistema deverá atualizar a tabela de retorno  	 * 	 * @author Mariana Victor	 * @date 26/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarArquivoTextoRetornoAcaoVisitaCampo(Integer idArquivoTexto, Integer idServicoTipo,			Short indicadorGerada) throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoAcaoVisitaCampo "				+ " set atra_icgerada = :indicadorGerada, atra_tmultimaalteracao = :ultimaAlteracao "				+ " where atrv_id = :idArquivoTexto and svtp_id = :idServicoTipo ";					session.createQuery(consulta)					.setTimestamp("ultimaAlteracao", new Date())					.setInteger("idArquivoTexto", idArquivoTexto)					.setInteger("idServicoTipo", idServicoTipo)					.setShort("indicadorGerada", indicadorGerada)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * SB0001 - Consultar/Atualizar Dados da Ordem de Serviço	 *  9. Caso o usuário não selecione ações da tabela e selecione a opção de atualizar a ordem de serviço de 	 *  visita em campo, o sistema deverá atualizar a ordem de serviço de visita de campo  como  conferida	 * 	 * @author Mariana Victor	 * @date 26/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarOSVisitaCampoConferida(Integer idOrdemServico) throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoVisitaCampo "				+ " set atrv_icconferida = :indicadorConferida, atrv_tmultimaalteracao = :ultimaAlteracao "				+ " where orse_id = :idOrdemServico ";					session.createQuery(consulta)					.setInteger("indicadorConferida", ConstantesSistema.SIM)					.setTimestamp("ultimaAlteracao", new Date())					.setInteger("idOrdemServico", idOrdemServico)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * @author Mariana Victor	 * @date 26/09/2011	 * 	 * @param Integer	 * 	 * @return Integer	 * @throws ErroRepositorioException	 */	public Integer pesquisarIdComandoOSVisita(Integer idArquivoTexto) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Integer retorno = null;				try{			String consulta = "SELECT "				+ "txvc.coss_id AS comando " //0				+ "FROM atendimentopublico.arq_txt_visita_campo txvc "				+ "  INNER JOIN atendimentopublico.arq_txt_ret_visita_campo atrv ON atrv.txvc_id = txvc.txvc_id "				+ "WHERE atrv.atrv_id = :idArquivoTexto ";						retorno = (Integer) sessao.createSQLQuery(consulta)				.addScalar("comando", Hibernate.INTEGER)				.setInteger("idArquivoTexto", idArquivoTexto)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * [UC1222] Atualizar Cliente a Partir do Dispositivo Móvel	 * 	 * 2. O sistema recupera os dados do cliente inicialmente enviados 	 *  para as equipes de campo para atendimento da ordem de serviço informada 	 * 	 * @author Mariana Victor	 * @data 27/09/2011	 */	public ClieOsSeletivaVisitaCampo pesquisarClieOsSeletivaVisitaCampo(			Integer idOrdemServico) 		throws ErroRepositorioException {				ClieOsSeletivaVisitaCampo retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		Object[] dadosClieOs = null;			try{				consulta = " SELECT covc.covc_id AS idClieOs, " //0				+ "    covc.covc_nmcliente AS nomeCliente, " //1				+ "    covc.covc_nncpf AS cpf, " //2				+ "    covc.covc_nncnpj AS cnpj, " //3				+ "    covc.covc_nmrg AS rg, " //4				+ "    covc.clie_id AS idCliente, " //5				+ "    covc.oerg_idrg AS orgaoExpedidorRg, " //6				+ "    covc.unfe_idrg AS unidadeFederacaoRg " //7				+ " FROM atendimentopublico.clie_os_visita_campo covc "				+ "    INNER JOIN atendimentopublico.os_seletiva_visita_campo osvc ON osvc.osvc_id = covc.osvc_id "				+ " WHERE osvc.orse_id = :idOrdemServico ";						dadosClieOs = (Object[]) session.createSQLQuery(consulta)				.addScalar("idClieOs", Hibernate.INTEGER) //0				.addScalar("nomeCliente", Hibernate.STRING) //1				.addScalar("cpf", Hibernate.STRING) //2				.addScalar("cnpj", Hibernate.STRING) //3				.addScalar("rg", Hibernate.STRING) //4				.addScalar("idCliente", Hibernate.INTEGER) //5				.addScalar("orgaoExpedidorRg", Hibernate.INTEGER) //6				.addScalar("unidadeFederacaoRg", Hibernate.INTEGER) //7				.setInteger("idOrdemServico", idOrdemServico)				.setMaxResults(1).uniqueResult();				if (dadosClieOs != null) {								retorno = new ClieOsSeletivaVisitaCampo();								if (dadosClieOs[0] != null) {					retorno.setId((Integer) dadosClieOs[0]);				}				if (dadosClieOs[1] != null) {					retorno.setNomeCliente((String) dadosClieOs[1]);				}				if (dadosClieOs[2] != null) {					retorno.setCpf((String) dadosClieOs[2]);				}				if (dadosClieOs[3] != null) {					retorno.setCnpj((String) dadosClieOs[3]);				}				if (dadosClieOs[4] != null) {					retorno.setRg((String) dadosClieOs[4]);				}				if (dadosClieOs[5] != null) {					Cliente cliente = new Cliente();					cliente.setId((Integer) dadosClieOs[5]);					retorno.setCliente(cliente);				}				if (dadosClieOs[6] != null) {					OrgaoExpedidorRg orgaoExpedidorRg = new OrgaoExpedidorRg();					orgaoExpedidorRg.setId((Integer) dadosClieOs[6]);					retorno.setOrgaoExpedidorRg(orgaoExpedidorRg);				}				if (dadosClieOs[7] != null) {					UnidadeFederacao unidadeFederacaoRg = new UnidadeFederacao();					unidadeFederacaoRg.setId((Integer) dadosClieOs[7]);					retorno.setUnidadeFederacaoRg(unidadeFederacaoRg);				}			}								} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					return retorno;			}		/**	 * [UC1222] Atualizar Cliente a Partir do Dispositivo Móvel	 * 	 * 3. O sistema recupera os dados de retorno da visita de campo transmitidos pelo dispositivo móvel	 *  para atualização do cliente associado ao imóvel da ordem de serviço informada 	 * 	 * @author Mariana Victor	 * @data 27/09/2011	 */	public ArquivoTextoRetornoClienteVisitaCampo pesquisarArquivoTextoRetornoClienteVisitaCampo(			Integer idOrdemServico) 		throws ErroRepositorioException {				ArquivoTextoRetornoClienteVisitaCampo retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		Object[] dadosArqTxtClie = null;			try{				consulta = " SELECT atcv.atcv_id AS idArqTxtClie, " //0				+ "    atcv.atcv_nmcliente AS nomeCliente, " //1				+ "    atcv.atcv_nncpf AS cpf, " //2				+ "    atcv.atcv_nncnpj AS cnpj, " //3				+ "    atcv.atcv_nnrg AS rg, " //4				+ "    atcv.oerg_idrg AS orgaoExpedidorRg, " //5				+ "    atcv.unfe_idrg AS unidadeFederacaoRg, " //6				+ "    atcv.atrv_id AS idArquivoTexto " //7				+ " FROM atendimentopublico.arq_txt_ret_clie_viscamp atcv "				+ "    INNER JOIN atendimentopublico.arq_txt_ret_visita_campo atrv ON atrv.atrv_id = atcv.atrv_id "				+ " WHERE atrv.orse_id = :idOrdemServico ";						dadosArqTxtClie = (Object[]) session.createSQLQuery(consulta)				.addScalar("idArqTxtClie", Hibernate.INTEGER) //0				.addScalar("nomeCliente", Hibernate.STRING) //1				.addScalar("cpf", Hibernate.STRING) //2				.addScalar("cnpj", Hibernate.STRING) //3				.addScalar("rg", Hibernate.STRING) //4				.addScalar("orgaoExpedidorRg", Hibernate.INTEGER) //5				.addScalar("unidadeFederacaoRg", Hibernate.INTEGER) //6				.addScalar("idArquivoTexto", Hibernate.INTEGER) //7				.setInteger("idOrdemServico", idOrdemServico)				.setMaxResults(1).uniqueResult();				if (dadosArqTxtClie != null) {								retorno = new ArquivoTextoRetornoClienteVisitaCampo();								if (dadosArqTxtClie[0] != null) {					retorno.setId((Integer) dadosArqTxtClie[0]);				}				if (dadosArqTxtClie[1] != null) {					retorno.setNomeCliente((String) dadosArqTxtClie[1]);				}				if (dadosArqTxtClie[2] != null) {					retorno.setCpf((String) dadosArqTxtClie[2]);				}				if (dadosArqTxtClie[3] != null) {					retorno.setCnpj((String) dadosArqTxtClie[3]);				}				if (dadosArqTxtClie[4] != null) {					retorno.setRg((String) dadosArqTxtClie[4]);				}				if (dadosArqTxtClie[5] != null) {					OrgaoExpedidorRg orgaoExpedidorRg = new OrgaoExpedidorRg();					orgaoExpedidorRg.setId((Integer) dadosArqTxtClie[5]);					retorno.setOrgaoExpedidorRg(orgaoExpedidorRg);				}				if (dadosArqTxtClie[6] != null) {					UnidadeFederacao unidadeFederacao = new UnidadeFederacao();					unidadeFederacao.setId((Integer) dadosArqTxtClie[6]);					retorno.setUnidadeFederacaoRg(unidadeFederacao);				}				if (dadosArqTxtClie[7] != null) {					ArquivoTextoRetornoVisitaCampo arquivoTextoRetornoVisitaCampo = new ArquivoTextoRetornoVisitaCampo();					arquivoTextoRetornoVisitaCampo.setId((Integer) dadosArqTxtClie[7]);					retorno.setArquivoTextoRetornoVisitaCampo(arquivoTextoRetornoVisitaCampo);				}							}								} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					return retorno;			}		/**	 * [UC1222] Atualizar Cliente a Partir do Dispositivo Móvel	 * 	 * [SB0002] - Inserir Novo Cliente 	 * 	 * @author Mariana Victor	 * @data 27/09/2011	 */	public ArquivoTextoRetornoClienteFoneVisitaCampo pesquisarArquivoTextoRetornoClienteFoneVisitaCampo(			Integer idArqTxtClie) 		throws ErroRepositorioException {				ArquivoTextoRetornoClienteFoneVisitaCampo retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		Object[] dadosClieOs = null;			try{				consulta = " SELECT atrf.atrf_id AS idArqFone, " //0				+ "    atrf.atrf_cdddd AS codigoDdd, " //1				+ "    atrf.atrf_nnfone AS numeroFone, " //2				+ "    atrf.atrf_nnfoneramal AS numeroRamal " //3				+ " FROM atendimentopublico.arq_txt_ret_fone_viscamp atrf "				+ " WHERE atrf.atcv_id = :idArqTxtClie ";						dadosClieOs = (Object[]) session.createSQLQuery(consulta)				.addScalar("idArqFone", Hibernate.INTEGER) //0				.addScalar("codigoDdd", Hibernate.STRING) //1				.addScalar("numeroFone", Hibernate.STRING) //2				.addScalar("numeroRamal", Hibernate.STRING) //3				.setInteger("idArqTxtClie", idArqTxtClie)				.setMaxResults(1).uniqueResult();				if (dadosClieOs != null) {								retorno = new ArquivoTextoRetornoClienteFoneVisitaCampo();								if (dadosClieOs[0] != null) {					retorno.setId((Integer) dadosClieOs[0]);				}				if (dadosClieOs[1] != null) {					retorno.setDddFone((String) dadosClieOs[1]);				}				if (dadosClieOs[2] != null) {					retorno.setNumeroFone((String) dadosClieOs[2]);				}				if (dadosClieOs[3] != null) {					retorno.setRamalFone((String) dadosClieOs[3]);				}							}								} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					return retorno;			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * [SB0006] - Atualizar Movimento do Cliente 	 *  1. O sistema atualiza a tabela de movimento do cliente transmitida do dispositivo móvel 	 *  	 * @author Mariana Victor	 * @date 28/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarMovimentoCliente(Integer idArquivoTexto, Short indicadorAtualizado, String descricaoMensagem) 			throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoClienteVisitaCampo "				+ " set atcv_icatualizado = :indicadorAtualizado, atcv_tmultimaalteracao = :ultimaAlteracao ";						if (descricaoMensagem != null 					&& !descricaoMensagem.trim().equals("")) {				consulta = consulta + ", atcv_dsmensatualizacao = :descricaoMensagem ";			}						consulta = consulta	+ " where atrv_id = :idArquivoTexto ";					Query query = session.createQuery(consulta)					.setInteger("indicadorAtualizado", indicadorAtualizado)					.setTimestamp("ultimaAlteracao", new Date());						if (descricaoMensagem != null 					&& !descricaoMensagem.trim().equals("")) {				query.setString("descricaoMensagem", descricaoMensagem);			}						query.setInteger("idArquivoTexto", idArquivoTexto)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * [SB0007] - Atualizar Movimento do Fone do Cliente 	 *  1. O sistema atualiza a tabela de movimento de fone do cliente transmitida do dispositivo móvel 	 *  	 * @author Mariana Victor	 * @date 28/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarMovimentoFoneCliente(Integer idArquivoTextoFoneCliente) 			throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.atendimentopublico.ordemservico.ArquivoTextoRetornoClienteFoneVisitaCampo "				+ " set atrf_icatualizado = :indicadorAtualizado, atrf_tmultimaalteracao = :ultimaAlteracao "				+ " where atrf_id = :idArquivoTextoFoneCliente ";					session.createQuery(consulta)					.setShort("indicadorAtualizado", ConstantesSistema.SIM)					.setTimestamp("ultimaAlteracao", new Date())					.setInteger("idArquivoTextoFoneCliente", idArquivoTextoFoneCliente)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}			/**	 * [UC1222] Atualizar Cliente a Partir do Dispositivo Móvel	 * 	 * @author Mariana Victor	 * @data 29/09/2011	 */	public ClieFoneSeletivaVisitaCampo pesquisarClieFoneSeletivaVisitaCampo(			Integer idClieOSVisitaCampo) 		throws ErroRepositorioException {				ClieFoneSeletivaVisitaCampo retorno = null;		Session session = HibernateUtil.getSession();		String consulta;		Object[] dadosClieOs = null;			try{				consulta = " SELECT cfvc.cfvc_id AS idClieFoneOs, " //0				+ "    cfvc.cfvc_cdddd AS dddFone, " //1				+ "    cfvc.cfvc_nnfone AS numeroFone, " //2				+ "    cfvc.cfvc_nnfoneramal AS ramalFone " //3				+ " FROM atendimentopublico.clie_fone_visita_camp cfvc "				+ " WHERE cfvc.covc_id = :idClieOSVisitaCampo ";						dadosClieOs = (Object[]) session.createSQLQuery(consulta)				.addScalar("idClieFoneOs", Hibernate.INTEGER) //0				.addScalar("dddFone", Hibernate.STRING) //1				.addScalar("numeroFone", Hibernate.STRING) //2				.addScalar("ramalFone", Hibernate.STRING) //3				.setInteger("idClieOSVisitaCampo", idClieOSVisitaCampo)				.setMaxResults(1).uniqueResult();				if (dadosClieOs != null) {								retorno = new ClieFoneSeletivaVisitaCampo();								if (dadosClieOs[0] != null) {					retorno.setId((Integer) dadosClieOs[0]);				}				if (dadosClieOs[1] != null) {					retorno.setDddFone((String) dadosClieOs[1]);				}				if (dadosClieOs[2] != null) {					retorno.setNumeroFone((String) dadosClieOs[2]);				}				if (dadosClieOs[3] != null) {					retorno.setRamalFone((String) dadosClieOs[3]);				}			}								} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					return retorno;			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * [SB0004] - Atualizar Dados do RG do Cliente Atual	 *  	 * @author Mariana Victor	 * @date 29/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarDadosRGCliente(Integer idCliente, String rg, 			Integer orgaoExpedidorRg, Integer unidadeFederacaoRg) 			throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.cadastro.cliente.Cliente "				+ " set clie_nnrg = :rg, oerg_id = :orgaoExpedidorRg, unfe_id = :unidadeFederacaoRg, clie_tmultimaalteracao = :ultimaAlteracao "				+ " where clie_id = :idCliente ";					session.createQuery(consulta)					.setTimestamp("ultimaAlteracao", new Date())					.setInteger("idCliente", idCliente)					.setString("rg", rg)					.setInteger("orgaoExpedidorRg", orgaoExpedidorRg)					.setInteger("unidadeFederacaoRg", unidadeFederacaoRg)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}			/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * [SB0005] - Atualizar Dados do Fone do Cliente Atual	 *  	 * @author Mariana Victor	 * @date 29/09/2011	 * 	 * @param	 * @return void	 */	public void atualizarDadosFoneCliente(Integer idClienteFone, String dddFone, 			String numeroFone, String ramalFone) 			throws ErroRepositorioException {				String consulta;		Session session = HibernateUtil.getSession();		try {			consulta = "update gcom.cadastro.cliente.ClienteFone "				+ " set cfon_cdddd = :dddFone, cfon_nnfone = :numeroFone, "				+ "   cfon_nnfoneramal = :ramalFone, cfon_tmultimaalteracao = :ultimaAlteracao "				+ " where cfon_id = :idClienteFone ";					session.createQuery(consulta)					.setTimestamp("ultimaAlteracao", new Date())					.setInteger("idClienteFone", idClienteFone)					.setString("dddFone", dddFone)					.setString("numeroFone", numeroFone)					.setString("ramalFone", ramalFone)					.executeUpdate();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}			}		/**	 * [UC1228] Consultar Ordens de Serviço do Arquivo Texto	 * 	 * @author Mariana Victor	 * @date 04/10/2011	 * 	 * @param Integer	 * 	 * @return Object[]	 * @throws ErroRepositorioException	 */	public Object[] pesquisarDadosOSVisitaCampo(Integer idOrdemServico) 			throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Object[] retorno = null;				try{			String consulta = "SELECT atrv.atrv_id AS idArqTexto, " //0					+ " osvc.imov_id AS idImovel, " //1					+ " atrv.atrv_icnenhuma AS indicadorAcoesRetornadas " //2					+ " FROM atendimentopublico.os_seletiva_visita_campo osvc "					+ " INNER JOIN atendimentopublico.arq_txt_ret_visita_campo atrv ON atrv.orse_id = osvc.orse_id "					+ " WHERE osvc.orse_id = :idOrdemServico ";						retorno = (Object[]) sessao.createSQLQuery(consulta)				.addScalar("idArqTexto", Hibernate.INTEGER)				.addScalar("idImovel", Hibernate.INTEGER)				.addScalar("indicadorAcoesRetornadas", Hibernate.SHORT)				.setInteger("idOrdemServico", idOrdemServico)				.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	} 		/**	 * [UC1254] Relatório Ordem de Serviço com valores de cobrança	 * 	 * @author Amélia Pessoa	 * @date 28/11/2010	 * 	 * @param FiltrarRelatorioDebitosCobrancaImovelHelper	 * @return Collection<RelatorioDebitosCobradosImovelBean>	 * @throws ErroRepositorioException	 */	public Collection filtrarRelatorioDebitosCobradosImovel(			FiltrarRelatorioDebitosCobrancaImovelHelper filtro)			throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		Collection retorno = null;		String consulta=null;		try {		consulta = 			"SELECT distinct deb.anoMesReferenciaDebito, debTip.descricao, deb.valorDebito, " +			"(select sum(debValorPrestacao.valorPrestacao)  " +			"from DebitoCobrado debValorPrestacao where debValorPrestacao.debitoACobrarGeral= deb.id "+ 			") as valorPrestacao, "+			"deb.anoMesReferenciaPrestacao ,"+			"(select max(dac.numeroPrestacaoDebito) from DebitoACobrar dac "+ 			"where dac.id = deb.id)  "+						"FROM DebitoCobrado dc " +			"inner join dc.debitoACobrarGeral dcg "+ 			"inner join dcg.debitoACobrar deb " +			"left join deb.ordemServico os "+			"left join os.servicoTipo "+ 			"left join deb.debitoTipo debTip "+ 			"where deb.imovel = :idImovel ";		 		  			if ((filtro.getDataInicial()!= null && !filtro.getDataInicial().equals("")) &&					(filtro.getDataFinal()!= null && !filtro.getDataFinal().equals(""))) {				consulta += "and deb.anoMesReferenciaDebito between :dataInicial and :dataFinal \n";			}			if (filtro.getTipoServico()!= null && !filtro.getTipoServico().equals("")) {				consulta += "and os.servicoTipo.id = :servicoTipo \n";			}						Query query = session.createQuery(consulta)				.setString("idImovel", filtro.getIdImovel());			if ((filtro.getDataInicial()!= null && !filtro.getDataInicial().equals("")) &&					(filtro.getDataFinal()!= null && !filtro.getDataFinal().equals(""))) {				query.setInteger("dataInicial", Util.formatarMesAnoComBarraParaAnoMes(filtro.getDataInicial()));				query.setInteger("dataFinal", Util.formatarMesAnoComBarraParaAnoMes(filtro.getDataFinal()));			}			if (filtro.getTipoServico()!= null && !filtro.getTipoServico().equals("")) {				query.setInteger("servicoTipo", Integer.parseInt(filtro.getTipoServico()));			}			retorno = query.list();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}		/**	 * [UC1254] Relatório Ordem de Serviço com valores de cobrança	 * 	 * @author Amélia Pessoa	 * @date 28/11/2010	 * 	 * @param FiltrarRelatorioTiposServicoHelper	 * @return Collection<RelatorioTiposServicoBean>	 * @throws ErroRepositorioException	 */	public Collection filtrarRelatorioTiposServico(			FiltrarRelatorioTiposServicoHelper filtro)			throws ErroRepositorioException {		Session session = HibernateUtil.getSession();		Collection retorno = null;		String consulta=null;		try {		consulta = 		"select distinct \n" + //0		"st.id as codigo, \n" + //1		"st.descricao as tipoServico, \n" + //2		"ip.descricao as perfilImovel, \n" + //3		"(cat.descricao || \n" + //4		"case when ( sc.descricao <> null ) \n" +		"then concat( ' / ',  sc.descricao) else '' end) as categoriaSubcategoria, \n" +		" hc.descricao as capacidade, \n" + //5		"scv.quantidadeEconomiasInicial as economiasInicial, \n" + //6		" scv.quantidadeEconomiasFinal as economiasFinal, \n" + //7		" scv.valor as valor \n" + //8		"from ServicoCobrancaValor as scv \n" +		" left join scv.servicoTipo as st \n" +		"left join scv.imovelPerfil as ip \n" +		"left join scv.subCategoria  sc \n" +		" left join scv.categoria as cat \n" +		" left join scv.hidrometroCapacidade as hc \n" +		" ORDER BY st.descricao, ip.descricao, \n" +		"(cat.descricao ||  case when ( sc.descricao <> null ) then concat \n" +		"( ' / ',  sc.descricao) else '' end ), \n" +		"hc.descricao";		retorno = session.createQuery(consulta)				.list();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}	/**	 * [UC1249] Filtro OS Encerradas por Acompanhamento de Serviço	 * [SB0010]  Pesquisar Fotos do RA	 * 	 * Método que vai retornar as fotos de um determinado	 * registro de atendimento passada no parâmetro.	 * 	 * @author Fernanda Almeida	 * @date 17/11/2011	 * 	 * @param Integer - ID do Registro Atendimento	 * 	 * @return Collection<Object[]> - Coleção das Fotos da OS	 * @throws ErroRepositorioException	 */	public Collection<Object[]> pesquisarFotosRA(Integer idRA) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		Collection<Object[]> retorno = null;		StringBuilder sb = new StringBuilder();				sb.append("SELECT ");		sb.append("osFoto.osft_id AS id, ");//0 - ID Ordem Serviço Foto		sb.append("osFoto.orse_id AS idOS, ");//1 - ID Ordem Serviço		//sb.append("osFoto.orse_id AS idRA, ");//1 - ID Ordem Serviço		sb.append("osFoto.osft_dsfoto AS descricaoFoto, ");//2 - Descrição Foto		sb.append("osFoto.osft_imfoto AS foto ");//3 - Foto		sb.append("FROM ");		sb.append("atendimentopublico.ordem_servico_foto osFoto ");		sb.append("INNER JOIN atendimentopublico.ordem_servico orse ON orse.orse_id = osFoto.orse_id ");		sb.append("INNER JOIN atendimentopublico.registro_atendimento rgat ON rgat.rgat_id = orse.rgat_id AND rgat.rgat_id = :idRA ");		sb.append("ORDER BY osFoto.fsos_id  ");				try{			Query query = sessao.createSQLQuery(sb.toString())			.addScalar("id", Hibernate.INTEGER)			.addScalar("idOS", Hibernate.INTEGER)			.addScalar("descricaoFoto", Hibernate.STRING)			.addScalar("foto", Hibernate.BINARY)			.setInteger("idRA", idRA);						retorno = query.list();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		return retorno;	}		/**	 * Verifica se o Registro de Atendimento pode cancelar débitos	 * 	 * @author Amélia Pessoa	 * @date 06/12/2011	 * @param idRegistroAtendimento	 * @return boolean	 * RM 5759	 */	public boolean verificarPermissaoRACancelamentoDebito(			int idRegistroAtendimento) throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();		int icCancelaDebitoACobrar = 2;		String consulta = "select distinct ste.indicadorPermiteCancelarDebito as ic \n"+		"from SolicitacaoTipoEspecificacao AS ste, RegistroAtendimento AS ra \n"+		"left join ste.solicitacaoTipo AS st \n"+ 		"where ra.id= :idRegistroAtendimento and ra.solicitacaoTipoEspecificacao = ste.id \n";		try{						icCancelaDebitoACobrar = ((Short) sessao.createQuery(consulta).setInteger(                    "idRegistroAtendimento",idRegistroAtendimento)                    .uniqueResult()).intValue();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}		if (icCancelaDebitoACobrar==1){			return true;		} else {			return false;		}	}		/**	 * RM1165 - Registrar em tabela os parâmetros que foram utilizados para calcular o valor do 	 *          débito a cobrar gerado decorrente da situação de fiscalização informada	 * UC0210 - Consultar débito a cobrar	 * Analista: Cláudio Lira	 * 	 * SB0001- Exibir Parâmetros de Cálculo	 * 	 * Pesquisar na tabela atendimentopublico.fiscaliz_param_calc_deb com dbac_id = dbac_id     * recebido	 * 	 * @autor Thúlio Araújo	 * @since 13/12/2011	 * 	 * @throws ErroRepositorioException	 */	public FiscalizarParametroCalculoDebito pesquisarParametroCalculoDebito(Integer idDebitoACobrar)			throws ErroRepositorioException {		Session sessao = HibernateUtil.getSession();				FiscalizarParametroCalculoDebito fiscalizarParametroCalculoDebito = null;				String consulta = "select fisc \n"+				"from FiscalizarParametroCalculoDebito fisc " +				"left join fetch fisc.categoria \n " +				"left join fetch fisc.subcategoria \n"+				"left join fetch fisc.ligacaoAguaSituacao \n"+				"where fisc.id = :idDebitoACobrar";				try{						fiscalizarParametroCalculoDebito = (FiscalizarParametroCalculoDebito) sessao.createQuery(consulta).setInteger(                    "idDebitoACobrar", idDebitoACobrar)                    .setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(sessao);		}				return fiscalizarParametroCalculoDebito;	}	/**	 * [UC0738] Gerar Certidão Negativa por Imóvel	 * 	 * [FS0005] - Verificar existência de certidão negativa de débito	 * 	 * @author Mariana Victor	 * @data 15/03/2012	 */	public boolean verificarExistenciaCertidaoNegativaDebito(Integer idImovel) throws ErroRepositorioException {				Integer retorno = null;		Session session = HibernateUtil.getSession();		String consulta;			try{				consulta = " SELECT count(*) AS quantidade "				+ " FROM cobranca.certidao_negativa_debito "				+ " WHERE imov_id = :idImovel "				+ " 	and cend_dtgeracao = :dataAtual ";			retorno = (Integer) session.createSQLQuery(consulta)				.addScalar("quantidade", Hibernate.INTEGER)				.setInteger("idImovel", idImovel)				.setDate("dataAtual", new Date())				.setMaxResults(1).uniqueResult();						if (retorno != null 					&& retorno.compareTo(new Integer(0)) > 0) {				return true;			}					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}					return false;			}		/**	 * Pesquisar Informações de Retorno	 * 	 * [UC 1370] Consultar Ações de Cobrança por Imóvel	 * 	 * @author Davi Menezes	 * @date 20/08/2012	 */	public Object[] pesquisarInformacoesRetornoAcoesCobranca(Integer idOs) throws ErroRepositorioException{		Object[] retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";				try{			consulta = 	"SELECT fzst.fzst_id AS idFiscalizacaoSituacao, " 					 +	"fzst.fzst_dsfiscalizacaosituacao AS descricaoFiscalizacaoSituacao "					 +	"FROM atendimentopublico.ordem_servico os "					 +	"INNER JOIN atendimentopublico.fiscalizacao_situacao fzst ON fzst.fzst_id = os.fzst_id "					 +	"WHERE os.amen_id is not null "					 +	"AND os.orse_id = :idOrdemServico ";						retorno = (Object []) session.createSQLQuery(consulta)											.addScalar("idFiscalizacaoSituacao", Hibernate.INTEGER)											.addScalar("descricaoFiscalizacaoSituacao", Hibernate.STRING)											.setInteger("idOrdemServico", idOs)											.uniqueResult();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}		/**	 * Pesquisar Tipo de Débito	 * 	 * [UC 1370] Consultar Ações de Cobrança por Imóvel	 * 	 * @author Davi Menezes	 * @date 20/08/2012	 */	public Collection pesquisarTipoDebito(Integer idFiscalizacaoSituacao) throws ErroRepositorioException {		Collection retorno = null;		Session session = HibernateUtil.getSession();		String consulta = "";				try{			consulta =  "SELECT dbtp.dbtp_id AS idTipoDebito, dbtp.dbtp_dsdebitotipo AS descricaoTipoDebito "					 +	"FROM faturamento.debito_tipo dbtp "					 +	"INNER JOIN atendimentopublico.fiscaliz_sit_serv_a_cob fssc ON fssc.dbtp_id = dbtp.dbtp_id "					 +	"WHERE fzst_id = :idFiscalizacaoSituacao ";						retorno = (Collection) session.createSQLQuery(consulta)											.addScalar("idTipoDebito", Hibernate.INTEGER)											.addScalar("descricaoTipoDebito", Hibernate.STRING)											.setInteger("idFiscalizacaoSituacao", idFiscalizacaoSituacao)											.list();					}catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}				return retorno;	}			/**     * Pesquisa os dados necessários para a geração do relatório     *      * [UC0864] Gerar Certidão Negativa por Cliente     *      * @return     *      * @throws ErroRepositorioException     */    public Collection<Object[]> pesquisarRelatorioCertidaoNegativaClienteSemImovel(Collection<Integer> idsClientes)            throws ErroRepositorioException {        Session session = HibernateUtil.getSession();        String consulta;        Collection<Object[]> retorno = null;        try {            consulta = " SELECT clie.clie_id as idClienteResponsavel, "            		   +" clie.clie_nncpf as cpf, "              		   +" clie.clie_nncnpj as cnpj, " 					   +" clieTipo.cltp_icpessoafisicajuridica as incicadorCpfCnpj, "					   +" clie.clie_nmcliente as nomeCliente "					   +" FROM cadastro.cliente clie " 					   +" INNER JOIN cadastro.cliente_tipo clieTipo  on clieTipo.cltp_id = clie.cltp_id " 					   +" WHERE clie.clie_id in (:idsClientes) ";            retorno = session.createSQLQuery(consulta)            			.addScalar( "idClienteResponsavel", Hibernate.INTEGER)            			.addScalar( "cpf", Hibernate.STRING)            			.addScalar( "cnpj", Hibernate.STRING)            			.addScalar( "incicadorCpfCnpj", Hibernate.SHORT)            			.addScalar( "nomeCliente", Hibernate.STRING)            			.setParameterList( "idsClientes", idsClientes).list();        } catch (HibernateException e) {            throw new ErroRepositorioException(e, "Erro no Hibernate");        } finally {            HibernateUtil.closeSession(session);        }        return retorno;    }	    /**	 * [UC1530] Inserir Registro de Atendimento Simplificado	 * 	 * [IT0008] Pesquisar Ocorrência Operacional	 * 	 * @author Mariana Victor	 * @date 15/07/2013	 * @throws ErroRepositorioException	 */    public Collection<Object[]> pesquisarOcorrenciaOperacional(    	OcorrenciaOperacionalFiltroHelper helperFiltro)			throws ErroRepositorioException {		Collection<Object[]> retorno = null;				Session session = HibernateUtil.getSession();		try {			String consulta = "SELECT ocop_id AS idOcorrencia, " 					+ "  ocop_dsocorrencia AS ocorrencia, "					+ "  ocop_tmocorrencia AS dataHora, "					+ "  ocop_dtprevisao AS previsao, "					+ "  ocop_cdperiodoprevisao AS codPeriodoPrev, "					+ "  ocop_dtreprogramacao AS reprogramacao, "					+ "  ocop_cdperiodoreprogramacao AS codPeriodoReprog, "					+ "  ocop_dsareasafetadas AS areasAfetadas "					+ "FROM atendimentopublico.ocorrencia_operacional ocop " 					+ "WHERE (OCOP_DTCONCLUSAO is null "					+ "    or (:dataAtual <= OCOP_DTCONCLUSAO + :quantidadeDias)) ";			if (helperFiltro.getIdMunicipio() != null) {				consulta += " and muni_id = :idMunicipio ";			}			if (helperFiltro.getIdLocalidade() != null) {				consulta += " and loca_id = :idLocalidade ";			}			if (helperFiltro.getIdBairro() != null) {				consulta += " and bair_id = :idBairro ";			}			if (helperFiltro.getIdTipoOcorrencia() != null) {				consulta += " and ootp_id = :idTipoOcorrencia ";			}						Query query = session.createSQLQuery(consulta)					.addScalar("idOcorrencia", Hibernate.INTEGER)					.addScalar("ocorrencia", Hibernate.STRING)					.addScalar("dataHora", Hibernate.TIMESTAMP)					.addScalar("previsao", Hibernate.DATE)					.addScalar("codPeriodoPrev", Hibernate.SHORT)					.addScalar("reprogramacao", Hibernate.DATE)					.addScalar("codPeriodoReprog", Hibernate.SHORT)					.addScalar("areasAfetadas", Hibernate.STRING)					.setDate("dataAtual", new Date())					.setInteger("quantidadeDias", helperFiltro.getQuantidadeDias());						if (helperFiltro.getIdMunicipio() != null) {				query.setInteger("idMunicipio", helperFiltro.getIdMunicipio());			}			if (helperFiltro.getIdLocalidade() != null) {				query.setInteger("idLocalidade", helperFiltro.getIdLocalidade());			}			if (helperFiltro.getIdBairro() != null) {				query.setInteger("idBairro", helperFiltro.getIdBairro());			}			if (helperFiltro.getIdTipoOcorrencia() != null) {				query.setInteger("idTipoOcorrencia", helperFiltro.getIdTipoOcorrencia());			}								retorno = (Collection<Object[]>) query.list();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}	    /**	 * [UC1530] Inserir Registro de Atendimento Simplificado	 * 	 * [IT0010] Inserir Registro Atendimento Simplificado Operacional	 * 	 * @author Mariana Victor	 * @date 15/07/2013	 * @throws ErroRepositorioException	 */    public Object[] pesquisarDadosOcorrenciaOperacional(Integer idOcorrenciaOperacional)			throws ErroRepositorioException {		Object[] retorno = null;				Session session = HibernateUtil.getSession();		try {			String consulta = "SELECT ocop_dsobservacao AS observacao, " 					+ "  bair_id AS bairro, "					+ "  loca_id AS localidade, "					+ "  ocop_dsocorrencia AS descricao "					+ "FROM atendimentopublico.ocorrencia_operacional ocop " 					+ "WHERE ocop_id = :idOcorrenciaOperacional ";			retorno = (Object[]) session.createSQLQuery(consulta)					.addScalar("observacao", Hibernate.STRING)					.addScalar("bairro", Hibernate.INTEGER)					.addScalar("localidade", Hibernate.INTEGER)					.addScalar("descricao", Hibernate.STRING)					.setInteger("idOcorrenciaOperacional", idOcorrenciaOperacional)					.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}            /**     * [UC1275] Gerar Relatório Quantidade de Acessos Loja Virtual     *      * Metodo responsavel por pesquisar quantidades de acessos feitos no      * portal por um certo intervalo de tempo.     *      * @author Flávio Ferreira     * @since 27/09/2013     *      */    public Integer pesquisarQuantidadeAcessoLojaVirtual(Date periodoInicial, Date periodoFinal, String tipoAtendimento)     			throws ErroRepositorioException {    		    		// cria uma sessao com Hibernate    		Session sessao = HibernateUtil.getSession();    		    		// cria a variavel que vai armazenar o cliente  responsavel      		Integer quantidade = null;    		String consulta = null;    		    		try{    			    		// Monta HQL    		consulta = " SELECT COUNT (distinct(aclj.numeroCodigoAtendimento)) qtd FROM atendimentopublico.acesso_loja_virtual  WHERE"    				+ " aclj.ultimaAlteracao >= :periodoInicial AND "    				+ " aclj.ultimaAlteracao <= :periodoFinal AND";    		    		if(periodoInicial == null || periodoInicial.equals("")){    			periodoInicial = Util.criarData(1, 1, 2013);    		}    		    		if(periodoFinal == null ||  periodoFinal.equals("")){    			periodoFinal = new Date();    		}    		    		if(tipoAtendimento != null && !tipoAtendimento.equals("-1")){    			consulta = consulta + " aclj.numeroCodigoAtendimento =  '" + tipoAtendimento +  "' AND ";    		}    		    		consulta = consulta.substring(0, consulta.length() -4);    		    		// Executa o HQL    		quantidade = (Integer) sessao.createSQLQuery(consulta)    				.addScalar("qtd", Hibernate.INTEGER)    				.setTimestamp("periodoFinal", Util.formatarDataInicial(periodoInicial))    				.setTimestamp("periodoFinal", Util.formatarDataFinal(periodoFinal))    				.uniqueResult();    		    			// Erro do Hibernate    		}catch(HibernateException ex){    			// levanta a exceção para proxima camada     			throw new ErroRepositorioException(ex, "Erro no Hibernate");    			    		}finally{    			    			// fecha a sessao    			HibernateUtil.closeSession(sessao);    		}    		    		return quantidade;    }    	    	    	    	/**    	 * [UC1275] Gerar Relatório Quantidade de Acessos Loja Virtual    	 *     	 * Metodo responsavel por pesquisar quantidade de acessos realizados no    	 * portal por um intervalo de tempo.    	 *     	 * @author Flávio Ferreira    	 * @date 27/09/2013    	 *     	 * @throws ErroRepositorioException    	 */    	    	public Integer pesquisarQuantidadeAcessoLojaVirtualTipoAtendimento(    			Date periodoInicial, Date periodoFinal, String tipoAtendimento,String indicadorServicoExecutado)    			throws ErroRepositorioException {    		// Cria uma sessão com ohibernate    		Session session = HibernateUtil.getSession();    		// Cria a variável que vai armazenar o cliente responsável    		Integer quantidade = null;    		String consulta = null;    		try {    			// Monta o SQL    			consulta = " SELECT COUNT(aclj_nncodigoatendimento) qtd FROM atendimentopublico.acesso_loja_virtual aclj WHERE"    					+ " aclj_tmultimaalteracao >= :periodoInicial  AND "    					+ " aclj_tmultimaalteracao <= :periodoFinal ";    			    			if (periodoInicial == null || periodoInicial.equals("")) {    				periodoInicial = Util.criarData(1, 1, 2011);    			}    			if (periodoFinal == null || periodoFinal.equals("")) {    				periodoFinal = new Date();    			}    			if (tipoAtendimento != null && !tipoAtendimento.equals("-1")) {    				consulta = consulta + " AND aclj_nncodigoatendimento =  '"+ tipoAtendimento + "' ";    			}    			    			if (indicadorServicoExecutado != null && !indicadorServicoExecutado.equals("3")) {    				consulta = consulta + " AND aclj_icservicoexecutado =  " + indicadorServicoExecutado;    			}    			// Executa o HQL    			quantidade = (Integer) session.    				createSQLQuery(consulta).    				addScalar("qtd", Hibernate.INTEGER).    				setTimestamp("periodoInicial",Util.formatarDataInicial(periodoInicial)).    				setTimestamp("periodoFinal",Util.formatarDataFinal(periodoFinal)).    				uniqueResult();    			// Erro no hibernate    		} catch (HibernateException e) {    			// Levanta a exceção para a próxima camada    			throw new ErroRepositorioException(e, "Erro no Hibernate");    		} finally {    			// Fecha a sessão    			HibernateUtil.closeSession(session);    		}    		return quantidade;    	}    	    	    	/**    	 * [UC1275] Gerar Relatório Quantidade de Acessos Loja Virtual    	 *     	 * @author Flávio Ferreira    	 * @date 27/09/2013    	 *     	 * @throws ErroRepositorioException    	 */        	public Collection<Object[]> pesquisarAcessoLojaVirtual(Date periodoInicial, Date periodoFinal, String tipoAtendimento, String indicadorServicoExecutado)    			throws ErroRepositorioException {    		    		// cria a sessao    		Session sessao = HibernateUtil.getSession();    		    		// cria a variaval    		Collection<Object[]> colecaoAcessoVirtual = null;    		    		String consulta = null;    		    		try{    			    			// Monta o HQL    			consulta = "SELECT aclj.numeroCodigoAtendimento AS codigo, "    					+ "COUNT(aclj.id) AS quantidade, "    					+ "SUM (CASE aclj.indicadorServicoExecutado WHEN 1 THEN 1 ELSE 0 END) AS quantidadeExecutadas "    					+ "FROM AcessoLojaVirtual aclj "    					+ "WHERE aclj.ultimaAlteracao >= :periodoInicial AND "    					+ "aclj.ultimaAlteracao <= :periodoFinal ";    			    			    			    			if(periodoInicial == null || periodoFinal.equals("")){    				periodoInicial = Util.criarData(1, 1, 2013);    			}    			    			if(periodoFinal == null || periodoFinal.equals("")){    				periodoFinal = new Date();    			}    			    			if(tipoAtendimento != null && !tipoAtendimento.equals("-1")){    				consulta = consulta + " AND aclj.numeroCodigoAtendimento = " + tipoAtendimento;    			}    			    			if(indicadorServicoExecutado != null && !indicadorServicoExecutado.equals("3")){    				consulta = consulta + " AND aclj.indicadorServicoExecutado = " + indicadorServicoExecutado;    			}    			    			consulta = consulta + " GROUP by aclj.numeroCodigoAtendimento ";    			consulta = consulta + " ORDER by count (aclj.id) DESC ";    			    			// Execulta o HQL    			colecaoAcessoVirtual = (Collection<Object[]>) sessao.createQuery(consulta)    					.setTimestamp("periodoInicial", Util.formatarDataInicial(periodoInicial))    					.setTimestamp("periodoFinal",Util.formatarDataFinal(periodoFinal))    					.list();     			    			    			// Erro Hibernate    		}catch(HibernateException ex){    			// Levanta Execeção para proxima camada    			throw new ErroRepositorioException(ex, "Erro Hibernate");    		}finally{    			//  fecha a sessao    			HibernateUtil.closeSession(sessao);    		}    		    		return colecaoAcessoVirtual;    	}    	    	/**    	 * [UC1275] Gerar Relatório Quantidade de Acessos Loja Virtual    	 *     	 * @author Flávio Ferreira    	 * @date 30/09/2013    	 *     	 * @throws ErroRepositorioException    	 */    	    	public Collection<Object[]> pesquisarAcessoLojaVirtualTipoAtendimento(    		Date periodoInicial, Date periodoFinal, String tipoAtendimento,     		String indicadorServicoExecutdo, int numeroPagina) throws ErroRepositorioException {    		    		// cria a sessao    		Session sessao = HibernateUtil.getSession();    		    		// cira a variaval      		Collection<Object[]> colecaoLojaVirtual = null;    		    		String consulta = null;    		    		try{    			// Monta o HQL    			consulta = " SELECT aclj.ultimaAlteracao, aclj.ipAcesso, aclj.indicadorServicoExecutado FROM AcessoLojaVirtual aclj WHERE "    					+ " aclj.ultimaAlteracao >= :periodoInicial AND "    					+ " aclj.ultimaAlteracao <= :periodoFinal ";    		    		if(periodoInicial == null || periodoInicial.equals("")){    			periodoInicial = Util.criarData(1, 1, 2013);    		}    		    		if(periodoFinal == null || periodoFinal.equals("")){    			periodoFinal = new Date();    		}    		    		if(tipoAtendimento != null && !tipoAtendimento.equals("-1")){    			consulta = consulta + " AND aclj.numeroCodigoAtendimento = '" + tipoAtendimento + "' ";    		}    		    		if(indicadorServicoExecutdo != null && !indicadorServicoExecutdo.equals("3")){    			consulta = consulta + " AND aclj.indicadorServicoExecutado = '" + indicadorServicoExecutdo + "' ";    		}    		    		consulta = consulta + " ORDER by  aclj.ultimaAlteracao";    		    		// Executa 0 HQL    		colecaoLojaVirtual = (Collection<Object[]>) sessao.createQuery(consulta).    				setTimestamp("periodoInicial", Util.formatarDataInicial(periodoInicial)).    				setTimestamp("periodoFinal", Util.formatarDataFinal(periodoFinal)).    				setFirstResult(10 * numeroPagina).setMaxResults(10).list();    		    		// Erro Hibernate    	}catch(HibernateException ex){    		throw new ErroRepositorioException(ex, "Erro no Hibernate");    	}finally{    		// fecha  a sessao    		HibernateUtil.closeSession(sessao);    	}    		return colecaoLojaVirtual;    }    	    	    		 /**	 * [UC0738] Gerar Certidão Negativa por Imóvel	 * 	 * @author Hugo Azevedo	 * @date 02/05/2014	 * @throws ErroRepositorioException	 */    public Object[] obterQtdSituacoesCobrancaBloqueadas(Integer idImovel)			throws ErroRepositorioException {    	Object[] retorno = null;				Session session = HibernateUtil.getSession();		try {			String consulta = 					" select cs.cbst_dscobrancasituacao as sit, coalesce(count(*),0) as qtd "+	    			" from cadastro.imovel_cobranca_situacao ics"+	    			" inner join cobranca.cobranca_situacao cs on cs.cbst_id = ics.cbst_id"+	    			" where ics.iscb_dtretiradacobranca is null"+	    			" and cs.cbst_icbloqueiacertnegatdebito = 1 "+	    			" and ics.imov_id = :idImovel " +	    			" group by cs.cbst_dscobrancasituacao";			retorno = (Object[]) session.createSQLQuery(consulta)					.addScalar("sit", Hibernate.STRING)					.addScalar("qtd", Hibernate.INTEGER)					.setInteger("idImovel", idImovel)					.setMaxResults(1).uniqueResult();					} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}		return retorno;	}        /**     * Método responsável por<br>     * pesquisar contrato de adesão<br>     * associado munícipio através do     * do imovél      * @author Jonathan Marcos     * @since 15/01/2014     * @param idImovel     * @return Integer     * @throws ErroRepositorioException     */    public Integer pesquisarContratoAdesaoMunicipioAssociadoImovel(Integer idImovel)    		throws ErroRepositorioException {    	Integer idContratoAdesao = null;    	Session session = HibernateUtil.getSession();    	try {			String scriptSQL = "SELECT muni.coad_id AS idContratoAdesao"+ 							   "	FROM cadastro.imovel imovel"+							   "	INNER JOIN cadastro.setor_comercial sc ON imovel.stcm_id=sc.stcm_id"+							   "	INNER JOIN cadastro.municipio muni ON sc.muni_id = muni.muni_id"+							   " WHERE imov_id = :idImovel";			idContratoAdesao = (Integer)session.createSQLQuery(scriptSQL)								.addScalar("idContratoAdesao", Hibernate.INTEGER)								.setInteger("idImovel", idImovel)								.uniqueResult();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}    	return idContratoAdesao;    }    	/**	 * [UC1669] Atualizar Dados nas Tabelas Resumos Grenciais Faturamento	 * @author Fábio Aguiar	 * @date 04/02/2015	 * 	 * @throws ErroRepositorioException	 * @throws SQLException	 */	public void gerarResumoAtendimentoPublicoAtualizaDados() throws ErroRepositorioException, SQLException {		Session session = HibernateUtil.getSessionGerencial();		Connection con = null;		String sql = "";		try {			con = session.connection();			sql = " SELECT atendimentopublico.sp_un_atendimentopublico_atualiza_dados() ";			PreparedStatement pstm = con.prepareStatement(sql);			pstm.executeQuery();		} catch (HibernateException e) {			throw new ErroRepositorioException(	e,												"Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}	}		/**	 * [UC0412] Manter Tipo de Serviço	 * @author João Pedro Medeiros	 * @date 15/12/2015	 * 	 * @throws ErroRepositorioException	 * @throws SQLException	 */	public Integer pesquisarConstanteFuncionalidadeTipoServico(Integer servicoTipoId)    		throws ErroRepositorioException {    	Integer constanteFuncionalidadeTipoServico = null;    	Session session = HibernateUtil.getSession();    	try {			String scriptSQL = "SELECT svtp_nncodigoconstante AS constanteFuncionalidadeTipoServico"+ 							   "	FROM atendimentopublico.servico_tipo st"+							   " WHERE st.svtp_id = :servicoTipoId";			constanteFuncionalidadeTipoServico = (Integer)session.createSQLQuery(scriptSQL)								.addScalar("constanteFuncionalidadeTipoServico", Hibernate.INTEGER)								.setInteger("servicoTipoId", servicoTipoId)								.uniqueResult();		} catch (HibernateException e) {			throw new ErroRepositorioException(e, "Erro no Hibernate");		} finally {			HibernateUtil.closeSession(session);		}    	return constanteFuncionalidadeTipoServico;    }    	}